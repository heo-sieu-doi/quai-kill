<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω SƒÉn Qu√°i FvN</title>
    <!-- Th√™m v√†o ph·∫ßn head -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* --- Bi·∫øn v√† Thi·∫øt l·∫≠p C∆° b·∫£n --- */
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            /* M√†u cho n√∫t export ·∫£nh */
            --secondary-color: #95a5a6;
            /* M√†u cho n√∫t toggle */
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --text-color: #34495e;
            --bg-color: #f4f7f9;
            /* N·ªÅn h∆°i x√°m nh·∫π */
            --white-color: #ffffff;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --box-shadow-light: 0 2px 5px rgba(0, 0, 0, 0.08);
            --box-shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.2s;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            /* X√≥a margin m·∫∑c ƒë·ªãnh */
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Container Ch√≠nh --- */
        .main-container {
            max-width: 1400px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
            margin: 20px auto;
            /* CƒÉn gi·ªØa v√† t·∫°o kho·∫£ng c√°ch tr√™n/d∆∞·ªõi */
            padding: 0 20px;
            /* Padding hai b√™n */
        }

        /* --- Header --- */
        .header {
            background-color: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-light);
            display: flex;
            flex-wrap: wrap;
            /* Cho ph√©p wrap tr√™n m√†n h√¨nh nh·ªè */
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            max-width: 1400px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông */
            margin-left: auto;
            /* CƒÉn gi·ªØa */
            margin-right: auto;
            /* CƒÉn gi·ªØa */
        }

        /* === TH√äM M·ªöI: Style cho √¥ th·ªëng k√™ header === */
        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #eef2f5;
            /* M√†u n·ªÅn h∆°i kh√°c m·ªôt ch√∫t */
            padding: 8px 18px;
            border-radius: var(--border-radius-md);
            text-align: center;
            border: 1px solid var(--light-gray);
            margin-left: 20px;
            /* Th√™m kho·∫£ng c√°ch v·ªõi ti√™u ƒë·ªÅ */
        }

        .stat-label {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 600;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.1;
        }

        /* === TH√äM M·ªöI: Style cho chi ti·∫øt ƒëi·ªÉm sƒÉn === */
        .hunt-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
            justify-content: center;
            margin-top: 5px;
            font-size: 11px;
            color: var(--dark-gray);
        }
        .hunt-breakdown span {
            background-color: #e0e6eb;
            padding: 1px 6px;
            border-radius: var(--border-radius-sm);
            white-space: nowrap;
        }

        .title-wrapper h1 {
            font-size: 1.8em;
            /* Gi·∫£m nh·∫π k√≠ch th∆∞·ªõc */
            color: var(--primary-color);
            text-shadow: none;
            margin: 0;
            /* X√≥a margin m·∫∑c ƒë·ªãnh c·ªßa h1 */
            white-space: nowrap;
            /* NgƒÉn kh√¥ng cho ti√™u ƒë·ªÅ xu·ªëng d√≤ng */
        }

        .input-actions-group {
            display: flex;
            flex-wrap: wrap;
            /* Cho ph√©p wrap */
            gap: 15px;
            align-items: center;
            /* CƒÉn gi·ªØa c√°c item */
            flex-grow: 1;
            /* Cho ph√©p nh√≥m n√†y m·ªü r·ªông */
            justify-content: flex-end;
            /* ƒê·∫©y v·ªÅ b√™n ph·∫£i */
            align-items: flex-start;
            /* C√≥ th·ªÉ c·∫ßn ƒëi·ªÅu ch·ªânh alignment */
        }

        .input-group {
            display: flex;
            gap: 10px;
            min-width: 250px;
            /* ƒê·∫£m b·∫£o ƒë·ªß r·ªông */
            flex-grow: 1;
            /* Cho ph√©p input URL m·ªü r·ªông */
            max-width: 400px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
        }

        .url-input {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius-md);
            font-size: 14px;
            transition: border-color var(--transition-speed);
        }

        .url-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .file-upload-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        /* --- N√∫t B·∫•m Chung --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            display: inline-flex;
            /* ƒê·ªÉ cƒÉn ch·ªânh icon n·∫øu c√≥ */
            align-items: center;
            justify-content: center;
            line-height: 1.5;
            /* ƒê·∫£m b·∫£o chi·ªÅu cao nh·∫•t qu√°n */
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0px);
            box-shadow: none;
        }

        /* N√∫t Ch√≠nh (T·∫£i URL, X·ª≠ l√Ω TXT, T·∫°o Bi·ªÉu ƒë·ªì) */
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            /* M√†u t·ªëi h∆°n ch√∫t */
        }

        /* N√∫t Th√†nh C√¥ng (Xu·∫•t Excel) */
        .btn-success {
            background-color: var(--success-color);
            color: var(--white-color);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* N√∫t Export ·∫¢nh */
        .btn-export {
            background-color: var(--info-color);
            color: var(--white-color);
        }

        .btn-export:hover {
            background-color: #8e44ad;
        }

        /* N√∫t Toggle (·∫®n/Hi·ªán) */
        .btn-toggle {
            background-color: var(--secondary-color);
            color: var(--white-color);
        }

        .btn-toggle:hover {
            background-color: #7f8c8d;
        }

        /* --- File Upload Labels (Gi·ªØ nguy√™n style ƒë·∫πp s·∫µn c√≥) --- */
        .upload-label {
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
            /* Gi·∫£m padding ch√∫t */
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            /* ƒê·ªìng b·ªô font size */
        }

        /* ... (gi·ªØ nguy√™n style .excel-label, .txt-label v√† ::before) ... */
        .excel-label {
            background: #217346;
            color: white;
            border: 1px solid #1a5f38;
        }

        .excel-label:hover {
            background: #1a5f38;
            transform: translateY(-1px);
        }

        .excel-label::before {
            content: "üìä";
            margin-right: 8px;
            font-size: 16px;
        }

        .txt-label {
            background: #e67e22;
            color: white;
            border: 1px solid #d35400;
        }

        .txt-label:hover {
            background: #d35400;
            transform: translateY(-1px);
        }

        .txt-label::before {
            content: "üìÑ";
            margin-right: 8px;
            font-size: 16px;
        }

        .file-name {
            margin-left: 10px;
            font-size: 13px;
            /* Nh·ªè h∆°n ch√∫t */
            color: var(--dark-gray);
            font-style: italic;
        }

        input[type="file"] {
            /* ·∫®n input g·ªëc */
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* --- Toolbar v√† Tabs --- */
        .toolbar {
            margin: 25px 0;
            display: flex;
            flex-wrap: wrap;
            /* Cho ph√©p wrap */
            gap: 10px;
            align-items: center;
        }

        /* === TH√äM M·ªöI: C·ª•m c√†i ƒë·∫∑t nh·ªè g·ªçn === */
        .settings-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
            /* NgƒÉn kh√¥ng cho co l·∫°i */
        }

        .input-group-compact {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-group-compact label {
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .input-group-compact .url-input {
            width: 60px;
            padding: 8px;
            font-size: 14px;
            height: auto;
            line-height: 1.2;
        }

        .btn-icon {
            padding: 8px 12px !important;
            font-size: 16px;
            line-height: 1;
            min-width: auto;
        }

        /* === TH√äM M·ªöI: Style cho n√∫t X√≥a === */
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white-color);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* === TH√äM M·ªöI: C·ª•m h√†nh ƒë·ªông v√† dropdown === */
        .actions-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--white-color);
            min-width: 180px;
            box-shadow: var(--box-shadow-medium);
            z-index: 10;
            border-radius: var(--border-radius-md);
            padding: 8px;
            border: 1px solid var(--light-gray);
            right: 0;
            margin-top: 5px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content label {
            font-weight: 500;
            color: var(--text-color);
            padding: 8px 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-speed);
        }

        .dropdown-content label:hover {
            background-color: var(--light-gray);
        }

        .dropdown-content input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .dropdown-content hr {
            border: none;
            border-top: 1px solid var(--light-gray);
            margin: 6px 0;
        }

        /* === TH√äM M·ªöI: Style cho √¥ t√¨m ki·∫øm === */
        .search-group {
            flex-grow: 1;
            /* Cho ph√©p √¥ t√¨m ki·∫øm co gi√£n */
            min-width: 200px;
            /* ƒê·ªô r·ªông t·ªëi thi·ªÉu */
        }

        #searchInput {
            width: 56%;
            /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa .search-group */
            box-sizing: border-box;
            /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m tr√†n */
        }

        /* === K·∫æT TH√öC TH√äM M·ªöI === */

        .tab {
            display: flex;
            gap: 5px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 5px;
            box-shadow: var(--box-shadow-light);
            margin-left: auto;
            /* ƒê·∫©y tab sang ph·∫£i */
        }

        .tab button {
            /* Style cho n√∫t trong tab */
            padding: 8px 18px;
            /* Gi·∫£m padding */
            background: none;
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            /* Bo g√≥c √≠t h∆°n */
            font-weight: 500;
            /* Gi·∫£m ƒë·ªô ƒë·∫≠m */
            box-shadow: none;
            /* B·ªè shadow m·∫∑c ƒë·ªãnh c·ªßa .btn */
        }

        .tab button:hover {
            background-color: var(--light-gray);
            transform: none;
            /* B·ªè hi·ªáu ·ª©ng transform */
            box-shadow: none;
        }

        .tab button.active {
            background: var(--primary-color);
            /* D√πng m√†u primary */
            color: var(--white-color);
            font-weight: 600;
            /* ƒê·∫≠m h∆°n khi active */
        }

        /* --- Tab Content --- */
        .tab-content {
            margin-top: 20px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 20px;
            box-shadow: var(--box-shadow-medium);
            /* Th√™m transition ƒë·ªÉ ·∫©n hi·ªán m∆∞·ª£t h∆°n (n·∫øu mu·ªën) */
            /* transition: opacity 0.3s ease, visibility 0.3s ease; */
        }

        .tab-content-hidden {
            display: none;
            /* Class ƒë·ªÉ ·∫©n tab */
            /* opacity: 0; */
            /* visibility: hidden; */
        }

        /* --- B·∫£ng D·ªØ li·ªáu --- */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--light-gray);
            /* Th√™m vi·ªÅn nh·∫π */
            border-radius: var(--border-radius-md);
            margin-bottom: 1rem;
        }

        .table-responsive>table {
            border-collapse: collapse;
            /* ƒê·∫£m b·∫£o border collapse */
            margin-top: 0;
            /* X√≥a margin top m·∫∑c ƒë·ªãnh */
            table-layout: auto;
        }

        th,
        td {
            padding: 12px 10px; /* ƒêi·ªÅu ch·ªânh padding */
            text-align: center;
            border-bottom: 1px solid var(--light-gray);
            white-space: nowrap; /* M·∫∑c ƒë·ªãnh kh√¥ng xu·ªëng d√≤ng */
            overflow: hidden; /* ·∫®n n·ªôi dung tr√†n */
            text-overflow: ellipsis; /* Hi·ªÉn th·ªã '...' cho n·ªôi dung b·ªã c·∫Øt */
        }

        /* === TH√äM M·ªöI: Style cho c·ªôt STT === */
        .stt-column {
            width: 50px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh */
            padding-left: 8px;
            padding-right: 8px;
        }

        /* === TH√äM M·ªöI: Style cho c·ªôt checkbox === */
        .checkbox-column {
            width: 45px;
            padding: 0 !important; /* Ghi ƒë√® padding m·∫∑c ƒë·ªãnh c·ªßa cell */
        }

        /* === TH√äM M·ªöI: Style cho c·ªôt v√† n√∫t Ghim === */
        .pin-column {
            width: 50px;
            padding: 0 !important;
        }

        .btn-pin {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4em;
            padding: 0;
            opacity: 0.25;
            transition: all 0.2s ease-in-out;
        }

        .btn-pin:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .btn-pin.pinned {
            opacity: 1;
            color: #f39c12; /* Gold color */
        }

        /* === TH√äM M·ªöI: T·ªëi ∆∞u ƒë·ªô r·ªông c√°c c·ªôt kh√°c === */
        .id-column { width: 90px; }
        .name-column {
            text-align: left; /* CƒÉn tr√°i cho d·ªÖ ƒë·ªçc */
            /* white-space: normal; B·ªè xu·ªëng d√≤ng theo y√™u c·∫ßu m·ªõi */
            /* word-break: break-word; */
        }
        .level-column { width: 50px; }
        .quai-tuan-column { width: 90px; }
        .points-column { width: 100px; }
        .status-column { width: 80px; }
        .bu-column { width: 80px; }
        .kcx-column { width: 140px; }
        .debt-status-col { width: 120px; }
        .required-column { width: 90px; }

        th {
            background: #e9edf0;
            /* M√†u n·ªÅn header nh·∫°t h∆°n */
            color: var(--text-color);
            /* M√†u ch·ªØ t·ªëi h∆°n */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom-width: 2px;
            /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi header ƒë·∫≠m h∆°n */
            border-bottom-color: var(--medium-gray);
        }

        tbody tr:nth-child(even) {
            background-color: #f9fafb;
            /* Zebra striping */
        }

        /* === TH√äM M·ªöI: Style cho d√≤ng ƒë∆∞·ª£c ghim === */
        tr.pinned-row {
            background-color: #fffbe6 !important; /* Light yellow, !important to override zebra striping */
        }

        tr.pinned-row:hover {
            background-color: #fff6cf !important; /* Slightly darker yellow on hover */
        }

        tbody tr:hover {
            background-color: #f0f4f8;
            /* Hi·ªáu ·ª©ng hover */
        }

        /* === TH√äM M·ªöI: Style cho d√≤ng t·ªïng k·∫øt === */
        .table-summary-row td {
            font-weight: bold;
            background-color: #e9edf0;
            /* Gi·ªëng m√†u header */
            border-top: 2px solid var(--medium-gray);
            color: var(--text-color);
        }

        /* Input trong b·∫£ng */
        .target-input {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 14px;
            transition: border-color var(--transition-speed);
        }

        .target-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Footer c·ªßa b·∫£ng (n√∫t c·∫≠p nh·∫≠t) */
        .table-footer {
            margin-top: 15px;
            text-align: left;
        }

        .table-footer button {
            /* Style ri√™ng cho n√∫t n√†y */
            background: var(--warning-color);
            color: var(--white-color);
            padding: 8px 15px;
            font-size: 14px;
        }

        .table-footer button:hover {
            background: #e67e22;
            /* M√†u t·ªëi h∆°n */
        }

        /* Style c·ªôt cu·ªëi (Thi·∫øu/D∆∞/B√π) */
        td:nth-last-child(1),
        td:nth-last-child(2) {
            font-weight: 600;
            color: var(--danger-color);
        }


        /* ·∫®n c·ªôt cu·ªëi tab Sufficient */
        #sufficientContent .table-responsive>table td:nth-last-child(1),
        #sufficientContent .table-responsive>table th:nth-last-child(1) {
            display: none;
        }

        /* Style cho tab Corrected */
        #correctedContent .table-responsive>table {
            border: 1px dashed var(--primary-color);
            /* ƒê·ªïi th√†nh dashed */
        }

        #correctedContent .table-responsive>table td {
            color: var(--dark-gray);
            font-style: italic;
        }

        #correctedContent .table-responsive>table td:nth-last-child(1),
        #correctedContent .table-responsive>table td:nth-last-child(2) {
            font-weight: bold;
            color: var(--danger-color);
            font-style: normal;
            /* B·ªè italic cho c·ªôt n√†y */
        }

        #correctedContent .table-responsive>table th:nth-last-child(1),
        #correctedContent .table-responsive>table th:nth-last-child(2) {
            background-color: var(--warning-color);
            color: var(--white-color);
        }

        /* --- Bi·ªÉu ƒë·ªì --- */
        .chart-section {
            /* Thay th·∫ø style inline */
            margin-top: 30px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            box-shadow: var(--box-shadow-medium);
            border: 1px solid var(--light-gray);
            /* Th√™m vi·ªÅn nh·∫π */
        }

        .chart-section h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 35px;
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 600;
        }

        .chart-grid {
            /* Thay th·∫ø div flex inline */
            display: grid;
            /* D√πng grid cho linh ho·∫°t */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh c·ªôt */
            gap: 40px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c bi·ªÉu ƒë·ªì */
            margin-bottom: 25px;
            /* Kho·∫£ng c√°ch tr∆∞·ªõc n√∫t c·∫≠p nh·∫≠t */
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
        }

        .chart-wrapper {
            background-color: #fdfdfd;
            padding: 20px;
            /* TƒÉng padding b√™n trong wrapper */
            border-radius: var(--border-radius-md);
            /* Bo g√≥c nhi·ªÅu h∆°n ch√∫t */
            border: 1px solid #eef2f5;
            /* Vi·ªÅn tinh t·∫ø h∆°n */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            /* Th√™m shadow nh·∫π */
            /* ƒê·∫£m b·∫£o chi·ªÅu cao ƒë·ªß cho bi·ªÉu ƒë·ªì Top 3 v·ªõi nh√£n d√†i */
            min-height: 250px;
            /* ƒêi·ªÅu ch·ªânh n·∫øu c·∫ßn */
            display: flex;
            /* Gi√∫p canvas cƒÉn gi·ªØa n·∫øu c·∫ßn */
            flex-direction: column;
            /* S·∫Øp x·∫øp ti√™u ƒë·ªÅ v√† canvas */

        }

        /* CƒÉn ch·ªânh canvas b√™n trong wrapper (n·∫øu c·∫ßn) */
        .chart-wrapper canvas {
            max-width: 100%;
            /* ƒê·∫£m b·∫£o kh√¥ng tr√†n */
            /* C√≥ th·ªÉ kh√¥ng c·∫ßn set height ·ªü ƒë√¢y n·∫øu maintainAspectRatio: false */
        }

        /* N√∫t c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì */
        .chart-section .btn-primary {
            display: block;
            /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
            width: fit-content;
            /* Ch·ªâ r·ªông b·∫±ng n·ªôi dung */
            margin: 20px auto 0;
            /* CƒÉn gi·ªØa v√† th√™m kho·∫£ng c√°ch tr√™n */
            padding: 12px 25px;
            /* TƒÉng padding cho n√∫t */
        }

        /* --- Logic ·∫®n/Hi·ªán C·ªôt --- */
        body.hide-id-column th.id-column,
        body.hide-id-column td.id-column {
            display: none;
        }

        body.hide-quaituan th.quai-tuan-column,
        body.hide-quaituan td.quai-tuan-column {
            display: none;
        }

        body.hide-bu-column .bu-column {
            /* Th√™m class ƒë·ªÉ ·∫©n c·ªôt B√π */
            display: none;
        }

        .countdown-group {
            min-width: 280px;
            /* ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông n·∫øu c·∫ßn */
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
        }

        .time-input-group label {
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
            text-align: center;
        }

        .time-input-group input::-webkit-outer-spin-button,
        .time-input-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .time-input-group input[type=number] {
            -moz-appearance: textfield;
            /* Firefox */
        }

        #countdownDisplay {
            /* C√≥ th·ªÉ th√™m padding, font-size, etc. */
            font-size: 1.1em;
            min-height: 1.5em;
            /* ƒê·∫£m b·∫£o c√≥ kh√¥ng gian ngay c·∫£ khi tr·ªëng */
        }

        /* --- Responsive --- */

        /* M√†n h√¨nh nh·ªè h∆°n (Tablet d·ªçc & ƒêi·ªán tho·∫°i l·ªõn) */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 15px;
                /* Gi·∫£m padding */
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                /* C√°c item chi·∫øm ƒë·ªß chi·ªÅu r·ªông */
                padding: 15px;
            }

            .title-wrapper {
                text-align: center;
                /* CƒÉn gi·ªØa ti√™u ƒë·ªÅ */
            }

            .header-stat {
                margin-left: 0;
                margin-top: 15px;
            }

            /* === TH√äM M·ªöI: T·ªëi ∆∞u dropdown v√† actions tr√™n mobile === */
            .actions-group {
                flex-direction: column;
                width: 100%;
                align-items: stretch; /* ƒê·∫£m b·∫£o c√°c item con c≈©ng gi√£n ra */
            }

            .dropdown {
                width: 100%; /* ƒê·∫£m b·∫£o dropdown container chi·∫øm ƒë·ªß r·ªông */
            }

            .dropdown-content {
                position: static; /* B·ªè position absolute, hi·ªÉn th·ªã nh∆∞ block b√¨nh th∆∞·ªùng */
                box-shadow: none; /* B·ªè shadow */
                border: none;
                border-top: 1px solid var(--light-gray); /* Th√™m ƒë∆∞·ªùng k·∫ª tr√™n ƒë·ªÉ ph√¢n c√°ch */
                width: 100%;
                margin-top: 8px; /* Th√™m kho·∫£ng c√°ch v·ªõi n√∫t cha */
                background-color: #fdfdfd; /* N·ªÅn s√°ng h∆°n ch√∫t ƒë·ªÉ ph√¢n bi·ªát */
                border-radius: 0; /* B·ªè bo g√≥c tr√™n mobile */
            }

            .input-actions-group {
                justify-content: center;
                /* CƒÉn gi·ªØa c√°c control */
            }

            .input-group {
                max-width: none;
                /* Cho ph√©p input URL r·ªông h∆°n */
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
                /* N√∫t chi·∫øm ƒë·ªß r·ªông */
                gap: 10px;
            }

            /* === TH√äM M·ªöI: Responsive cho √¥ t√¨m ki·∫øm === */
            .search-group {
                order: -1;
                /* ƒê∆∞a √¥ t√¨m ki·∫øm l√™n ƒë·∫ßu */
                width: 100%;
                margin-right: 0;
                margin-bottom: 5px;
                /* Th√™m kho·∫£ng c√°ch d∆∞·ªõi */
            }

            /* === K·∫æT TH√öC TH√äM M·ªöI === */
            .tab {
                margin-left: 0;
                /* B·ªè margin khi x·∫øp d·ªçc */
                width: 100%;
                justify-content: center;
                /* CƒÉn gi·ªØa c√°c n√∫t tab */
            }

            .tab button {
                flex-grow: 1;
                /* C√°c n√∫t tab chia ƒë·ªÅu kh√¥ng gian */
                text-align: center;
            }

            .btn {
                /* ƒê·∫£m b·∫£o c√°c n√∫t toolbar chi·∫øm ƒë·ªß r·ªông */
                width: 100%;
                box-sizing: border-box;
            }

            .download-btn {
                margin-top: 5px;
                /* Th√™m kho·∫£ng c√°ch nh·ªè */
            }

            .chart-grid {
                /* Grid t·ª± ƒë·ªông x·∫øp th√†nh 1 c·ªôt v√¨ minmax(250px, 1fr) */
                gap: 20px;
                /* Gi·∫£m gap */
            }

            .chart-section {
                padding: 20px;
                /* Gi·∫£m padding */
            }

            .countdown-group {
                width: 100%;
                /* Chi·∫øm ƒë·ªß r·ªông tr√™n mobile */
                max-width: none;
            }

            #countdownDisplay {
                text-align: center;
                /* CƒÉn gi·ªØa tr√™n mobile */
                margin-top: 15px;
            }
        }

        /* M√†n h√¨nh ƒëi·ªán tho·∫°i nh·ªè */
        @media (max-width: 480px) {
            .main-container {
                padding: 0 10px;
            }

            .header h1 {
                font-size: 1.6em;
                /* Gi·∫£m n·ªØa */
            }

            .btn {
                padding: 10px 15px;
                /* Gi·∫£m padding n√∫t */
                font-size: 13px;
            }

            .tab button {
                padding: 8px 10px;
            }

            th,
            td {
                padding: 8px 10px;
                /* Gi·∫£m padding cell */
                font-size: 13px;
                /* Gi·∫£m font ch·ªØ b·∫£ng */
            }

            .target-input {
                width: 55px;
                /* Gi·∫£m n·ªØa */
                font-size: 13px;
            }

            .chart-section h2 {
                font-size: 1.4em;
            }
        }

        /* --- Debt Checker Section --- */
        .debt-checker-section {
            margin-top: 30px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            box-shadow: var(--box-shadow-medium);
            border: 1px solid var(--light-gray);
        }

        .debt-checker-section h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 600;
        }

        .debt-checker-section .description {
            text-align: center;
            max-width: 700px;
            margin: 0 auto 25px auto;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .debt-checker-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .debt-checker-controls textarea {
            width: 100%;
            max-width: 600px;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius-md);
            font-family: Consolas, 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .debt-checker-controls textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #debtCheckResults {
            max-width: 800px;
            margin: 0 auto;
        }

        .debt-result-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-gray);
            gap: 15px;
        }

        .debt-result-item:last-child {
            border-bottom: none;
        }

        .debt-result-info {
            flex-grow: 1;
        }

        .debt-result-info .name {
            font-weight: 600;
        }

        .debt-result-info .id {
            font-size: 12px;
            color: var(--dark-gray);
            margin-left: 5px;
        }

        .debt-result-status {
            font-weight: 700;
            white-space: nowrap;
        }

        .debt-status-in-debt {
            color: var(--danger-color);
        }

        .debt-status-sufficient {
            color: var(--success-color);
        }

        .debt-status-no-debt {
            color: var(--dark-gray);
        }

        .debt-status-not-found {
            color: var(--warning-color);
        }

        /* === TH√äM M·ªöI: Hell Event Calculator Section === */
        .hell-event-calculator-section {
            margin-top: 30px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            box-shadow: var(--box-shadow-medium);
            border: 1px solid var(--light-gray);
        }

        .hell-event-calculator-section h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 600;
        }

        .hell-event-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .hell-event-controls select,
        .hell-event-controls input[type="number"] {
            padding: 10px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius-md);
            font-size: 14px;
            min-width: 200px;
        }

        .hell-event-controls select:focus,
        .hell-event-controls input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #hellResults {
            max-width: 600px;
            margin: 0 auto;
            background-color: #f9fafb;
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--light-gray);
        }

        #hellResults h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        #hellResults ul {
            list-style-type: '‚úî ';
            padding-left: 20px;
        }

        /* === TH√äM M·ªöI: T√πy ch·ªçn Hell L√≠nh === */
        #troopOptions,
        #pactOptions,
        #pactSpeedOptions,
        #troopExtraOptions {
            display: none;
            /* ·∫®n m·∫∑c ƒë·ªãnh */
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            font-size: 14px;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        #troopExtraOptions select,
        #troopExtraOptions input {
            min-width: 120px;
            flex-grow: 0 !important;
            /* NgƒÉn kh√¥ng cho co gi√£n qu√° l·ªõn */
        }

        /* === TH√äM M·ªöI: Energy Calculator Section === */
        .energy-calculator-section {
            margin-top: 30px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            box-shadow: var(--box-shadow-medium);
            border: 1px solid var(--light-gray);
        }

        .energy-calculator-section h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 600;
        }

        .energy-grid {
            display: flex;
            /* Chuy·ªÉn sang flexbox */
            flex-wrap: wrap;
            /* Cho ph√©p c√°c item xu·ªëng d√≤ng */
            justify-content: center;
            /* CƒÉn gi·ªØa c√°c item */
            gap: 10px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c "vi√™n thu·ªëc" */
            margin-bottom: 25px;
        }

        .energy-input-group {
            display: inline-flex;
            /* Hi·ªÉn th·ªã nh∆∞ m·ªôt kh·ªëi inline */
            align-items: center;
            border: 1px solid var(--medium-gray);
            border-radius: 20px;
            /* Bo tr√≤n ƒë·ªÉ t·∫°o h√¨nh vi√™n thu·ªëc */
            padding: 5px 10px;
            background-color: var(--white-color);
            transition: border-color var(--transition-speed);
        }

        .energy-input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .energy-input-group label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
            margin-right: 5px;
            white-space: nowrap;
        }

        .energy-input-group input[type="number"] {
            width: 40px;
            /* ƒê·ªô r·ªông r·∫•t nh·ªè */
            border: none;
            background: transparent;
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
            padding: 2px;
            -moz-animation: textfield;
            /* ·∫®n m≈©i t√™n tƒÉng/gi·∫£m tr√™n Firefox */
        }

        .energy-input-group input[type="number"]:focus {
            outline: none;
        }

        #energyResults {
            margin-top: 20px;
            background-color: #f9fafb;
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--light-gray);
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* === TH√äM M·ªöI: Purchase Leaderboard Section === */
        .purchase-leaderboard-section {
            margin-top: 30px;
            background: var(--white-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            box-shadow: var(--box-shadow-medium);
            border: 1px solid var(--light-gray);
        }

        .purchase-leaderboard-section h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 600;
        }

        .anonymous-box-item {
            background-color: #fdf0e6;
            border: 1px solid #e67e22;
            padding: 15px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            text-align: center;
        }

        .anonymous-box-item .name {
            font-weight: bold;
            font-size: 1.2em;
            color: #d35400;
        }

        .purchase-details {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px 20px; /* Kho·∫£ng c√°ch gi·ªØa c√°c item */
            margin-top: 10px;
            font-size: 14px;
        }
        .purchase-details span {
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
        }
    </style>
</head>

<body>

    <!-- Header gi·ªØ nguy√™n -->
    <div class="header">
        <div class="title-wrapper">
            <h1>üèπ Qu·∫£n L√Ω SƒÉn Qu√°i FvN</h1>
        </div>
        <!-- === TH√äM M·ªöI: Hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm === -->
        <div class="header-stat">
            <span class="stat-label">T·ªïng ƒêi·ªÉm SƒÉn</span>
            <span id="totalPointsDisplay" class="stat-value">0</span>
            <div id="totalHuntBreakdown" class="hunt-breakdown"></div>
        </div>
        <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->
        <div class="input-actions-group">
            <div class="input-group">
                <input type="text" id="excelUrl" placeholder="D√°n link Google Sheets ho·∫∑c URL Excel..."
                    class="url-input">
                <!-- Th√™m class 'btn' v√† 'btn-primary' -->
                <button class="btn btn-primary" onclick="loadExcelFromUrl()">T·∫£i t·ª´ URL</button>
            </div>
            <div class="file-upload-controls">
                <div class="file-upload-group">
                    <label class="upload-label excel-label" for="excelFile">
                        Ch·ªçn file Excel
                        <span class="file-name" id="excelFileName"></span>
                    </label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls"
                        onchange="document.getElementById('excelFileName').textContent = this.files[0]?.name || ''">
                </div>
                <div class="file-upload-group">
                    <label class="upload-label txt-label" for="txtFile">
                        Ch·ªçn file TXT
                        <span class="file-name" id="txtFileName"></span>
                    </label>
                    <input type="file" id="txtFile" accept=".txt"
                        onchange="document.getElementById('txtFileName').textContent = this.files[0]?.name || ''">
                </div>
                <!-- Th√™m class 'btn' v√† 'btn-primary' -->
                <button class="btn btn-primary process-txt-btn" onclick="processTxtFile()">X·ª≠ l√Ω TXT</button>
            </div>
            <!-- === TH√äM M·ªöI: Input ƒê·∫øm Ng∆∞·ª£c === -->
            <div class="input-group countdown-group" style="flex-wrap: wrap; align-items: flex-end; gap: 10px;">
                <div class="time-input-group">
                    <label for="daysInput">Ng√†y</label>
                    <input type="number" id="daysInput" placeholder="0" min="0" max="99" class="url-input"
                        style="width: 50px; text-align: center; padding: 10px 5px;">
                </div>
                <div class="time-input-group">
                    <label for="hoursInput">Gi·ªù</label>
                    <input type="number" id="hoursInput" placeholder="0" min="0" max="23" class="url-input"
                        style="width: 50px; text-align: center; padding: 10px 5px;">
                </div>
                <div class="time-input-group">
                    <label for="minutesInput">Ph√∫t</label>
                    <input type="number" id="minutesInput" placeholder="0" min="0" max="59" class="url-input"
                        style="width: 50px; text-align: center; padding: 10px 5px;">
                </div>
                <div class="time-input-group">
                    <label for="secondsInput">Gi√¢y</label>
                    <input type="number" id="secondsInput" placeholder="0" min="0" max="59" class="url-input"
                        style="width: 50px; text-align: center; padding: 10px 5px;">
                </div>
                <button class="btn btn-info" onclick="calculateTimeBase()">T√≠nh Ng∆∞·ª£c</button>
            </div>
            <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->
            <!-- === TH√äM M·ªöI: Hi·ªÉn th·ªã ƒê·∫øm Ng∆∞·ª£c === -->
            <div id="countdownDisplay"
                style="margin-top: 10px; font-weight: bold; color: var(--danger-color); text-align: right; width: 100%;">
                <!-- Th·ªùi gian ƒë·∫øm ng∆∞·ª£c s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
            <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->
        </div>
    </div>

    <!-- B·ªçc n·ªôi dung ch√≠nh -->
    <div class="main-container">
        <div class="toolbar">
            <!-- === TH√äM M·ªöI: √î T√åM KI·∫æM === -->
            <div class="search-group">
                <input type="text" id="searchInput" placeholder="üîç T√¨m theo T√™n ho·∫∑c ID..." class="url-input"
                    oninput="filterCurrentTable()">
            </div>
            <!-- === TH√äM M·ªöI: C·ª•m c√†i ƒë·∫∑t nh·ªè g·ªçn === -->
            <div class="settings-group">
                <div class="input-group-compact">
                    <label for="globalTargetInput">M·ª•c ti√™u:</label>
                    <input type="number" id="globalTargetInput" value="63" class="url-input">
                    <button class="btn btn-primary btn-icon" onclick="applyGlobalTarget()" title="√Åp d·ª•ng m·ª•c ti√™u">‚úì</button>
                </div>
                <div class="input-group-compact">
                    <label for="compensationValueInput">B√π:</label>
                    <input type="number" id="compensationValueInput" value="5" class="url-input">
                </div>
            </div>
            <!-- === TH√äM M·ªöI: C·ª•m h√†nh ƒë·ªông v√† t√πy ch·ªçn hi·ªÉn th·ªã === -->
            <div class="actions-group">
                <div class="dropdown">
                    <button class="btn btn-toggle" onclick="toggleDropdown(event)">‚öôÔ∏è Hi·ªÉn th·ªã</button>
                    <div id="displayOptionsDropdown" class="dropdown-content">
                        <label><input type="checkbox" id="toggleIdCheckbox" onchange="toggleIdColumn()"> Hi·ªán ID</label>
                        <label><input type="checkbox" id="toggleQuaiTuanCheckbox" onchange="toggleQuaiTuan()"> Hi·ªán Qu√°i Tu·∫ßn</label>
                        <label><input type="checkbox" id="toggleBuCheckbox" onchange="toggleBuColumn()"> Hi·ªán B√π</label>
                        <hr>
                        <label><input type="checkbox" id="toggleBookmarkCheckbox" onchange="handleBookmarkToggle(this)"> L∆∞u tr·∫°ng th√°i</label>
                    </div>
                </div>
                <button class="btn btn-export export-image-btn" onclick="exportToImage()">üì∏ Xu·∫•t ·∫¢nh</button>
            </div>
            <div class="tab">
                <!-- Th√™m class 'btn' cho c√°c n√∫t tab -->
                <button class="btn active" onclick="showTab('missing')">Thi·∫øu (<span
                        id="missingCount">0</span>)</button>
                <button class="btn" onclick="showTab('sufficient')">ƒê·ªß/D∆∞ (<span id="sufficientCount">0</span>)</button>
                <button class="btn" onclick="showTab('corrected')">ƒê√£ s·ª≠a (<span id="correctedCount">0</span>)</button>
            </div>
            <!-- N√∫t Xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS, c·∫ßn ƒë·∫£m b·∫£o n√≥ c≈©ng c√≥ class 'btn btn-success' -->
        </div>

        <!-- X√≥a style="display: none;" -->
        <div id="missing" class="tab-content">
            <div id="missingContent"></div>
        </div>
        <div id="sufficient" class="tab-content tab-content-hidden">
            <div id="sufficientContent"></div>
        </div>
        <div id="corrected" class="tab-content tab-content-hidden">
            <div id="correctedContent"></div>
        </div>

        <!-- X√≥a style inline, th√™m class 'chart-section' -->
        <div class="chart-section">
            <h2>üìä Th·ªëng K√™ Nhanh</h2>
            <!-- Th√™m class 'chart-grid' -->
            <div class="chart-grid">
                <!-- X√≥a style inline, th√™m class 'chart-wrapper' -->
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
                <!-- === TH√äM M·ªöI: Wrapper cho bi·ªÉu ƒë·ªì ph√¢n lo·∫°i qu√°i === -->
                <div class="chart-wrapper">
                    <canvas id="monsterDistributionChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="topPlayersChart"></canvas>
                </div>
            </div>
            <!-- Th√™m class 'btn' v√† 'btn-primary' -->
            <button class="btn btn-primary" onclick="renderCharts()" style="margin-top: 15px;">T·∫°o/C·∫≠p nh·∫≠t Bi·ªÉu
                ƒê·ªì</button>
        </div>

        <!-- === TH√äM M·ªöI: Ph·∫ßn Ki·ªÉm Tra N·ª£ Qu√°i === -->
        <div class="debt-checker-section">
            <h2>üìù Ki·ªÉm Tra N·ª£ Qu√°i Tu·∫ßn Ti·∫øp Theo</h2>
            <p class="description">
                D√°n danh s√°ch ID v√†o √¥ b√™n d∆∞·ªõi ƒë·ªÉ ki·ªÉm tra
            </p>
            <div class="debt-checker-controls">
                <button class="btn btn-primary" onclick="runDebtCheck()">Ki·ªÉm Tra N·ª£</button>
                <label for="debtCheckFile" class="upload-label txt-label">Ch·ªçn file TXT</label>
                <input type="file" id="debtCheckFile" accept=".txt"
                    onchange="document.getElementById('debtCheckFileName').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file'">
                <span class="file-name" id="debtCheckFileName">Ch∆∞a ch·ªçn file</span>
            </div>
            <div id="debtCheckResults">

                <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>
        <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->

        <!-- === TH√äM M·ªöI: C√¥ng c·ª• t√≠nh Hell Event === -->
        <div class="hell-event-calculator-section">
            <h2>üî• C√¥ng C·ª• T√≠nh ƒêi·ªÉm Hell Event</h2>
            <div class="hell-event-controls">
                <select id="hellEventType" onchange="toggleHellOptions()">
                    <option value="pact">Hell Kh·∫ø ∆Ø·ªõc</option>
                    <option value="maze">Hell M√™ H·ªìn Tr·∫≠n</option>
                    <option value="troop">Hell L√≠nh</option>
                </select>
                <input type="number" id="hellPointsTarget" placeholder="Nh·∫≠p t·ªïng ƒëi·ªÉm hell c·∫ßn ƒÉn...">
                <button class="btn btn-primary" onclick="calculateHellEvent()">T√≠nh to√°n</button>
                <!-- Th√™m t√πy ch·ªçn cho Hell Kh·∫ø ∆Ø·ªõc -->
                <div id="pactSpeedOptions">
                    <span>T·ªëc ƒë·ªô k·∫øt h·ª£p (%): </span>
                    <input type="number" id="pactSpeed" placeholder="V√≠ d·ª•: 391.1" value="391.1">
                </div>
                <!-- Th√™m t√πy ch·ªçn cho Hell Kh·∫ø ∆Ø·ªõc -->
                <div id="pactOptions">
                    <span>D√πng kh·∫ø: </span>
                    <label><input type="checkbox" class="pact-option" value="pact4" checked> Kh·∫ø 4</label>
                    <label><input type="checkbox" class="pact-option" value="pact3" checked> Kh·∫ø 3</label>
                    <label><input type="checkbox" class="pact-option" value="pact2" checked> Kh·∫ø 2</label>
                    <label><input type="checkbox" class="pact-option" value="pact1" checked> Kh·∫ø 1</label>
                </div>
                <!-- Th√™m t√πy ch·ªçn cho Hell L√≠nh -->
                <div id="troopOptions">
                    <span>D√πng l√≠nh: </span>
                    <label><input type="checkbox" class="troop-option" value="t4" checked> T4</label>
                    <label><input type="checkbox" class="troop-option" value="t3" checked> T3</label>
                    <label><input type="checkbox" class="troop-option" value="t2" checked> T2</label>
                    <label><input type="checkbox" class="troop-option" value="t1" checked> T1</label>
                </div>
                <!-- === TH√äM M·ªöI: T√πy ch·ªçn chi ti·∫øt cho Hell L√≠nh === -->
                <div id="troopExtraOptions">
                    <span>Lo·∫°i T4: </span>
                    <select id="t4TroopType" class="url-input">
                        <option value="archer">Cung</option>
                        <option value="cavalry">K·ªµ</option>
                        <option value="infantry">B·ªô</option>
                    </select>
                    <span>T·ªëc ƒë·ªô hu·∫•n luy·ªán (%): </span>
                    <input type="number" id="trainingSpeed" placeholder="V√≠ d·ª•: 522.38" value="522.38"
                        class="url-input">
                </div>
                <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->
            </div>
            <div id="hellResults" style="display: none;">
                <!-- K·∫øt qu·∫£ t√≠nh to√°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>
        <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->

        <!-- === TH√äM M·ªöI: C√¥ng c·ª• t√≠nh NƒÉng L∆∞·ª£ng SƒÉn Qu√°i === -->
        <div class="energy-calculator-section">
            <h2>‚ö° C√¥ng C·ª• T√≠nh NƒÉng L∆∞·ª£ng SƒÉn Qu√°i</h2>
            <div class="energy-grid">
                <div class="energy-input-group">
                    <label for="energy1k">1k NL x</label>
                    <input type="number" id="energy1k" placeholder="0" min="0">
                </div>
                <div class="energy-input-group">
                    <label for="energy2k">2k NL x</label>
                    <input type="number" id="energy2k" placeholder="0" min="0">
                </div>
                <div class="energy-input-group">
                    <label for="energy5k">5k NL x</label>
                    <input type="number" id="energy5k" placeholder="0" min="0">
                </div>
                <div class="energy-input-group">
                    <label for="energy10k">10k NL x</label>
                    <input type="number" id="energy10k" placeholder="0" min="0">
                </div>
                <div class="energy-input-group">
                    <label for="energy20k">20k NL x</label>
                    <input type="number" id="energy20k" placeholder="0" min="0">
                </div>
                <div class="energy-input-group">
                    <label for="energy50k">50k NL x</label>
                    <input type="number" id="energy50k" placeholder="0" min="0">
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="calculateEnergy()">T√≠nh T·ªïng</button>
            </div>
            <div id="energyResults" style="display: none;"></div>
        </div>
        <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->

        <!-- === TH√äM M·ªöI: B·∫£ng X·∫øp H·∫°ng N·∫°p === -->
        <div class="purchase-leaderboard-section">
            <h2>üíé B·∫£ng X·∫øp H·∫°ng N·∫°p</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="displayPurchaseLeaderboard()">C·∫≠p nh·∫≠t B·∫£ng X·∫øp H·∫°ng</button>
            </div>
            <div id="purchaseLeaderboardResults">
                <!-- K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>
        <!-- === K·∫æT TH√öC TH√äM M·ªöI === -->

    </div>

    <script>
        Chart.register(ChartDataLabels); // ƒêƒÉng k√Ω plugin to√†n c·ª•c ƒë·ªÉ hi·ªÉn th·ªã s·ªë li·ªáu
        // Khai b√°o bi·∫øn l∆∞u d·ªØ li·ªáu
        let statusChartInstance = null;
        let monsterDistributionChartInstance = null; // Th√™m bi·∫øn cho bi·ªÉu ƒë·ªì m·ªõi
        let topPlayersChartInstance = null;
        let originalData = []; // Th√™m d√≤ng n√†y
        let rawExcelData = []; // Th√™m d√≤ng n√†y ƒë·ªÉ l∆∞u d·ªØ li·ªáu th√¥ t·ª´ Excel
        let processedData = [];
        let showQuaiTuan = false;
        let showIdColumn = false;
        let showBuColumn = true; // S·ª≠a: B√π hi·ªán m·∫∑c ƒë·ªãnh
        let currentTab = 'missing'; 
        // === TH√äM M·ªöI: Bi·∫øn cho Countdown ===
        let countdownIntervalId = null;
        let countdownTargetTimestamp = null;
        // === K·∫æT TH√öC TH√äM M·ªöI ===        
        const localStorageKey = 'fvnMonsterHuntData'; // Key ƒë·ªÉ l∆∞u d·ªØ li·ªáu
        // === TH√äM M·ªöI: Logic cho dropdown ===
        function toggleDropdown(event) {
            document.getElementById("displayOptionsDropdown").classList.toggle("show");
        }

        // ƒê√≥ng dropdown n·∫øu click ra ngo√†i
        window.onclick = function (event) {
            if (!event.target.closest('.dropdown')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
        // === K·∫æT TH√öC TH√äM M·ªöI ===
        // === TH√äM M·ªöI: Logic cho Bookmark Toggle ===
        function handleBookmarkToggle(checkbox) {
            if (checkbox.checked) {
                bookmarkData();
            } else {
                clearBookmark();
            }
        }
        // === K·∫æT TH√öC TH√äM M·ªöI ===
        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file
        document.getElementById('excelFile').addEventListener('change', function (e) {
            document.getElementById('excelFileName').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file';
        });

        document.getElementById('txtFile').addEventListener('change', function (e) {
            document.getElementById('txtFileName').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file';
        });
        // === K·∫æT TH√öC PH·∫¶N TH√äM ===

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // C·∫≠p nh·∫≠t c·∫£ originalData v√† processedData
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) searchInput.value = '';


                    rawExcelData = jsonData; // L∆∞u d·ªØ li·ªáu th√¥
                    originalData = processData(jsonData); // D·ªØ li·ªáu g·ªëc
                    processedData = JSON.parse(JSON.stringify(originalData)); // B·∫£n sao ƒë·ªÉ ch·ªânh s·ª≠a
                    currentTab = 'missing';
                    updateUI();

                } catch (error) {
                    alert('L·ªói ƒë·ªçc file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu Excel g·ªëc
        function processExcelData(rawData) {
            const headers = rawData[0].map(h => h.trim().toLowerCase());

            return rawData.slice(1).map(row => {
                return {
                    id: parseInt(row[headers.indexOf("user id")]) || 0,
                    name: row[headers.indexOf("name")] || '',
                    levels: {
                        l1: parseInt(row[headers.indexOf("l1 (hunt)")]) || 0,
                        l2: parseInt(row[headers.indexOf("l2 (hunt)")]) || 0,
                        l3: parseInt(row[headers.indexOf("l3 (hunt)")]) || 0,
                        l4: parseInt(row[headers.indexOf("l4 (hunt)")]) || 0,
                        l5: parseInt(row[headers.indexOf("l5 (hunt)")]) || 0
                    },
                    target: 56, // Gi√° tr·ªã m·∫∑c ƒë·ªãnh
                    points: 0,
                    status: 'missing',
                    corrected: false
                };
            }).filter(item => item.id !== 0);
        }

        // H√†m x·ª≠ l√Ω file TXT
        function processTxtFile() {
            const txtFile = document.getElementById('txtFile').files[0];
            if (!txtFile) {
                alert("Vui l√≤ng ch·ªçn file TXT tr∆∞·ªõc.");
                return;
            }
            if (processedData.length === 0) {
                alert("Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc khi x·ª≠ l√Ω file TXT.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                const userIds = e.target.result.split(',').map(id => id.trim().replace(/\D/g, '')); // L·ªçc ch·ªâ gi·ªØ l·∫°i s·ªë
                let changesMade = 0;

                // Ch·ªâ c·∫≠p nh·∫≠t processedData, gi·ªØ nguy√™n originalData
                userIds.forEach(uid => {
                    if (!uid) return; // B·ªè qua c√°c chu·ªói r·ªóng sau khi l·ªçc
                    const user = processedData.find(item => String(item.id) === uid);
                    if (user) {
                        // N·∫øu ƒëi·ªÉm hi·ªán t·∫°i c·ªßa ng∆∞·ªùi ch∆°i th·∫•p h∆°n m·ª•c ti√™u
                        if (user.points < user.target) {
                            // C·∫≠p nh·∫≠t m·ª•c ti√™u m·ªõi b·∫±ng ch√≠nh ƒëi·ªÉm h·ªç sƒÉn ƒë∆∞·ª£c
                            user.target = user.points;
                            // ƒê√°nh d·∫•u l√† ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω qua file TXT
                            user.corrected = true;
                            // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i c·ªßa ng∆∞·ªùi ch∆°i (s·∫Ω th√†nh 'sufficient')
                            updateStatus(user);
                            changesMade++;
                        }
                        // N·∫øu ƒëi·ªÉm >= m·ª•c ti√™u, kh√¥ng l√†m g√¨ c·∫£ theo y√™u c·∫ßu.
                    }
                });

                if (changesMade > 0) {
                    alert(`ƒê√£ c·∫≠p nh·∫≠t m·ª•c ti√™u cho ${changesMade} th√†nh vi√™n.`);
                    updateUI();
                } else {
                    alert("Kh√¥ng c√≥ th√†nh vi√™n n√†o trong file TXT c·∫ßn c·∫≠p nh·∫≠t (t·∫•t c·∫£ ƒë·ªÅu ƒë√£ ƒë·ªß/d∆∞ ƒëi·ªÉm ho·∫∑c kh√¥ng t√¨m th·∫•y).");
                }
            };
            reader.readAsText(txtFile);
        }

        async function exportToImage() {
            if (!processedData.length) {
                alert("Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc!");
                return;
            }
        
            const contentDivId = `${currentTab}Content`;
            const contentDiv = document.getElementById(contentDivId);
            const tableElement = contentDiv.querySelector('.table-responsive > table');
        
            if (!tableElement) {
                alert(`Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu trong tab "${currentTab}" ƒë·ªÉ xu·∫•t ·∫£nh.`);
                return;
            }
        
            // --- Ph·∫£n h·ªìi UI ---
            const exportButton = document.querySelector('.export-image-btn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = 'üì∏ ƒêang x·ª≠ l√Ω...';
            exportButton.disabled = true;
        
            // === B∆Ø·ªöC 1: M·ªü tab m·ªõi NGAY L·∫¨P T·ª®C ===
            // ƒê√¢y l√† h√†nh ƒë·ªông ƒë·ªìng b·ªô v·ªõi click c·ªßa ng∆∞·ªùi d√πng, gi√∫p tr√°nh b·ªã ch·∫∑n b·ªüi pop-up blocker tr√™n Safari.
            const newWindow = window.open('', '_blank');
        
            // === B∆Ø·ªöC 2: X·ª≠ l√Ω n·∫øu tab b·ªã ch·∫∑n ===
            if (!newWindow) {
                alert("M·ªü tab m·ªõi b·ªã ch·∫∑n. S·∫Ω t·ª± ƒë·ªông t·∫£i file ·∫£nh v·ªÅ m√°y.");
        
                // Chuy·ªÉn sang ph∆∞∆°ng th·ª©c t·∫£i v·ªÅ
                try {
                    const thElements = tableElement.querySelectorAll('th');
                    const originalThStyles = [];
                    thElements.forEach(th => {
                        originalThStyles.push(th.style.position);
                        th.style.position = 'static';
                    });
        
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight
                    });
        
                    thElements.forEach((th, index) => {
                        th.style.position = originalThStyles[index] || '';
                    });
        
                    canvas.toBlob(function(blob) {
                        if (!blob) { throw new Error("Kh√¥ng th·ªÉ t·∫°o Blob t·ª´ canvas."); }
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        const today = new Date();
                        const fileName = `BaoCao_${currentTab}_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}.png`;
                        link.download = fileName;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                } catch (error) {
                    console.error('L·ªói khi xu·∫•t ·∫£nh (ph∆∞∆°ng th·ª©c t·∫£i v·ªÅ):', error);
                    alert(`Xu·∫•t ·∫£nh th·∫•t b·∫°i! L·ªói: ${error.message}.`);
                } finally {
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
                return; // D·ª´ng h√†m
            }
        
            // === B∆Ø·ªöC 3: N·∫øu tab ƒë∆∞·ª£c m·ªü, hi·ªÉn th·ªã th√¥ng b√°o ch·ªù ===
            try {
                newWindow.document.write('<!DOCTYPE html><html><head><title>ƒêang t·∫°o ·∫£nh...</title></head><body style="margin:0; background:#f0f0f0; display:flex; align-items:center; justify-content:center; height:100vh; font-family:sans-serif;"><h2>üñºÔ∏è ƒêang t·∫°o ·∫£nh, vui l√≤ng ch·ªù...</h2></body></html>');
                newWindow.document.close();
            } catch (e) {
                console.warn("Kh√¥ng th·ªÉ ghi v√†o tab m·ªõi, c√≥ th·ªÉ do cross-origin. S·∫Ω th·ª≠ ƒëi·ªÅu h∆∞·ªõng tr·ª±c ti·∫øp.");
            }
        
            // === B∆Ø·ªöC 4: T·∫°o ·∫£nh v√† c·∫≠p nh·∫≠t tab m·ªõi (d√πng setTimeout ƒë·ªÉ render) ===
            const thElements = tableElement.querySelectorAll('th');
            const originalThStyles = [];
            thElements.forEach(th => {
                originalThStyles.push(th.style.position);
                th.style.position = 'static';
            });
        
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });
        
                    const imageDataUrl = canvas.toDataURL('image/png');
        
                    // C·∫≠p nh·∫≠t n·ªôi dung c·ªßa tab m·ªõi v·ªõi ·∫£nh ƒë√£ t·∫°o
                    newWindow.document.open();
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head><title>B√°o c√°o ${currentTab}</title></head>
                            <body style="margin:0;">
                                <img src="${imageDataUrl}" alt="B√°o c√°o ${currentTab}" style="max-width: 100%; display: block;">
                            </body>
                        </html>`);
                    newWindow.document.close();
        
                } catch (error) {
                    console.error('L·ªói khi t·∫°o ·∫£nh v√† c·∫≠p nh·∫≠t tab m·ªõi:', error);
                    try {
                        newWindow.document.body.innerHTML = `<h2>R·∫•t ti·∫øc, ƒë√£ x·∫£y ra l·ªói khi t·∫°o ·∫£nh: ${error.message}</h2>`;
                    } catch (e) {}
                } finally {
                    thElements.forEach((th, index) => {
                        th.style.position = originalThStyles[index] || '';
                    });
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
            }, 150);
        }

        function processData(data) {
            const result = [];
            if (data.length < 2) return result;

            const headers = data[0].map(h => h.trim().toLowerCase());
            const colIndex = {
                userId: headers.indexOf("user id"),
                name: headers.indexOf("name"),
                l1: headers.indexOf("l1 (hunt)"),
                l2: headers.indexOf("l2 (hunt)"),
                l3: headers.indexOf("l3 (hunt)"),
                l4: headers.indexOf("l4 (hunt)"),
                l5: headers.indexOf("l5 (hunt)")
            };

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const item = {
                    id: parseInt(row[colIndex.userId]) || 0,
                    name: row[colIndex.name] || '',
                    levels: {
                        l1: parseInt(row[colIndex.l1]) || 0,
                        l2: parseInt(row[colIndex.l2]) || 0,
                        l3: parseInt(row[colIndex.l3]) || 0,
                        l4: parseInt(row[colIndex.l4]) || 0,
                        l5: parseInt(row[colIndex.l5]) || 0
                    },
                    target: parseInt(document.getElementById('globalTargetInput')?.value) || 56,
                    status: 'missing',
                    corrected: false, // Th√™m ƒë·ªÉ ƒë·ªìng b·ªô
                    isPinned: false   // Th√™m tr·∫°ng th√°i ghim
                };

                calculatePoints(item);
                result.push(item);
            }

            return result.filter(item => item.id !== 0);
        }

        function calculatePoints(item) {
            item.points = item.levels.l2 +
                (item.levels.l3 * 4) +
                (item.levels.l4 * 16) +
                (item.levels.l5 * 32);
            updateStatus(item);
        }

        function updateStatus(item) {
            const diff = item.points - item.target;
            item.status = diff >= 0 ? (diff > 0 ? 'excess' : 'sufficient') : 'missing';
        }
        function renderCharts() {
            if (!processedData || processedData.length === 0) {
                alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc.");
                return;
            }

            // --- D·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Tr·∫°ng th√°i (Pie Chart) ---
            const statusCounts = {
                missing: processedData.filter(item => item.status === 'missing').length,
                sufficient: processedData.filter(item => item.status === 'sufficient').length,
                excess: processedData.filter(item => item.status === 'excess').length,
            };

            // D·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Ph√¢n lo·∫°i Qu√°i
            const monsterTotals = processedData.reduce((acc, item) => {
                acc.l1 += item.levels.l1 || 0;
                acc.l2 += item.levels.l2 || 0;
                acc.l3 += item.levels.l3 || 0;
                acc.l4 += item.levels.l4 || 0;
                acc.l5 += item.levels.l5 || 0;
                return acc;
            }, { l1: 0, l2: 0, l3: 0, l4: 0, l5: 0 });

            // T√≠nh t·ªïng ƒëi·ªÉm cho m·ªói lo·∫°i qu√°i
            const monsterPoints = {
                l1: 0, // L1 kh√¥ng c√≥ ƒëi·ªÉm
                l2: (monsterTotals.l2 || 0) * 1,
                l3: (monsterTotals.l3 || 0) * 4,
                l4: (monsterTotals.l4 || 0) * 16,
                l5: (monsterTotals.l5 || 0) * 32,
            };

            // --- Bi·ªÉu ƒë·ªì 1: T·ª∑ l·ªá Tr·∫°ng th√°i ---
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (statusChartInstance) {
                statusChartInstance.destroy();
            }
            statusChartInstance = new Chart(statusCtx, {
                type: 'pie', // D√πng pie cho ƒë∆°n gi·∫£n
                data: {
                    labels: ['Thi·∫øu', 'ƒê·ªß', 'D∆∞'],
                    datasets: [{
                        label: 'Ph√¢n lo·∫°i tr·∫°ng th√°i',
                        data: [statusCounts.missing, statusCounts.sufficient, statusCounts.excess],
                        backgroundColor: [
                            'rgb(241, 196, 15)', // Warning color (Thi·∫øu)
                            'rgb(46, 204, 113)', // Success color (ƒê·ªß)
                            'rgb(231, 76, 60)'   // Danger color (D∆∞)
                        ],
                        hoverOffset: 4,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'T·ª∑ l·ªá tr·∫°ng th√°i sƒÉn qu√°i'
                        },
                        legend: {
                            position: 'top',
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (total === 0) return '';
                                const percentage = (value * 100 / total).toFixed(1) + '%';
                                return percentage;
                            },
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            },
                            textStrokeColor: 'black',
                            textStrokeWidth: 1
                        }
                    }
                }
            });

            // --- Bi·ªÉu ƒë·ªì 2: Ph√¢n lo·∫°i Qu√°i (v·ªõi %) ---
            const monsterCtx = document.getElementById('monsterDistributionChart').getContext('2d');
            if (monsterDistributionChartInstance) {
                monsterDistributionChartInstance.destroy();
            }
            monsterDistributionChartInstance = new Chart(monsterCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Qu√°i L2', 'Qu√°i L3', 'Qu√°i L4', 'Qu√°i L5'], // B·ªè L1 v√¨ ƒëi·ªÉm = 0
                    datasets: [{
                        label: 'T·ª∑ l·ªá ƒëi·ªÉm qu√°i',
                        // B·ªè L1 v√¨ ƒëi·ªÉm = 0
                        data: [monsterPoints.l2, monsterPoints.l3, monsterPoints.l4, monsterPoints.l5],
                        backgroundColor: [
                            '#778beb', // L2 - T√≠m
                            '#f7b731', // L3 - V√†ng
                            '#eb3b5a', // L4 - ƒê·ªè
                            '#2d98da'  // L5 - Xanh d∆∞∆°ng
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (value === 0) {
                                    return '';
                                }
                                const sum = ctx.chart.data.datasets[ctx.datasetIndex].data.reduce((a, b) => a + b, 0);
                                if (sum === 0) {
                                    return '';
                                }
                                const percentage = (value * 100 / sum).toFixed(1) + '%';
                                return percentage;
                            },
                            color: '#fff',
                            font: { weight: 'bold' },
                            textStrokeColor: 'black',
                            textStrokeWidth: 1
                        },
                        title: {
                            display: true,
                            text: 'T·ª∑ l·ªá ƒëi·ªÉm theo lo·∫°i qu√°i'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    return `${label}: ${value.toLocaleString('vi-VN')} ƒëi·ªÉm`;
                                }
                            }
                        }
                    }
                }
            });

            // --- D·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Top Ng∆∞·ªùi Ch∆°i (Bar Chart) ---
            const topN = 3; // L·∫•y top 3 ng∆∞·ªùi
            const sortedPlayers = [...processedData]
                .sort((a, b) => b.points - a.points)
                .slice(0, topN);

            const topPlayersCtx = document.getElementById('topPlayersChart').getContext('2d');

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
            if (topPlayersChartInstance) {
                topPlayersChartInstance.destroy();
            }

            topPlayersChartInstance = new Chart(topPlayersCtx, {
                type: 'bar',
                data: {
                    labels: sortedPlayers.map((p, index) => {
                        const rank = index + 1;
                        const shortName = p.name.substring(0, 15) + (p.name.length > 15 ? '...' : ''); // Gi·ªØ l·∫°i vi·ªác c·∫Øt ng·∫Øn t√™n
                        return `Top ${rank}: ${shortName} (${p.points} ƒëi·ªÉm)`; // T·∫°o label m·ªõi
                    }),
                    // ‚ñ≤‚ñ≤‚ñ≤ K·∫æT TH√öC THAY ƒê·ªîI ‚ñ≤‚ñ≤‚ñ≤
                    datasets: [{
                        label: `Top ${topN} mem sƒÉn nhi·ªÅu nh·∫•t`,
                        data: sortedPlayers.map(p => p.points),
                        backgroundColor: 'rgba(52, 152, 219, 0.7)', // Primary color with transparency
                        borderColor: 'rgb(52, 152, 219)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Hi·ªÉn th·ªã thanh ngang ƒë·ªÉ d·ªÖ ƒë·ªçc t√™n
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    y: {
                        ticks: {
                            autoSkip: false // ƒê·∫£m b·∫£o t·∫•t c·∫£ nh√£n ƒë·ªÅu hi·ªÉn th·ªã
                        },
                        afterFit: function (scaleInstance) {
                            scaleInstance.width = 200; // TƒÉng chi·ªÅu r·ªông khu v·ª±c nh√£n tr·ª•c Y (ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn)
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Top ${topN} mem sƒÉn nhi·ªÅu nh·∫•t`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false // C√≥ th·ªÉ ·∫©n ch√∫ th√≠ch n·∫øu ch·ªâ c√≥ 1 dataset
                        },
                        tooltip: { // C√≥ th·ªÉ t√πy ch·ªânh tooltip n·∫øu mu·ªën
                            callbacks: {
                                label: function (context) {
                                    // Ch·ªâ hi·ªÉn th·ªã gi√° tr·ªã ƒëi·ªÉm trong tooltip v√¨ t√™n ƒë√£ c√≥ tr√™n tr·ª•c Y
                                    return `ƒêi·ªÉm: ${context.parsed.x}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateUI() {
            updateTotalPointsDisplay(); // C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm
            updateCounts(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng c√°c tab
            renderTable(currentTab);

            // Ch·ªâ x√≥a n√∫t Excel (class 'download-btn')
            document.querySelector('.download-btn')?.remove();

            createDownloadButton(); // T·∫°o l·∫°i n√∫t Excel m·ªõi

            // G·ªçi h√†m v·∫Ω bi·ªÉu ƒë·ªì (n·∫øu c√≥ d·ªØ li·ªáu)
            if (processedData && processedData.length > 0) {
                // C√≥ th·ªÉ th√™m ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM c·∫≠p nh·∫≠t xong
                // setTimeout(renderCharts, 100);
                // Ho·∫∑c g·ªçi tr·ª±c ti·∫øp n·∫øu kh√¥ng g·∫∑p v·∫•n ƒë·ªÅ
                renderCharts();
            }
            displayPurchaseLeaderboard(); // C·∫≠p nh·∫≠t BXH N·∫°p
        }

        // === TH√äM M·ªöI: H√†m c·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm ===
        // S·ª≠a ƒë·ªïi: L·∫•y d·ªØ li·ªáu t·ª´ d√≤ng 'total' trong file Excel g·ªëc
        function updateTotalPointsDisplay() {
            const displayElement = document.getElementById('totalPointsDisplay');
            const breakdownElement = document.getElementById('totalHuntBreakdown');

            if (!rawExcelData || rawExcelData.length < 2) {
                if (displayElement) displayElement.textContent = '0';
                if (breakdownElement) breakdownElement.innerHTML = '';
                return;
            }

            // T√¨m ch·ªâ s·ªë c√°c c·ªôt c·∫ßn thi·∫øt m·ªôt c√°ch linh ho·∫°t
            const headers = rawExcelData[0].map(h => String(h).trim().toLowerCase());
            const nameIndex = headers.indexOf("name");
            const l1Index = headers.indexOf("l1 (hunt)");
            const l2Index = headers.indexOf("l2 (hunt)");
            const l3Index = headers.indexOf("l3 (hunt)");
            const l4Index = headers.indexOf("l4 (hunt)");
            const l5Index = headers.indexOf("l5 (hunt)");

            // Ki·ªÉm tra xem t·∫•t c·∫£ c√°c c·ªôt c·∫ßn thi·∫øt c√≥ t·ªìn t·∫°i kh√¥ng
            if ([nameIndex, l1Index, l2Index, l3Index, l4Index, l5Index].some(index => index === -1)) {
                console.warn("Kh√¥ng t√¨m th·∫•y t·∫•t c·∫£ c√°c c·ªôt c·∫ßn thi·∫øt ('name', 'l1-l5 (hunt)') trong file Excel ƒë·ªÉ t√≠nh t·ªïng ƒëi·ªÉm.");
                if (displayElement) displayElement.textContent = 'L·ªói';
                if (breakdownElement) breakdownElement.innerHTML = '';
                return;
            }

            // T√¨m d√≤ng c√≥ gi√° tr·ªã 'total' trong c·ªôt 'name'
            const totalRow = rawExcelData.find(row => row && row[nameIndex] && String(row[nameIndex]).trim().toLowerCase() === 'total');

            let totalPoints = 0;
            let breakdownHtml = '';

            if (totalRow) {
                const l1 = parseInt(totalRow[l1Index]) || 0;
                const l2 = parseInt(totalRow[l2Index]) || 0;
                const l3 = parseInt(totalRow[l3Index]) || 0;
                const l4 = parseInt(totalRow[l4Index]) || 0;
                const l5 = parseInt(totalRow[l5Index]) || 0;
                totalPoints = l2 + (l3 * 4) + (l4 * 16) + (l5 * 32);

                // T·∫°o HTML cho ph·∫ßn chi ti·∫øt
                breakdownHtml = `
                    <span>L1: <strong>${l1.toLocaleString('vi-VN')}</strong></span>
                    <span>L2: <strong>${l2.toLocaleString('vi-VN')}</strong></span>
                    <span>L3: <strong>${l3.toLocaleString('vi-VN')}</strong></span>
                    <span>L4: <strong>${l4.toLocaleString('vi-VN')}</strong></span>
                    <span>L5: <strong>${l5.toLocaleString('vi-VN')}</strong></span>
                `;
            }

            if (displayElement) {
                displayElement.textContent = totalPoints.toLocaleString('vi-VN');
            }
            if (breakdownElement) {
                breakdownElement.innerHTML = breakdownHtml;
            }
        }
        // === K·∫æT TH√öC TH√äM M·ªöI ===


        function updateCounts() {
            const counts = {
                missing: processedData.filter(item => item.status === 'missing').length,
                sufficient: processedData.filter(item => item.status === 'sufficient').length,
                excess: processedData.filter(item => item.status === 'excess').length,
                corrected: processedData.filter(item => item.corrected).length
            };

            document.getElementById('missingCount').textContent = counts.missing;
            document.getElementById('sufficientCount').textContent = counts.sufficient + counts.excess;
            document.getElementById('correctedCount').textContent = counts.corrected;
        }

        // C·∫≠p nh·∫≠t h√†m render cho tab "ƒê√£ s·ª≠a"
        // Trong h√†m renderTable, x√≥a logic x·ª≠ l√Ω tab Top 3
        function filterCurrentTable() {
            // Ch·ªâ c·∫ßn render l·∫°i tab hi·ªán t·∫°i, logic l·ªçc ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p v√†o renderTable
            renderTable(currentTab);
        }

        function renderTable(tabId) {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

            let dataToRender = [];
            let originalDataForTab = []; // D·ªØ li·ªáu g·ªëc cho tab hi·ªán t·∫°i

            switch (tabId) {
                case 'missing':
                    // L·∫•y nh·ªØng ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c ghim, s·∫Øp x·∫øp theo Points Hunt gi·∫£m d·∫ßn
                    const pinnedUsers = processedData
                        .filter(item => item.isPinned)
                        .sort((a, b) => b.points - a.points); // S·ª≠a: S·∫Øp x·∫øp theo ƒëi·ªÉm sƒÉn (Points Hunt)

                    // L·∫•y nh·ªØng ng∆∞·ªùi ch∆°i thi·∫øu ƒëi·ªÉm v√† ch∆∞a ƒë∆∞·ª£c ghim
                    const unpinnedMissingUsers = processedData
                        .filter(item => !item.isPinned && item.status === 'missing');
                    
                    // K·∫øt h·ª£p 2 danh s√°ch: ng∆∞·ªùi ƒë∆∞·ª£c ghim s·∫Ω lu√¥n ·ªü tr√™n ƒë·∫ßu
                    originalDataForTab = [...pinnedUsers, ...unpinnedMissingUsers];
                    break;
                case 'sufficient':
                    originalDataForTab = [...processedData]
                        .filter(item => item.status !== 'missing')
                        .sort((a, b) => b.points - a.points);
                    break;
                case 'corrected':
                    if (!originalData || originalData.length === 0) {
                        originalDataForTab = [];
                    } else {
                        originalDataForTab = processedData.filter(item => item.corrected);
                    }
                    break;
            }

            // √Åp d·ª•ng b·ªô l·ªçc t√¨m ki·∫øm n·∫øu c√≥
            if (searchTerm) {
                dataToRender = originalDataForTab.filter(item => {
                    const nameMatch = item.name.toLowerCase().includes(searchTerm);
                    const idMatch = String(item.id).includes(searchTerm);
                    return nameMatch || idMatch;
                });
            } else {
                dataToRender = originalDataForTab;
            }

            document.getElementById(`${tabId}Content`).innerHTML = generateTable(dataToRender, tabId);

        }

        // S·ª≠a l·∫°i h√†m generateTable ch·ªâ d√πng cho c√°c tab th∆∞·ªùng
        function generateTable(data, tabId) {
            if (!data || data.length === 0) return '<p class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';

            const showCheckbox = tabId === 'missing';

            const compensationValue = parseInt(document.getElementById('compensationValueInput')?.value) || 0;

            // --- B·∫Øt ƒë·∫ßu: T√≠nh to√°n cho d√≤ng t·ªïng k·∫øt ---
            let footerHtml = '';
            if (tabId === 'sufficient' || tabId === 'corrected') {
                const totals = data.reduce((acc, item) => {
                    acc.l1 += item.levels.l1;
                    acc.l2 += item.levels.l2;
                    acc.l3 += item.levels.l3;
                    acc.l4 += item.levels.l4;
                    acc.l5 += item.levels.l5;
                    acc.points += item.points;
                    if (tabId === 'corrected') {
                        const missing = item.target - item.points;
                        if (missing > 0) {
                            acc.thieu += missing;
                            acc.bu += missing + compensationValue;
                        }
                    }
                    return acc;
                }, { l1: 0, l2: 0, l3: 0, l4: 0, l5: 0, points: 0, thieu: 0, bu: 0 });

                const format = (num) => num.toLocaleString('vi-VN');

                footerHtml = `
                    <tfoot>
                        <tr class="table-summary-row">
                            <td class="pin-column"></td> <!-- Th√™m √¥ tr·ªëng cho c·ªôt ghim -->
                            <td class="stt-column"></td> <!-- For STT -->
                            <td class="id-column"></td>
                            <td class="name-column"><strong>T·ªïng c·ªông</strong></td>
                            <td class="level-column">${format(totals.l1)}</td>
                            <td class="level-column">${format(totals.l2)}</td>
                            <td class="level-column">${format(totals.l3)}</td>
                            <td class="level-column">${format(totals.l4)}</td>
                            <td class="level-column">${format(totals.l5)}</td>
                            <td class="quai-tuan-column"></td>
                            <td class="points-column">${format(totals.points)}</td>
                            <td class="status-column">${tabId === 'corrected' ? format(totals.thieu) : ''}</td>
                            ${tabId === 'corrected' ? `<td class="bu-column">${format(totals.bu)}</td>` : ''}
                        </tr>
                    </tfoot>
                `;
            }
            // --- K·∫øt th√∫c: T√≠nh to√°n cho d√≤ng t·ªïng k·∫øt ---

            // B·ªçc b·∫£ng trong div.table-responsive
            return `
            <div class="table-responsive"><table>
                    <thead>
                        <tr>
                            ${showCheckbox ? '<th class="checkbox-column"></th>' : ''}
                            <th class="pin-column" title="Ghim">üìå</th>
                            <th class="stt-column">STT</th>
                            <th class="id-column">ID</th>
                            <th class="name-column">T√™n</th>
                            <th class="level-column">1</th>
                            <th class="level-column">2</th>
                            <th class="level-column">3</th>
                            <th class="level-column">4</th>
                            <th class="level-column">5</th>
                            <th class="quai-tuan-column">Qu√°i Tu·∫ßn</th>
                            <th class="points-column">Points Hunt</th>
                            <th class="status-column">${tabId === 'sufficient' ? 'D∆∞' : 'Thi·∫øu'}</th>
                            ${tabId !== 'sufficient' ? '<th class="bu-column">B√π</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((item, index) => `
                            <tr class="${item.isPinned ? 'pinned-row' : ''}">
                                ${showCheckbox ? `
                                    <td class="checkbox-column"><input type="checkbox" data-id="${item.id}"></td>
                                ` : ''}
                                <td class="pin-column">
                                    <button class="btn-pin ${item.isPinned ? 'pinned' : ''}" onclick="togglePin(${item.id})" title="Ghim/B·ªè ghim">üìå</button>
                                </td>
                                <td class="stt-column">${index + 1}</td>
                                <td class="id-column">${item.id}</td>
                                <td class="name-column">${item.name}</td>
                                <td class="level-column">${item.levels.l1}</td>
                                <td class="level-column">${item.levels.l2}</td>
                                <td class="level-column">${item.levels.l3}</td>
                                <td class="level-column">${item.levels.l4}</td>
                                <td class="level-column">${item.levels.l5}</td>
                                <td class="quai-tuan-column">
                                    <input type="number"
                                           value="${item.target}"
                                           data-id="${item.id}"
                                           class="target-input">
                                </td>
                                <td class="points-column">${item.points}</td>
                                <td class="status-column">${
                                    tabId === 'sufficient'
                                        ? Math.max(item.points - item.target, 0)
                                        : (item.isPinned && item.points > item.target
                                            ? `D∆∞ ${item.points - item.target}`
                                            : Math.max(0, item.target - item.points))
                                }</td>
                                ${tabId !== 'sufficient' ? `
                                    <td class="bu-column">${
                                        (item.isPinned && item.points > item.target)
                                            ? 0
                                            : (Math.max(0, item.target - item.points)) + compensationValue
                                    }</td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                    ${footerHtml}
                </table>
            </div><br>
            ${showCheckbox ? `
                <div class="table-footer">
                    <button onclick="processCorrections()">C·∫≠p nh·∫≠t m·ª•c ch·ªçn</button>
                </div>
            ` : ''}
            ${tabId === 'missing' && data.length > 0 ? `
                <div class="table-footer">
                    <button onclick="exportMissingIdsToTxt()">Xu·∫•t ID Thi·∫øu</button>
                </div>
            ` : ''}
        `;
        }


        function getStatusText(item) {
            const diff = item.points - item.target;
            if (diff < 0) return `Thi·∫øu ${-diff}`;
            if (diff === 0) return 'ƒê·ªß';
            return `D∆∞ ${diff}`;
        }



        // Th√™m h√†m t√≠nh level cao nh·∫•t
        function calculateHighestLevel(levels) {
            const levelValues = [levels.l2, levels.l3, levels.l4, levels.l5];
            let maxLevel = 2;
            levelValues.forEach((val, idx) => {
                if (val > 0) maxLevel = idx + 2;
            });
            return maxLevel;
        }

        // C·∫≠p nh·∫≠t h√†m showTab ƒë·ªÉ d√πng class thay v√¨ style inline
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('tab-content-hidden'); // Th√™m class ·∫©n
                el.style.display = 'none'; // V·∫´n gi·ªØ display none ƒë·ªÉ ƒë·∫£m b·∫£o ·∫©n ban ƒë·∫ßu
            });
            const activeTabContent = document.getElementById(tabId);
            activeTabContent.classList.remove('tab-content-hidden'); // X√≥a class ·∫©n
            activeTabContent.style.display = 'block'; // Hi·ªÉn th·ªã

            // C·∫≠p nh·∫≠t class 'active' cho n√∫t tab
            document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
            // T√¨m n√∫t t∆∞∆°ng ·ª©ng v√† th√™m class active (c·∫ßn ƒë·∫£m b·∫£o onclick c√≥ c√°ch l·∫•y ƒë√∫ng n√∫t)
            // V√≠ d·ª• ƒë∆°n gi·∫£n: t√¨m theo n·ªôi dung text ho·∫∑c th√™m data-tab attribute
            document.querySelector(`.tab button[onclick="showTab('${tabId}')"]`).classList.add('active');


            currentTab = tabId;
            renderTable(tabId);
        }

        function toggleQuaiTuan() {
            showQuaiTuan = !showQuaiTuan;
            // Th√™m/x√≥a class 'hide-quaituan' tr√™n th·∫ª body
            document.body.classList.toggle('hide-quaituan', !showQuaiTuan);
            // Kh√¥ng c·∫ßn render l·∫°i b·∫£ng
        }

        function toggleIdColumn() {
            showIdColumn = !showIdColumn;
            // Th√™m/x√≥a class 'hide-id-column' tr√™n th·∫ª body
            document.body.classList.toggle('hide-id-column', !showIdColumn);
            // Kh√¥ng c·∫ßn render l·∫°i b·∫£ng v√¨ CSS s·∫Ω x·ª≠ l√Ω vi·ªác ·∫©n/hi·ªán
        }

        function toggleBuColumn() {
            showBuColumn = !showBuColumn;
            // Th√™m/x√≥a class 'hide-bu-column' tr√™n th·∫ª body
            document.body.classList.toggle('hide-bu-column', !showBuColumn);
        }

        // === TH√äM M·ªöI: H√†m ghim/b·ªè ghim m·ªôt ng∆∞·ªùi ch∆°i ===
        function togglePin(id) {
            const user = processedData.find(item => item.id === id);
            if (user) {
                user.isPinned = !user.isPinned;
                updateUI(); // C·∫≠p nh·∫≠t l·∫°i to√†n b·ªô giao di·ªán
            }
        }

        // H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t m·ª•c ch·ªçn
        function processCorrections() {
            const selectedIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.dataset.id));

            if (selectedIds.length === 0) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t.");
                return;
            }

            let changesMade = 0;
            processedData.forEach(item => {
                if (selectedIds.includes(item.id)) {
                    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu ng∆∞·ªùi ch∆°i ƒëang thi·∫øu ƒëi·ªÉm
                    if (item.points < item.target) {
                        item.target = item.points; // C·∫≠p nh·∫≠t m·ª•c ti√™u ('Qu√°i Tu·∫ßn') b·∫±ng ƒëi·ªÉm hi·ªán t·∫°i ('Points Hunt')
                        item.corrected = true;     // ƒê√°nh d·∫•u l√† ƒë√£ s·ª≠a
                        updateStatus(item);        // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i (s·∫Ω th√†nh 'sufficient')
                        changesMade++;
                    }
                }
            });

            if (changesMade > 0) {
                alert(`ƒê√£ c·∫≠p nh·∫≠t m·ª•c ti√™u cho ${changesMade} th√†nh vi√™n ƒë∆∞·ª£c ch·ªçn.`);
            } else {
                alert("Kh√¥ng c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c ch·ªçn c·∫ßn c·∫≠p nh·∫≠t (t·∫•t c·∫£ ƒë·ªÅu ƒë√£ ƒë·ªß/d∆∞ ƒëi·ªÉm).");
            }
            updateUI();
        }

        // C·∫≠p nh·∫≠t h√†m createDownloadButton ƒë·ªÉ th√™m class
        function createDownloadButton() {
            // X√≥a n√∫t c≈© tr∆∞·ªõc khi t·∫°o m·ªõi (ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            document.querySelector('.download-btn')?.remove();

            const btn = document.createElement('button');
            // Th√™m c√°c class c·∫ßn thi·∫øt
            btn.className = 'btn btn-success download-btn'; // Class chung v√† class ri√™ng
            btn.textContent = 'üì• Xu·∫•t Excel';
            btn.onclick = exportToExcel;
            document.querySelector('.actions-group').appendChild(btn); // S·ª≠a: Th√™m v√†o group h√†nh ƒë·ªông
        }

        function applyGlobalTarget() {
            const globalTarget = parseInt(document.getElementById('globalTargetInput').value);
            if (isNaN(globalTarget) || globalTarget < 0) {
                alert("Vui l√≤ng nh·∫≠p m·ª•c ti√™u h·ª£p l·ªá.");
                return;
            }

            if (!processedData || processedData.length === 0) {
                alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ √°p d·ª•ng m·ª•c ti√™u.");
                return;
            }

            processedData.forEach(item => {
                item.target = globalTarget;
                updateStatus(item); // Recalculate status
            });
            updateUI(); // Refresh the entire UI
        }
        // G·ªçi showTab ban ƒë·∫ßu ƒë·ªÉ ·∫©n c√°c tab kh√¥ng active
        document.addEventListener('DOMContentLoaded', () => {
            // Th√™m class ƒë·ªÉ ·∫©n c·ªôt ID v√† Qu√°i Tu·∫ßn m·∫∑c ƒë·ªãnh
            loadBookmarkedData(); // Th·ª≠ t·∫£i d·ªØ li·ªáu ƒë√£ l∆∞u
            if (processedData.length === 0) {
                // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u, thi·∫øt l·∫≠p tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
                document.body.classList.add('hide-id-column');
                document.body.classList.add('hide-quaituan');
                showTab('missing'); // Hi·ªÉn th·ªã tab m·∫∑c ƒë·ªãnh
                toggleHellOptions(); // G·ªçi ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng options cho hell m·∫∑c ƒë·ªãnh
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu cho c√°c checkbox v√† c·ªôt
                document.getElementById('toggleIdCheckbox').checked = showIdColumn;
                document.getElementById('toggleQuaiTuanCheckbox').checked = showQuaiTuan;
                document.getElementById('toggleBuCheckbox').checked = showBuColumn;
                document.body.classList.toggle('hide-bu-column', !showBuColumn);
                displayPurchaseLeaderboard(); // Kh·ªüi t·∫°o BXH N·∫°p
            }
        });

        // === TH√äM M·ªöI: Ch·ª©c nƒÉng Bookmark ===
        function bookmarkData() {
            if (processedData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u.");
                const bookmarkCheckbox = document.getElementById('toggleBookmarkCheckbox');
                if (bookmarkCheckbox) bookmarkCheckbox.checked = false; // Ho√†n t√°c l·∫°i checkbox
                return;
            }

            const dataToSave = {
                processedData: processedData,
                rawExcelData: rawExcelData, // L∆∞u c·∫£ d·ªØ li·ªáu th√¥
                showIdColumn: showIdColumn,
                showQuaiTuan: showQuaiTuan,
                showBuColumn: showBuColumn,
                globalTarget: document.getElementById('globalTargetInput').value,
                compensationValue: document.getElementById('compensationValueInput').value
            };

            localStorage.setItem(localStorageKey, JSON.stringify(dataToSave));
            alert("ƒê√£ l∆∞u l·∫°i danh s√°ch v√† c√†i ƒë·∫∑t hi·ªán t·∫°i v√†o tr√¨nh duy·ªát!");
        }

        function loadBookmarkedData() {
            const savedDataJSON = localStorage.getItem(localStorageKey);
            const bookmarkCheckbox = document.getElementById('toggleBookmarkCheckbox');
            if (savedDataJSON) {
                const savedData = JSON.parse(savedDataJSON);
                processedData = savedData.processedData || [];
                rawExcelData = savedData.rawExcelData || [];
                originalData = JSON.parse(JSON.stringify(processedData)); // T·∫°o b·∫£n sao

                // Kh√¥i ph·ª•c tr·∫°ng th√°i UI
                showIdColumn = savedData.showIdColumn || false;
                showQuaiTuan = savedData.showQuaiTuan || false;
                showBuColumn = savedData.showBuColumn !== undefined ? savedData.showBuColumn : true;
                document.getElementById('globalTargetInput').value = savedData.globalTarget || 63;
                document.getElementById('compensationValueInput').value = savedData.compensationValue || 5;

                // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu ƒë√£ t·∫£i
                document.body.classList.toggle('hide-id-column', !showIdColumn);
                document.body.classList.toggle('hide-quaituan', !showQuaiTuan);
                document.body.classList.toggle('hide-bu-column', !showBuColumn);
                document.getElementById('toggleIdCheckbox').checked = showIdColumn;
                document.getElementById('toggleQuaiTuanCheckbox').checked = showQuaiTuan;
                document.getElementById('toggleBuCheckbox').checked = showBuColumn;
                if (bookmarkCheckbox) bookmarkCheckbox.checked = true;

                showTab('missing'); // Hi·ªÉn th·ªã tab m·∫∑c ƒë·ªãnh
                updateUI(); // C·∫≠p nh·∫≠t to√†n b·ªô UI
                console.log("ƒê√£ t·∫£i th√†nh c√¥ng d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ tr√¨nh duy·ªát.");
            } else {
                if (bookmarkCheckbox) bookmarkCheckbox.checked = false;
            }
        }

        function clearBookmark() {
            localStorage.removeItem(localStorageKey);
            alert("ƒê√£ x√≥a tr·∫°ng th√°i ƒë√£ l∆∞u. D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω m·∫•t khi b·∫°n t·∫£i l·∫°i trang.");
        }
        // === K·∫æT TH√öC TH√äM M·ªöI ===

        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                const cleanSheetName = (name) => name.replace(/[\/:*?[\]]/g, '-');

                // S·∫Øp x·∫øp d·ªØ li·ªáu: "Thi·∫øu" l√™n ƒë·∫ßu, sau ƒë√≥ theo ƒëi·ªÉm gi·∫£m d·∫ßn
                const sortedData = [...processedData].sort((a, b) => {
                    const aIsMissing = a.status === 'missing';
                    const bIsMissing = b.status === 'missing';

                    if (aIsMissing && !bIsMissing) return -1; // a (thi·∫øu) l√™n tr∆∞·ªõc b (kh√¥ng thi·∫øu)
                    if (!aIsMissing && bIsMissing) return 1;  // b (thi·∫øu) l√™n tr∆∞·ªõc a (kh√¥ng thi·∫øu)

                    // N·∫øu c·∫£ hai c√πng tr·∫°ng th√°i (c√πng thi·∫øu ho·∫∑c c√πng kh√¥ng), s·∫Øp x·∫øp theo ƒëi·ªÉm gi·∫£m d·∫ßn
                    return b.points - a.points;
                });

                const compensationValue = parseInt(document.getElementById('compensationValueInput')?.value) || 5;
                // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ xu·∫•t t·ª´ d·ªØ li·ªáu ƒë√£ s·∫Øp x·∫øp
                const wsData = [
                    ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Points Hunt", "Qu√°i Tu·∫ßn", "Thi·∫øu", "B√π"],
                    ...sortedData.map(item => [
                        item.id,
                        item.name,
                        item.levels.l1,
                        item.levels.l2,
                        item.levels.l3,
                        item.levels.l4,
                        item.levels.l5,
                        item.points,
                        item.target,
                        item.points === item.target ? "ƒê·ªß" :
                            item.points < item.target ? `Thi·∫øu ${item.target - item.points}` : `D∆∞ ${item.points - item.target}`,
                        item.points < item.target ? `B√π ${(item.target - item.points) + compensationValue}` : 0
                    ])
                ];

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Add column formatting
                ws['!cols'] = [
                    { wch: 10 }, // User ID
                    { wch: 25 }, // Name
                    { wch: 8 },  // L1
                    { wch: 8 },  // L2
                    { wch: 8 },  // L3
                    { wch: 8 },  // L4
                    { wch: 8 },  // L5
                    { wch: 12 }, // Points Hunt
                    { wch: 12 }, // Qu√°i Tu·∫ßn
                    { wch: 15 }, // Thi·∫øu
                    { wch: 10 }  // B√π
                ];

                // Add conditional formatting for "Thi·∫øu" (yellow) and "B√π" (orange)
                // Note: This requires using XLSX.utils.sheet_add_json with cell styling options
                // or creating a separate XLSX file with styling (more complex)

                // Alternative approach: Create HTML table with styling and convert to Excel
                // This will preserve basic colors but may not be perfect

                // For better formatting, we can use the xlsx-style library (not included by default)
                // Here's a simpler approach that will work with basic Excel export:

                // Mark cells that need styling (will be processed by Excel)
                wsData.forEach((row, rowIndex) => {
                    if (rowIndex === 0) return; // Skip header

                    // Column J (Thi·∫øu) - index 9
                    const thi·∫øuCell = XLSX.utils.encode_cell({ r: rowIndex, c: 9 });
                    if (ws[thi·∫øuCell] && ws[thi·∫øuCell].v.includes("Thi·∫øu")) {
                        ws[thi·∫øuCell].s = { fill: { fgColor: { rgb: "FFFFFF00" } } }; // Yellow
                    }

                    // Column K (B√π) - index 10
                    const b√πCell = XLSX.utils.encode_cell({ r: rowIndex, c: 10 });
                    if (ws[b√πCell] && typeof ws[b√πCell].v === 'string' && ws[b√πCell].v.startsWith("B√π")) {
                        ws[b√πCell].s = { fill: { fgColor: { rgb: "FFFFA500" } } }; // M√†u cam
                    }
                });

                // Th√™m c√¥ng th·ª©c d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ s·∫Øp x·∫øp
                sortedData.forEach((item, index) => {
                    const rowNum = index + 2; // 1-based index, row 1 is header

                    // Points Hunt formula (column H)
                    const pointsCell = XLSX.utils.encode_cell({ r: rowNum - 1, c: 7 });
                    ws[pointsCell] = {
                        f: `D${rowNum}+(E${rowNum}*4)+(F${rowNum}*16)+(G${rowNum}*32)`,
                        v: item.points
                    };

                    // Thi·∫øu formula (column J)
                    const thieuCell = XLSX.utils.encode_cell({ r: rowNum - 1, c: 9 });
                    ws[thieuCell] = {
                        f: `IF(H${rowNum}=I${rowNum}, "ƒê·ªß", IF(H${rowNum}<I${rowNum}, "Thi·∫øu "&(I${rowNum}-H${rowNum}), "D∆∞ "&(H${rowNum}-I${rowNum})))`,
                        v: item.points === item.target ? "ƒê·ªß" :
                            item.points < item.target ? `Thi·∫øu ${item.target - item.points}` : `D∆∞ ${item.points - item.target}`
                    };

                    // B√π formula (column K)
                    const buCell = XLSX.utils.encode_cell({ r: rowNum - 1, c: 10 });
                    ws[buCell] = {
                        f: `IF(ISNUMBER(SEARCH("Thi·∫øu",J${rowNum})), "B√π " & (I${rowNum}-H${rowNum}+${compensationValue}), 0)`,
                        v: item.points < item.target ? `B√π ${(item.target - item.points) + compensationValue}` : 0
                    };
                });

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, cleanSheetName("B√°o c√°o sƒÉn qu√°i"));

                // Generate filename
                const today = new Date();
                const fileName = `BaoCaoSanQuai_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}.xlsx`;

                // Export file
                XLSX.writeFile(wb, fileName);
                alert(`Xu·∫•t file Excel th√†nh c√¥ng: ${fileName}`);
            } catch (error) {
                console.error("L·ªói khi xu·∫•t Excel:", error);
                alert(`L·ªói khi xu·∫•t Excel: ${error.message}`);
            }
        }

        async function loadExcelFromUrl() {
            const rawUrl = document.getElementById('excelUrl').value.trim();
            console.log("URL g·ªëc:", rawUrl); // Log URL g·ªëc

            if (!rawUrl) {
                alert("Vui l√≤ng nh·∫≠p URL Google Sheets!");
                return;
            }

            // --- C·∫£i thi·ªán vi·ªác l·∫•y URL export ---
            let exportUrl = '';
            // Regex c·∫≠p nh·∫≠t ƒë·ªÉ kh·ªõp c·∫£ 'spreadsheets/d/' v√† 'file/d/'
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                // N·∫øu t√¨m th·∫•y ID, t·∫°o URL export chu·∫©n
                const sheetId = match[1];
                // Lu√¥n t·∫°o link export t·ª´ spreadsheets/d/ v√¨ ƒë√≥ l√† endpoint ch√≠nh th·ª©c
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
                console.log("ƒê√£ nh·∫≠n d·∫°ng Google Sheet/File ID:", sheetId);
                console.log("URL Export ƒë∆∞·ª£c t·∫°o:", exportUrl);
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                // Gi·∫£ s·ª≠ l√† link tr·ª±c ti·∫øp ƒë·∫øn file .xlsx/.xls (√≠t ph·ªï bi·∫øn, c√≥ th·ªÉ c·∫ßn proxy)
                exportUrl = rawUrl;
                console.log("URL c√≥ v·∫ª l√† link tr·ª±c ti·∫øp t·ªõi file Excel:", exportUrl);
            } else {
                // N·∫øu kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c, b√°o l·ªói
                alert("URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng cung c·∫•p link Google Sheets/File h·ª£p l·ªá (ƒë√£ chia s·∫ª c√¥ng khai) ho·∫∑c link tr·ª±c ti·∫øp ƒë·∫øn file .xlsx.");
                return;
            }
            // --- K·∫øt th√∫c c·∫£i thi·ªán URL ---

            // --- Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω ---
            const loadButton = document.querySelector('.url-input + .btn-primary'); // T√¨m n√∫t "T·∫£i t·ª´ URL"
            const originalButtonText = loadButton.textContent;
            loadButton.textContent = 'ƒêang t·∫£i...';
            loadButton.disabled = true;
            document.body.style.cursor = 'wait'; // ƒê·ªïi con tr·ªè chu·ªôt

            try {
                // S·ª≠ d·ª•ng proxy (v·∫´n c·∫ßn thi·∫øt cho CORS)
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest='; // B·∫°n c√≥ th·ªÉ th·ª≠ proxy kh√°c n·∫øu c·∫ßn
                const fetchUrl = proxyUrl + encodeURIComponent(exportUrl);
                console.log("URL Fetch qua Proxy:", fetchUrl);

                const response = await fetch(fetchUrl, {
                    signal: AbortSignal.timeout(30000) // Th√™m timeout 30 gi√¢y
                });
                console.log("Tr·∫°ng th√°i ph·∫£n h·ªìi:", response.status, response.statusText);
                console.log("Headers ph·∫£n h·ªìi:", Object.fromEntries(response.headers.entries())); // Log headers ƒë·ªÉ ki·ªÉm tra

                // --- Ki·ªÉm tra Content-Type v√† Status ---
                const contentType = response.headers.get('content-type');
                console.log("Content-Type:", contentType);

                if (!response.ok) {
                    // N·∫øu server b√°o l·ªói (status kh√¥ng ph·∫£i 2xx)
                    let errorBody = await response.text().catch(() => 'Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung l·ªói');
                    console.error("N·ªôi dung l·ªói t·ª´ proxy/server:", errorBody);
                    // Ki·ªÉm tra xem c√≥ ph·∫£i l·ªói HTML kh√¥ng
                    if (contentType && contentType.includes('text/html')) {
                        // L·ªói nh∆∞ng tr·∫£ v·ªÅ HTML (vd: trang 404, trang ƒëƒÉng nh·∫≠p...)
                        throw new Error(`L·ªói ${response.status}: Nh·∫≠n ƒë∆∞·ª£c trang HTML thay v√¨ file Excel. C√≥ th·ªÉ link sai, c·∫ßn ƒëƒÉng nh·∫≠p ho·∫∑c sheet kh√¥ng ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.`);
                    } else {
                        // L·ªói kh√°c
                        throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}`);
                    }
                }

                // Ki·ªÉm tra l·∫°i Content-Type ngay c·∫£ khi status l√† OK (200)
                // M·ªôt s·ªë proxy/tr∆∞·ªùng h·ª£p c√≥ th·ªÉ tr·∫£ v·ªÅ HTML v·ªõi status 200
                if (!contentType || !(contentType.includes('spreadsheetml.sheet') || contentType.includes('application/vnd.ms-excel') || contentType.includes('octet-stream'))) {
                    // N·∫øu Content-Type kh√¥ng ph·∫£i l√† Excel ho·∫∑c binary
                    let responseText = '';
                    try {
                        // Th·ª≠ ƒë·ªçc n·ªôi dung xem c√≥ ph·∫£i HTML kh√¥ng
                        const clonedResponse = response.clone(); // Clone ƒë·ªÉ ƒë·ªçc text m√† kh√¥ng ·∫£nh h∆∞·ªüng arrayBuffer
                        responseText = await clonedResponse.text();
                    } catch (e) { console.error("Kh√¥ng th·ªÉ ƒë·ªçc response text ƒë·ªÉ ki·ªÉm tra HTML"); }

                    if (responseText.trim().toLowerCase().startsWith('<html') || responseText.trim().toLowerCase().startsWith('<!doctype html')) {
                        console.error("N·ªôi dung ph·∫£n h·ªìi c√≥ v·∫ª l√† HTML:", responseText.substring(0, 500));
                        throw new Error("L·ªói ƒë·ªãnh d·∫°ng: Nh·∫≠n ƒë∆∞·ª£c HTML thay v√¨ file Excel. H√£y ƒë·∫£m b·∫£o link Google Sheet ƒë∆∞·ª£c chia s·∫ª c√¥ng khai ('Anyone with the link can view').");
                    } else {
                        // Kh√¥ng ph·∫£i HTML nh∆∞ng c≈©ng kh√¥ng ph·∫£i ƒë·ªãnh d·∫°ng Excel mong ƒë·ª£i
                        console.warn(`Content-Type kh√¥ng mong ƒë·ª£i: ${contentType}. V·∫´n th·ª≠ x·ª≠ l√Ω...`);
                    }
                }
                // --- K·∫øt th√∫c ki·ªÉm tra Content-Type ---

                console.log("ƒêang x·ª≠ l√Ω d·ªØ li·ªáu ArrayBuffer...");
                const arrayBuffer = await response.arrayBuffer();
                console.log("ƒê√£ nh·∫≠n ArrayBuffer, k√≠ch th∆∞·ªõc:", arrayBuffer.byteLength);

                // Ki·ªÉm tra file qu√° nh·ªè (th∆∞·ªùng l√† d·∫•u hi·ªáu l·ªói)
                if (arrayBuffer.byteLength < 100) { // Ng∆∞·ª°ng nh·ªè, c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh
                    let potentialErrorText = '';
                    try {
                        // Th·ª≠ gi·∫£i m√£ xem c√≥ ph·∫£i text l·ªói kh√¥ng
                        potentialErrorText = new TextDecoder().decode(arrayBuffer);
                    } catch { }
                    console.error("K√≠ch th∆∞·ªõc file qu√° nh·ªè, c√≥ th·ªÉ l√† l·ªói:", potentialErrorText);
                    throw new Error("T·∫£i file th·∫•t b·∫°i: File nh·∫≠n ƒë∆∞·ª£c qu√° nh·ªè, c√≥ th·ªÉ l√† trang l·ªói ho·∫∑c link kh√¥ng ƒë√∫ng.");
                }

                // Ti·∫øn h√†nh ph√¢n t√≠ch n·∫øu m·ªçi th·ª© c√≥ v·∫ª ·ªïn
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                console.log("ƒê√£ ph√¢n t√≠ch d·ªØ li·ªáu JSON t·ª´ Excel.");

                // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√† UI
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = '';

                rawExcelData = jsonData; // L∆∞u d·ªØ li·ªáu th√¥
                originalData = processData(jsonData);
                processedData = JSON.parse(JSON.stringify(originalData));
                currentTab = 'missing'; // Reset v·ªÅ tab m·∫∑c ƒë·ªãnh
                updateUI();
                alert("T·∫£i file th√†nh c√¥ng!");

            } catch (error) {
                console.error("Chi ti·∫øt l·ªói khi t·∫£i URL:", error);
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói c·ª• th·ªÉ h∆°n cho ng∆∞·ªùi d√πng
                let userMessage = `L·ªói t·∫£i URL: ${error.message || "Kh√¥ng r√µ nguy√™n nh√¢n."}`;
                if (error.message && error.message.includes("HTML")) {
                    // N·∫øu l·ªói c√≥ ch·ª©a ch·ªØ HTML, h∆∞·ªõng d·∫´n ki·ªÉm tra chia s·∫ª
                    userMessage += "\nVui l√≤ng ki·ªÉm tra:\n1. Link Google Sheets c√≥ ƒë√∫ng kh√¥ng?\n2. Sheet ƒë√£ ƒë∆∞·ª£c chia s·∫ª c√¥ng khai ('Anyone with the link can view') ch∆∞a?";
                } else if (error.name === 'TimeoutError') {
                    userMessage = "L·ªói: Y√™u c·∫ßu t·∫£i file m·∫•t qu√° nhi·ªÅu th·ªùi gian. Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.";
                } else if (!navigator.onLine) {
                    userMessage = "L·ªói: Kh√¥ng c√≥ k·∫øt n·ªëi m·∫°ng.";
                }
                alert(userMessage);
            } finally {
                // --- Kh√¥i ph·ª•c n√∫t v√† con tr·ªè ---
                loadButton.textContent = originalButtonText;
                loadButton.disabled = false;
                document.body.style.cursor = 'default';
            }
        }
        // H√†m ki·ªÉm tra URL h·ª£p l·ªá
        function isValidExcelUrl(url) {
            // Cho ph√©p c·∫£ URL th√¥ng th∆∞·ªùng v√† Google Sheets
            return /(\.xlsx?$)|(docs\.google\.com\/spreadsheets\/d\/)/i.test(url);
        }

        // H√†m x·ª≠ l√Ω thay ƒë·ªïi gi√° tr·ªã Qu√°i Tu·∫ßn cho t·ª´ng th√†nh vi√™n
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('target-input')) {
                const id = parseInt(e.target.dataset.id);
                const newTarget = parseInt(e.target.value) || 0; // N·∫øu r·ªóng, coi nh∆∞ l√† 0

                const user = processedData.find(item => item.id === id);
                if (user) {
                    user.target = newTarget;
                    updateStatus(user); // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i
                    updateUI(); // C·∫≠p nh·∫≠t l·∫°i to√†n b·ªô giao di·ªán ƒë·ªÉ thay ƒë·ªïi ƒë∆∞·ª£c ph·∫£n √°nh
                }
            }
        });

        function parseDuration(durationString) {
            if (!durationString) return null;
            durationString = durationString.trim().toLowerCase();
            let totalMs = 0;
            let valid = false;

            // Regex ƒë·ªÉ b·∫Øt c√°c th√†nh ph·∫ßn: days (d), hours (h), minutes (m), seconds (s), v√† HH:MM:SS
            const dayRegex = /(\d+)\s*d/;
            const hourRegex = /(\d+)\s*h/;
            const minRegex = /(\d+)\s*m/;
            const secRegex = /(\d+)\s*s/;
            const timeRegex = /(\d{1,2}):(\d{1,2}):(\d{1,2})/;

            const dayMatch = durationString.match(dayRegex);
            const hourMatch = durationString.match(hourRegex);
            const minMatch = durationString.match(minRegex);
            const secMatch = durationString.match(secRegex);
            const timeMatch = durationString.match(timeRegex);

            if (dayMatch) {
                totalMs += parseInt(dayMatch[1], 10) * 24 * 60 * 60 * 1000;
                valid = true;
            }
            if (hourMatch) {
                totalMs += parseInt(hourMatch[1], 10) * 60 * 60 * 1000;
                valid = true;
            }
            if (minMatch) {
                totalMs += parseInt(minMatch[1], 10) * 60 * 1000;
                valid = true;
            }
            if (secMatch) {
                totalMs += parseInt(secMatch[1], 10) * 1000;
                valid = true;
            }
            if (timeMatch) {
                const hours = parseInt(timeMatch[1], 10);
                const minutes = parseInt(timeMatch[2], 10);
                const seconds = parseInt(timeMatch[3], 10);
                if (hours < 24 && minutes < 60 && seconds < 60) {
                    // Ch·ªâ c·ªông th√™m n·∫øu ch∆∞a c√≥ ph·∫ßn h/m/s ri√™ng l·∫ª ho·∫∑c l√† ph·∫ßn duy nh·∫•t
                    // N·∫øu c√≥ c·∫£ "1h" v√† "10:20:30", ∆∞u ti√™n "10:20:30" n·∫øu n√≥ ƒë·ª©ng sau?
                    // ƒê∆°n gi·∫£n h√≥a: c·ªông d·ªìn n·∫øu c√≥ timeMatch
                    totalMs += (hours * 60 * 60 * 1000) + (minutes * 60 * 1000) + (seconds * 1000);
                    valid = true;
                } else {
                    // Th·ªùi gian kh√¥ng h·ª£p l·ªá (v√≠ d·ª•: 25:70:90)
                    if (!valid) return null; // N·∫øu ch·ªâ c√≥ time kh√¥ng h·ª£p l·ªá th√¨ tr·∫£ v·ªÅ null
                }
            }

            // ƒê·∫∑c bi·ªát x·ª≠ l√Ω tr∆∞·ªùng h·ª£p ch·ªâ c√≥ d·∫°ng HH:MM:SS m√† kh√¥ng c√≥ d/h/m/s
            if (!dayMatch && !hourMatch && !minMatch && !secMatch && timeMatch && valid) {
                // ƒê√£ t√≠nh ·ªü tr√™n
            } else if (!valid) {
                // N·∫øu kh√¥ng kh·ªõp b·∫•t k·ª≥ ƒë·ªãnh d·∫°ng n√†o
                return null;
            }


            return totalMs > 0 ? totalMs : null;
        }
        function calculateTimeBase() {
            // L·∫•y gi√° tr·ªã t·ª´ c√°c input
            const days = parseInt(document.getElementById('daysInput').value) || 0;
            const hours = parseInt(document.getElementById('hoursInput').value) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value) || 0;
            const seconds = parseInt(document.getElementById('secondsInput').value) || 0;

            // T√≠nh t·ªïng th·ªùi gian theo mili gi√¢y
            const totalMs = (days * 24 * 60 * 60 * 1000) +
                (hours * 60 * 60 * 1000) +
                (minutes * 60 * 1000) +
                (seconds * 1000);

            if (totalMs <= 0) {
                alert("Vui l√≤ng nh·∫≠p th·ªùi gian l·ªõn h∆°n 0");
                return;
            }

            // T√≠nh th·ªùi ƒëi·ªÉm k·∫øt th√∫c
            const now = new Date();
            const endTime = new Date(now.getTime() + totalMs);

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const displayElement = document.getElementById('countdownDisplay');

            // ƒê·ªãnh d·∫°ng ng√†y th√°ng
            const day = String(endTime.getDate()).padStart(2, '0');
            const month = String(endTime.getMonth() + 1).padStart(2, '0');
            const year = endTime.getFullYear();
            const hoursStr = String(endTime.getHours()).padStart(2, '0');
            const minutesStr = String(endTime.getMinutes()).padStart(2, '0');
            const secondsStr = String(endTime.getSeconds()).padStart(2, '0');

            displayElement.innerHTML = `
        <div style="font-weight: bold; color: var(--primary-color);">
            Th·ªùi gian k·∫øt th√∫c: ${day}/${month}/${year} ${hoursStr}:${minutesStr}:${secondsStr}
        </div>
        <div style="margin-top: 5px; font-size: 0.9em;">
            (${formatDuration(totalMs / 1000)} t·ª´ b√¢y gi·ªù)
        </div>
    `;
        }

        function formatDuration(totalSeconds) {
            totalSeconds = Math.round(totalSeconds);

            const days = Math.floor(totalSeconds / 86400);
            totalSeconds %= 86400;
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            let parts = [];
            if (days > 0) parts.push(`${days} ng√†y`);
            if (hours > 0) parts.push(`${hours} gi·ªù`);
            if (minutes > 0) parts.push(`${minutes} ph√∫t`);
            if (seconds > 0 || parts.length === 0) parts.push(`${seconds} gi√¢y`);

            return parts.join(' ');
        }



        // === K·∫æT TH√öC TH√äM M·ªöI ===

        function exportMissingIdsToTxt() {
            if (!processedData || processedData.length === 0) {
                alert("Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc.");
                return;
            }

            const compensationValue = parseInt(document.getElementById('compensationValueInput')?.value) || 5;
            const missingIds = processedData
                .filter(item => item.status === 'missing')
                .map(item => ({
                    id: item.id,
                    debt: (item.target - item.points) + compensationValue // L·∫•y gi√° tr·ªã t·ª´ logic c·ªôt "B√π"
                }));

            if (missingIds.length === 0) {
                alert("Kh√¥ng c√≥ ID n√†o ·ªü tr·∫°ng th√°i 'Thi·∫øu' ƒë·ªÉ xu·∫•t.");
                return;
            }

            // T·∫°o n·ªôi dung file CSV
            const csvContent = "User ID,S·ªë qu√°i c·∫ßn b√π\n" +
                missingIds.map(item => `${item.id},${item.debt}`).join('\n');

            // L·∫•y ng√†y hi·ªán t·∫°i v√† ƒë·ªãnh d·∫°ng t√™n file
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
            const year = today.getFullYear();
            const fileName = `${day}-${month}-${year}.txt`;

            const blob = new Blob([csvContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);
            console.log(`ƒê√£ xu·∫•t file ${fileName}`);
        }

        function runDebtCheck() {
            const fileInput = document.getElementById('debtCheckFile');

            if (fileInput.files.length === 0) {
                alert("Vui l√≤ng ch·ªçn file TXT ch·ª©a th√¥ng tin n·ª£.");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const fileContent = e.target.result;
                const debtData = parseDebtData(fileContent);
                if (debtData) {
                    displayDebtResults(debtData);
                } else {
                    alert("L·ªói: ƒê·ªãnh d·∫°ng file TXT kh√¥ng h·ª£p l·ªá.");
                }
            };

            reader.readAsText(file);
        }

        function parseDebtData(fileContent) {
            const lines = fileContent.trim().split('\n');
            if (lines.length < 2) return null; // √çt nh·∫•t ph·∫£i c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu

            const header = lines.shift().trim();
            if (header !== "User ID,S·ªë qu√°i c·∫ßn b√π") return null; // Ki·ªÉm tra header

            const debtData = [];
            for (const line of lines) {
                const [id, debt] = line.trim().split(',');
                if (!id || !debt || isNaN(parseInt(debt))) return null; // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
                debtData.push({ id: id.trim(), debt: parseInt(debt) });
            }
            return debtData;
        }

        function displayDebtResults(debtData) {
            const resultsContainer = document.getElementById('debtCheckResults');
            resultsContainer.innerHTML = '';

            if (!debtData || debtData.length === 0) {
                resultsContainer.innerHTML = '<p class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu n·ª£.</p>';
                return;
            }

            // L·∫•y d·ªØ li·ªáu ng∆∞·ªùi ch∆°i t·ª´ processedData (ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ file Excel)
            if (!processedData || processedData.length === 0) {
                resultsContainer.innerHTML = '<p class="empty">Vui l√≤ng t·∫£i file Excel ch·ª©a d·ªØ li·ªáu ng∆∞·ªùi ch∆°i tr∆∞·ªõc.</p>';
                return;
            }

            const results = debtData.map(debtItem => {
                const user = processedData.find(u => String(u.id) === String(debtItem.id));
                if (user) {
                    const currentDebt = Math.max(0, user.target - user.points);
                    const newTotalTarget = debtItem.debt + 56; // C·ªông th√™m 56 v√†o s·ªë n·ª£
                    const newRemainingDebt = Math.max(0, newTotalTarget - user.points);
                    return {
                        id: user.id,
                        name: user.name,
                        status: newRemainingDebt <= 0 ? "ƒê√É ƒê·ª¶" : `C√íN N·ª¢ ${newRemainingDebt}`,
                        points: user.points,
                        required: newTotalTarget
                    };
                } else {
                    return { id: debtItem.id, name: '', status: "Kh√¥ng t√¨m th·∫•y", points: 0, required: 0 };
                }
            });

            // S·∫Øp x·∫øp k·∫øt qu·∫£ theo th·ª© t·ª±: N·ª£ -> ƒê·ªß -> Kh√¥ng t√¨m th·∫•y
            results.sort((a, b) => {
                const getPriority = (status) => {
                    if (status.startsWith("C√íN N·ª¢")) {
                        return 1; // ∆Øu ti√™n cao nh·∫•t
                    }
                    if (status.startsWith("ƒê√É ƒê·ª¶")) {
                        return 2; // ∆Øu ti√™n th·ª© hai
                    }
                    if (status === "Kh√¥ng t√¨m th·∫•y") {
                        return 3; // ∆Øu ti√™n th·∫•p nh·∫•t
                    }
                    return 4; // M·∫∑c ƒë·ªãnh
                };
                return getPriority(a.status) - getPriority(b.status);
            });

            let tableHtml = `
         <div class="table-responsive">
             <table>
                 <thead>
                     <tr>
                         <th class="stt-column">STT</th>
                         <th class="id-column">ID</th>
                         <th class="name-column">T√™n</th>
                         <th class="debt-status-col">Tr·∫°ng th√°i</th>
                         <th class="points-column">ƒêi·ªÉm sƒÉn</th>
                         <th class="required-column">Y√™u c·∫ßu</th>
                     </tr>
                 </thead>
                 <tbody>`;

            results.forEach((item, index) => {
                const statusClass = item.status === "Kh√¥ng t√¨m th·∫•y" ? "debt-status-not-found" : (item.status.startsWith("ƒê√É ƒê·ª¶") ? "debt-status-sufficient" : "debt-status-in-debt");
                tableHtml += `
                     <tr>
                         <td class="stt-column">${index + 1}</td>
                         <td class="id-column">${item.id}</td>
                         <td class="name-column">${item.name || ''}</td>
                         <td class="${statusClass}">${item.status}</td>
                         <td class="points-column">${item.points || 0}</td>
                         <td class="required-column">${item.required || 0}</td>
                     </tr>`;
            });

            tableHtml += `
                 </tbody>
             </table>
         </div>`;
            resultsContainer.innerHTML = tableHtml;
        }

        // === TH√äM M·ªöI: Ch·ª©c nƒÉng t√≠nh Hell Event ===
        function toggleHellOptions() {
            const eventType = document.getElementById('hellEventType').value;
            const troopOptionsDiv = document.getElementById('troopOptions');
            const pactOptionsDiv = document.getElementById('pactOptions');
            const pactSpeedOptionsDiv = document.getElementById('pactSpeedOptions');
            const troopExtraOptionsDiv = document.getElementById('troopExtraOptions');

            pactOptionsDiv.style.display = 'none';
            troopOptionsDiv.style.display = 'none';
            pactSpeedOptionsDiv.style.display = 'none';
            troopExtraOptionsDiv.style.display = 'none';

            if (eventType === 'troop') {
                troopOptionsDiv.style.display = 'flex';
                troopExtraOptionsDiv.style.display = 'flex';
                troopOptionsDiv.style.display = 'flex'; // D√πng flex ƒë·ªÉ cƒÉn ch·ªânh
                troopOptionsDiv.style.justifyContent = 'center';
            } else if (eventType === 'pact') {
                pactOptionsDiv.style.display = 'flex';
                pactOptionsDiv.style.justifyContent = 'center';
                pactSpeedOptionsDiv.style.display = 'flex';
                pactSpeedOptionsDiv.style.justifyContent = 'center';
            }
        }

        function calculateHellEvent() {
            const eventType = document.getElementById('hellEventType').value;
            const targetPointsInput = document.getElementById('hellPointsTarget');
            const resultsDiv = document.getElementById('hellResults');

            const targetPoints = parseInt(targetPointsInput.value);

            if (isNaN(targetPoints) || targetPoints <= 0) {
                alert("Vui l√≤ng nh·∫≠p m·ªôt s·ªë ƒëi·ªÉm h·ª£p l·ªá.");
                return;
            }

            let resultHtml = '';
            let results;

            switch (eventType) {
                case 'pact':
                    const selectedPacts = Array.from(document.querySelectorAll('.pact-option:checked')).map(cb => cb.value);
                    if (selectedPacts.length === 0) {
                        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt lo·∫°i kh·∫ø ƒë·ªÉ t√≠nh to√°n.");
                        return;
                    }
                    const pactSpeed = parseFloat(document.getElementById('pactSpeed').value);
                    if (isNaN(pactSpeed)) {
                        alert("Vui l√≤ng nh·∫≠p t·ªëc ƒë·ªô k·∫øt h·ª£p h·ª£p l·ªá.");
                        return;
                    }
                    results = calculatePactHell(targetPoints, selectedPacts, pactSpeed);
                    resultHtml = `
                    <h3>K·∫øt qu·∫£ t·ªëi ∆∞u cho ${targetPoints.toLocaleString('vi-VN')} ƒëi·ªÉm (Hell Kh·∫ø ∆Ø·ªõc):</h3>
                    <ul>
                        ${results.pact4 > 0 ? `<li><strong>Kh·∫ø ∆Ø·ªõc 4 (9,000 ƒëi·ªÉm):</strong> ${results.pact4.toLocaleString('vi-VN')} c√°i</li>` : ''}
                        ${results.pact3 > 0 ? `<li><strong>Kh·∫ø ∆Ø·ªõc 3 (4,800 ƒëi·ªÉm):</strong> ${results.pact3.toLocaleString('vi-VN')} c√°i</li>` : ''}
                        ${results.pact2 > 0 ? `<li><strong>Kh·∫ø ∆Ø·ªõc 2 (2,400 ƒëi·ªÉm):</strong> ${results.pact2.toLocaleString('vi-VN')} c√°i</li>` : ''}
                        ${results.pact1 > 0 ? `<li><strong>Kh·∫ø ∆Ø·ªõc 1 (1,200 ƒëi·ªÉm):</strong> ${results.pact1.toLocaleString('vi-VN')} c√°i</li>` : ''}
                    </ul>
                    <p style="font-style: italic; font-size: 13px; color: #666;">
                        T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${results.totalPointsAchieved.toLocaleString('vi-VN')}<br>
                        <strong>‚è≥ Th·ªùi gian ho√†n th√†nh: ${formatDuration(results.totalTime)}</strong><br>
                        <strong>üíé Chi ph√≠ Gem (∆∞·ªõc t√≠nh): ${results.totalGems.toLocaleString('vi-VN')}</strong>
                    </p>
                `;
                    break;
                case 'maze':
                    results = calculateMazeHell(targetPoints);
                    resultHtml = `
                    <h3>K·∫øt qu·∫£ cho ${targetPoints.toLocaleString('vi-VN')} ƒëi·ªÉm (Hell M√™ H·ªìn Tr·∫≠n):</h3>
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <h4>Ch·ªâ d√πng Qu√°i v·∫≠t ∆∞u vi·ªát (6,000 ƒëi·ªÉm):</h4>
                        <ul>
                            <li><strong>S·ªë l·∫ßn ƒë√°nh:</strong> ${results.eliteOnly.count.toLocaleString('vi-VN')}</li>
                            <li><strong>T·ªïng Sao Th√°nh c·∫ßn d√πng:</strong> ${results.eliteOnly.stars.toLocaleString('vi-VN')}</li>
                        </ul>
                        <p style="font-style: italic; font-size: 13px; color: #666;">
                            T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${results.eliteOnly.points.toLocaleString('vi-VN')}
                        </p>
                    </div>
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <h4>Ch·ªâ d√πng Qu√°i v·∫≠t b√¨nh th∆∞·ªùng (200 ƒëi·ªÉm):</h4>
                        <ul>
                            <li><strong>S·ªë l·∫ßn ƒë√°nh:</strong> ${results.normalOnly.count.toLocaleString('vi-VN')}</li>
                            <li><strong>T·ªïng Sao Th√°nh c·∫ßn d√πng:</strong> ${results.normalOnly.stars.toLocaleString('vi-VN')}</li>
                        </ul>
                        <p style="font-style: italic; font-size: 13px; color: #666;">
                            T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${results.normalOnly.points.toLocaleString('vi-VN')}
                        </p>
                    </div>
                `;
                    break;
                case 'troop':
                    const selectedTiers = Array.from(document.querySelectorAll('.troop-option:checked')).map(cb => cb.value);
                    if (selectedTiers.length === 0) {
                        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt lo·∫°i l√≠nh ƒë·ªÉ t√≠nh to√°n.");
                        return;
                    }
                    // ƒê·ªçc c√°c t√πy ch·ªçn m·ªõi
                    const t4Type = document.getElementById('t4TroopType').value;
                    const trainingSpeed = parseFloat(document.getElementById('trainingSpeed').value);
                    if (isNaN(trainingSpeed)) {
                        alert("Vui l√≤ng nh·∫≠p T·ªëc ƒë·ªô hu·∫•n luy·ªán h·ª£p l·ªá.");
                        return;
                    }

                    results = calculateTroopHell(targetPoints, selectedTiers);

                    // T√≠nh to√°n chi ph√≠ t√†i nguy√™n v√† th·ªùi gian cho t·∫•t c·∫£ c√°c lo·∫°i l√≠nh
                    let totalBaseTimeSeconds = 0;
                    const resources = { food: 0, wood: 0, stone: 0, ore: 0, gold: 0 };

                    const baseTimes = { t4: 120, t3: 48, t2: 30, t1: 6 };
                    const resourceCosts = {
                        t4: { rss: 700, gold: 350 },
                        t3: { rss: 350, gold: 175 },
                        t2: { rss: 60, gold: 3 },
                        t1: { rss: 50, gold: 25 }
                    };

                    for (const tier of ['t4', 't3', 't2', 't1']) {
                        const count = results[tier];
                        if (count > 0) {
                            // T√≠nh t·ªïng th·ªùi gian c∆° b·∫£n
                            totalBaseTimeSeconds += count * baseTimes[tier];

                            // T√≠nh t·ªïng t√†i nguy√™n
                            const cost = resourceCosts[tier];
                            resources.gold += count * cost.gold;

                            switch (t4Type) { // D√πng chung lo·∫°i l√≠nh cho t·∫•t c·∫£ c√°c tier
                                case 'archer': // Cung: L√∫a, ƒê√°, G·ªó
                                    resources.food += count * cost.rss;
                                    resources.stone += count * cost.rss;
                                    resources.wood += count * cost.rss;
                                    break;
                                case 'cavalry': // K·ªµ: L√∫a, ƒê√°, Qu·∫∑ng
                                    resources.food += count * cost.rss;
                                    resources.stone += count * cost.rss;
                                    resources.ore += count * cost.rss;
                                    break;
                                case 'infantry': // B·ªô: L√∫a, G·ªó, Qu·∫∑ng
                                    resources.food += count * cost.rss;
                                    resources.wood += count * cost.rss;
                                    resources.ore += count * cost.rss;
                                    break;
                            }
                        }
                    }

                    const finalTimeSeconds = totalBaseTimeSeconds / (1 + trainingSpeed / 100);

                    resultHtml = `
                    <h3>K·∫øt qu·∫£ t·ªëi ∆∞u cho ${targetPoints.toLocaleString('vi-VN')} ƒëi·ªÉm (Hell L√≠nh):</h3>
                    <ul>
                        ${results.t4 > 0 ? `<li><strong>L√≠nh T4 (15 ƒëi·ªÉm):</strong> ${results.t4.toLocaleString('vi-VN')}</li>` : ''}
                        ${results.t3 > 0 ? `<li><strong>L√≠nh T3 (5 ƒëi·ªÉm):</strong> ${results.t3.toLocaleString('vi-VN')}</li>` : ''}
                        ${results.t2 > 0 ? `<li><strong>L√≠nh T2 (2 ƒëi·ªÉm):</strong> ${results.t2.toLocaleString('vi-VN')}</li>` : ''}
                        ${results.t1 > 0 ? `<li><strong>L√≠nh T1 (1 ƒëi·ªÉm):</strong> ${results.t1.toLocaleString('vi-VN')}</li>` : ''}
                    </ul>
                    <p style="font-style: italic; font-size: 13px; color: #666;">
                        T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${results.totalPointsAchieved.toLocaleString('vi-VN')}<br>
                        <strong>T·ªïng s·ª©c m·∫°nh tƒÉng th√™m: ${results.totalMightGained.toLocaleString('vi-VN')}</strong>
                    </p>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h4>T·ªïng chi ph√≠ ∆∞·ªõc t√≠nh:</h4>
                        <p><strong>‚è±Ô∏è TƒÉng t·ªëc c·∫ßn d√πng:</strong> ${formatDuration(finalTimeSeconds)}</p>
                        <ul>
                            ${resources.food > 0 ? `<li><strong>L√∫a:</strong> ${resources.food.toLocaleString('vi-VN')}</li>` : ''}
                            ${resources.wood > 0 ? `<li><strong>G·ªó:</strong> ${resources.wood.toLocaleString('vi-VN')}</li>` : ''}
                            ${resources.stone > 0 ? `<li><strong>ƒê√°:</strong> ${resources.stone.toLocaleString('vi-VN')}</li>` : ''}
                            ${resources.ore > 0 ? `<li><strong>Qu·∫∑ng:</strong> ${resources.ore.toLocaleString('vi-VN')}</li>` : ''}
                            ${resources.gold > 0 ? `<li><strong>V√†ng:</strong> ${resources.gold.toLocaleString('vi-VN')}</li>` : ''}
                        </ul>
                    </div>
                `;
                    break;
            }

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = resultHtml;
        }

        function formatDuration(totalSeconds) {
            if (totalSeconds <= 0) return "0 gi√¢y";

            totalSeconds = Math.round(totalSeconds);

            const days = Math.floor(totalSeconds / 86400);
            totalSeconds %= 86400;
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            let parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${String(hours).padStart(2, '0')}h`);
            if (minutes > 0) parts.push(`${String(minutes).padStart(2, '0')}m`);
            if (seconds > 0 || parts.length === 0) parts.push(`${String(seconds).padStart(2, '0')}s`);

            return parts.join(' ');
        }

        function calculateGemsForTime(seconds) {
            if (seconds <= 0) return 0;

            // Data points: [time_in_seconds, gem_cost] sorted by time
            const dataPoints = [
                [2200, 198],      // Based on 1xP2 or 2xP1
                [16494, 822],     // Based on 15xP1
                [17594, 865],     // Based on 3xP4
                [32988, 1417],    // Based on 15xP2
                [54979, 2031],    // Based on 15xP3
                [87966, 3053]     // Based on 15xP4
            ];

            // Handle extrapolation for values smaller than the first point
            if (seconds < dataPoints[0][0]) {
                const rate = dataPoints[0][1] / dataPoints[0][0]; // gems per second for the first segment
                return Math.ceil(seconds * rate);
            }

            // Find the two points to interpolate between
            for (let i = 0; i < dataPoints.length - 1; i++) {
                const p1 = dataPoints[i];
                const p2 = dataPoints[i + 1];
                if (seconds >= p1[0] && seconds <= p2[0]) {
                    // Linear interpolation: y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)
                    const gems = p1[1] + (seconds - p1[0]) * (p2[1] - p1[1]) / (p2[0] - p1[0]);
                    return Math.ceil(gems);
                }
            }

            // Handle extrapolation for values larger than the last point
            const lastPoint = dataPoints[dataPoints.length - 1];
            const secondLastPoint = dataPoints[dataPoints.length - 2];
            const lastRate = (lastPoint[1] - secondLastPoint[1]) / (lastPoint[0] - secondLastPoint[0]);
            const gems = lastPoint[1] + (seconds - lastPoint[0]) * lastRate;
            return Math.ceil(gems);
        }

        function calculatePactHell(targetPoints, selectedPacts, speedPercent) {
            const pactValues = {
                // Base times recalculated based on user's data to match 391.1% speed
                pact4: { points: 9000, baseTime: 28800 }, // ~5864s @ 391.1% -> 28800 base
                pact3: { points: 4800, baseTime: 18000 }, // ~3665s @ 391.1% -> 18000 base
                pact2: { points: 2400, baseTime: 10800 }, // ~2200s @ 391.1% -> 10800 base
                pact1: { points: 1200, baseTime: 5400 }  // ~1100s @ 391.1% -> 5400 base
            };

            let remainingPoints = targetPoints;
            const counts = { pact4: 0, pact3: 0, pact2: 0, pact1: 0 };

            const pactsInOrder = ['pact4', 'pact3', 'pact2', 'pact1'];

            pactsInOrder.forEach(pact => {
                if (selectedPacts.includes(pact)) {
                    const pactPointValue = pactValues[pact].points;
                    const lowestSelectedPact = pactsInOrder.filter(p => selectedPacts.includes(p)).pop();

                    if (pact === lowestSelectedPact && remainingPoints > 0) {
                        counts[pact] = Math.ceil(remainingPoints / pactPointValue);
                        remainingPoints = 0;
                    } else {
                        counts[pact] = Math.floor(remainingPoints / pactPointValue);
                        remainingPoints %= pactPointValue;
                    }
                }
            });

            const totalBaseTime = (counts.pact4 * pactValues.pact4.baseTime) + (counts.pact3 * pactValues.pact3.baseTime) + (counts.pact2 * pactValues.pact2.baseTime) + (counts.pact1 * pactValues.pact1.baseTime);
            const finalTimeInSeconds = totalBaseTime / (1 + (speedPercent / 100));
            const totalPointsAchieved = (counts.pact4 * pactValues.pact4.points) + (counts.pact3 * pactValues.pact3.points) + (counts.pact2 * pactValues.pact2.points) + (counts.pact1 * pactValues.pact1.points);
            const totalGems = calculateGemsForTime(finalTimeInSeconds);

            return { ...counts, totalPointsAchieved, totalTime: finalTimeInSeconds, totalGems };
        }

        function calculateMazeHell(targetPoints) {
            const mazeValues = {
                elite: { points: 6000, stars: 1000 },
                normal: { points: 200, stars: 100 }
            };

            // K·ªãch b·∫£n 1: Ch·ªâ d√πng Qu√°i v·∫≠t ∆∞u vi·ªát
            const eliteCount = Math.ceil(targetPoints / mazeValues.elite.points);
            const elitePointsAchieved = eliteCount * mazeValues.elite.points;
            const eliteStars = eliteCount * mazeValues.elite.stars;

            // K·ªãch b·∫£n 2: Ch·ªâ d√πng Qu√°i v·∫≠t b√¨nh th∆∞·ªùng
            const normalCount = Math.ceil(targetPoints / mazeValues.normal.points);
            const normalPointsAchieved = normalCount * mazeValues.normal.points;
            const normalStars = normalCount * mazeValues.normal.stars;

            return {
                eliteOnly: {
                    count: eliteCount,
                    points: elitePointsAchieved,
                    stars: eliteStars
                },
                normalOnly: {
                    count: normalCount,
                    points: normalPointsAchieved,
                    stars: normalStars
                }
            };
        }

        function calculateTroopHell(targetPoints, selectedTiers) {
            const troopValues = {
                t4: { points: 15, might: 36 },
                t3: { points: 5, might: 24 },
                t2: { points: 2, might: 8 },
                t1: { points: 1, might: 2 }
            };

            let remainingPoints = targetPoints;
            const counts = { t4: 0, t3: 0, t2: 0, t1: 0 };

            const tiersInOrder = ['t4', 't3', 't2', 't1'];

            tiersInOrder.forEach((tier, index) => {
                // Ch·ªâ t√≠nh to√°n n·∫øu tier n√†y ƒë∆∞·ª£c ch·ªçn
                if (selectedTiers.includes(tier)) {
                    const tierValue = troopValues[tier].points;

                    // N·∫øu l√† tier cu·ªëi c√πng trong danh s√°ch ƒë∆∞·ª£c ch·ªçn, ph·∫£i l√†m tr√≤n l√™n
                    const isLastSelectedTier = selectedTiers.indexOf(tier) === selectedTiers.length - 1;

                    if (isLastSelectedTier && remainingPoints > 0) {
                        counts[tier] = Math.ceil(remainingPoints / tierValue);
                        remainingPoints = 0; // ƒê√£ x·ª≠ l√Ω xong
                    } else {
                        counts[tier] = Math.floor(remainingPoints / tierValue);
                        remainingPoints %= tierValue;
                    }
                }
            });

            const totalPointsAchieved = (counts.t4 * troopValues.t4.points) +
                (counts.t3 * troopValues.t3.points) +
                (counts.t2 * troopValues.t2.points) +
                (counts.t1 * troopValues.t1.points);

            const totalMightGained = (counts.t4 * troopValues.t4.might) +
                (counts.t3 * troopValues.t3.might) +
                (counts.t2 * troopValues.t2.might) +
                (counts.t1 * troopValues.t1.might);

            return { ...counts, totalPointsAchieved, totalMightGained };
        }

        function calculateEnergy() {
            const getVal = (id) => parseInt(document.getElementById(id).value) || 0;

            const energyItems = {
                '1k': { count: getVal('energy1k'), energy: 1000, gems: 250 },
                '2k': { count: getVal('energy2k'), energy: 2000, gems: 475 },
                '5k': { count: getVal('energy5k'), energy: 5000, gems: 1125 },
                '10k': { count: getVal('energy10k'), energy: 10000, gems: 2000 },
                '20k': { count: getVal('energy20k'), energy: 20000, gems: 3500 }, // ƒê√£ ƒëi·ªÅu ch·ªânh t·ª´ 35000
                '50k': { count: getVal('energy50k'), energy: 50000, gems: 7500 }
            };

            let totalEnergy = 0;
            let totalGems = 0;

            for (const key in energyItems) {
                const item = energyItems[key];
                totalEnergy += item.count * item.energy;
                totalGems += item.count * item.gems;
            }

            const resultsDiv = document.getElementById('energyResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
            <div style="color: var(--primary-color);">T·ªïng nƒÉng l∆∞·ª£ng: ${totalEnergy.toLocaleString('vi-VN')}</div>
            <div style="color: var(--success-color); margin-top: 10px;">Quy ƒë·ªïi th√†nh: ${totalGems.toLocaleString('vi-VN')} <img src="//statics.igg.com/game/lo/images/project/game_tool/default/baobing-icon-7.jpg"></div>
        `;
        }

        // === TH√äM M·ªöI: Ch·ª©c nƒÉng B·∫£ng X·∫øp H·∫°ng N·∫°p ===
        function displayPurchaseLeaderboard() {
            const resultsContainer = document.getElementById('purchaseLeaderboardResults');
            if (!rawExcelData || rawExcelData.length < 2) {
                resultsContainer.innerHTML = '<p class="empty">Vui l√≤ng t·∫£i file Excel ƒë·ªÉ xem b·∫£ng x·∫øp h·∫°ng.</p>';
                return;
            }

            // 1. T√¨m ch·ªâ s·ªë c√°c c·ªôt
            const headers = rawExcelData[0].map(h => String(h).trim().toLowerCase());
            const colIndex = {
                name: headers.indexOf("name"),
                l1: headers.indexOf("l1 (purchase)"),
                l2: headers.indexOf("l2 (purchase)"),
                l3: headers.indexOf("l3 (purchase)"),
                l4: headers.indexOf("l4 (purchase)"),
                l5: headers.indexOf("l5 (purchase)")
            };

            // Ki·ªÉm tra xem t·∫•t c·∫£ c√°c c·ªôt c·∫ßn thi·∫øt c√≥ t·ªìn t·∫°i kh√¥ng
            if (Object.values(colIndex).some(index => index === -1)) {
                resultsContainer.innerHTML = '<p class="empty">L·ªói: File Excel thi·∫øu c√°c c·ªôt c·∫ßn thi·∫øt (name, L1-L5 (Purchase)).</p>';
                console.warn("Kh√¥ng t√¨m th·∫•y t·∫•t c·∫£ c√°c c·ªôt Purchase c·∫ßn thi·∫øt.");
                return;
            }

            // 2. X·ª≠ l√Ω d·ªØ li·ªáu
            let leaderboard = [];
            let anonymousBox = null;

            for (let i = 1; i < rawExcelData.length; i++) {
                const row = rawExcelData[i];
                if (!row || row.length === 0) continue;

                const name = row[colIndex.name] || '';
                const l1 = parseInt(row[colIndex.l1]) || 0;
                const l2 = parseInt(row[colIndex.l2]) || 0;
                const l3 = parseInt(row[colIndex.l3]) || 0;
                const l4 = parseInt(row[colIndex.l4]) || 0;
                const l5 = parseInt(row[colIndex.l5]) || 0;

                const totalDiamonds = (l1 * 200) + (l2 * 499) + (l3 * 1999) + (l4 * 4999) + (l5 * 9999);

                if (totalDiamonds > 0) {
                    if (String(name).trim().toLowerCase() === 'anonymous') {
                        anonymousBox = {
                            name: 'H·ªôp ·∫®n Danh',
                            diamonds: totalDiamonds,
                            l1, l2, l3, l4, l5 // L∆∞u l·∫°i chi ti·∫øt
                        };
                    } else if (name) {
                        leaderboard.push({
                            name: name, diamonds: totalDiamonds, l1, l2, l3, l4, l5
                        });
                    }
                }
            }

            // 3. S·∫Øp x·∫øp b·∫£ng x·∫øp h·∫°ng
            leaderboard.sort((a, b) => b.diamonds - a.diamonds);

            // 4. T·∫°o HTML ƒë·ªÉ hi·ªÉn th·ªã
            let html = '';

            if (anonymousBox) {
                html += `
                    <div class="anonymous-box-item">
                        <div>
                            <div class="name">${anonymousBox.name}</div>
                            <div class="stat-value" style="margin: 5px 0;">${anonymousBox.diamonds.toLocaleString('vi-VN')} üíé</div>
                            <div class="stat-label">T·ªïng Kim C∆∞∆°ng Xanh</div>
                        </div>
                        <div class="purchase-details">
                            ${anonymousBox.l1 > 0 ? `<span>L1: <strong>${anonymousBox.l1}</strong></span>` : ''}
                            ${anonymousBox.l2 > 0 ? `<span>L2: <strong>${anonymousBox.l2}</strong></span>` : ''}
                            ${anonymousBox.l3 > 0 ? `<span>L3: <strong>${anonymousBox.l3}</strong></span>` : ''}
                            ${anonymousBox.l4 > 0 ? `<span>L4: <strong>${anonymousBox.l4}</strong></span>` : ''}
                            ${anonymousBox.l5 > 0 ? `<span>L5: <strong>${anonymousBox.l5}</strong></span>` : ''}
                        </div>
                    </div>
                `;
            }

            if (leaderboard.length > 0) {
                html += `<div class="table-responsive"><table><thead><tr><th class="stt-column">STT</th><th class="name-column">T√™n</th><th class="kcx-column">T·ªïng KCX</th><th class="level-column">L1</th><th class="level-column">L2</th><th class="level-column">L3</th><th class="level-column">L4</th><th class="level-column">L5</th></tr></thead><tbody>
                    ${leaderboard.map((player, index) => `
                        <tr>
                            <td class="stt-column">${index + 1}</td>
                            <td class="name-column">${player.name}</td>
                            <td class="kcx-column"><strong>${player.diamonds.toLocaleString('vi-VN')} üíé</strong></td>
                            <td class="level-column">${player.l1 > 0 ? player.l1 : '-'}</td>
                            <td class="level-column">${player.l2 > 0 ? player.l2 : '-'}</td>
                            <td class="level-column">${player.l3 > 0 ? player.l3 : '-'}</td>
                            <td class="level-column">${player.l4 > 0 ? player.l4 : '-'}</td>
                            <td class="level-column">${player.l5 > 0 ? player.l5 : '-'}</td>
                        </tr>`).join('')}
                </tbody></table></div>`;
            } else if (!anonymousBox) {
                html = '<p class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu n·∫°p ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            }

            resultsContainer.innerHTML = html;
        }
    </script>
</body>

</html>
