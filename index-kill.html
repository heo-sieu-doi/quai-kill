<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ So sánh Thống kê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            overflow-x: auto;
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upload-box {
            border: 1px solid #ddd;
            padding: 10px;
            flex: 1;
            border-radius: 4px;
        }

        .upload-box h2 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            margin-right: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.tertiary {
            background-color: #ff9800;
        }

        button.tertiary:hover {
            background-color: #e68a00;
        }

        button.quaternary {
            background-color: #deb3e5;
        }

        button.quaternary:hover {
            background-color: #7b1fa2;
        }

        table {
            border-collapse: collapse;
            /* width: 100%; */ /* Bỏ width để cột tự co giãn theo nội dung */
            margin-top: 10px;
            font-size: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 5px; /* Giảm padding cho giao diện gọn hơn */
            text-align: left; /* Căn lề trái cho tất cả các cột */
            white-space: nowrap; /* Ngăn không cho nội dung xuống dòng, giúp cột co giãn */
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        /* Style cho header nhóm */
        th[colspan] {
            text-align: left; /* Căn lề trái cho header nhóm */
            padding-left: 10px; /* Thêm khoảng đệm cho dễ nhìn */
            border-bottom: 2px solid #ccc; /* Đường kẻ dưới đậm hơn để phân tách cấp */
            border-right: 2px solid #adadad;  /* Đường kẻ phải đậm hơn để phân tách các nhóm */
            font-weight: bold;
            color: #333;
        }
        th[colspan]:last-child {
            border-right: 1px solid #ddd; /* Giữ border cho cột cuối cùng của header */
        }

        /* Thêm đường viền đậm cho cột cuối của nhóm thông tin (Rank) */
        .info-group-separator {
            border-right: 2px solid #adadad;
        }

        /* Màu nền cho từng nhóm để phân biệt rõ ràng */
        .group-might { background-color: #eaf2f8; }
        .group-kills { background-color: #e8f8f5; }
        .group-captured { background-color: #fef5e7; }
        .group-destroyed { background-color: #feebef; }
        .group-enemy-wounded { background-color: #f4ecf7; }
        .group-troops-killed { background-color: #d6eaf8; }
        .group-troops-lost { background-color: #fdedec; }
        .group-troops-wounded { background-color: #d7bde2; }
        .group-losses { background-color: #fef9e7; }
        .group-attacks { background-color: #e8f6f3; }
        .group-defenses { background-color: #eaeded; }
        .group-victories { background-color: #a9cce3; }
        .group-win-rate { background-color: #a3e4d7; }

        thead tr:last-child th {
            white-space: nowrap;
            background-color: #f8f9f9; /* Màu nền riêng cho header phụ */
        }

        .positive {
            color: green;
            font-weight: bold;
        }

        .negative {
            color: red;
            font-weight: bold;
        }

        .neutral {
            color: #666;
        }

        .no-data {
            color: #999;
            font-style: italic;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .realtime-filter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-filter input[type="checkbox"] {
            margin: 0;
        }

        .status {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .success {
            background-color: #e6ffe6;
            color: #006600;
        }

        .error {
            background-color: #ffebeb;
            color: #cc0000;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .compact-col {
            min-width: 70px;
        }

        .missing-data-row {
            background-color: #f9f9f9;
        }

        .priority-row {
            background-color: #fffacd !important;
        }

        .hidden-col {
            display: none;
        }

        .priority-input {
            margin-top: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .priority-label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .upload-box input[type="file"] {
            margin-bottom: 10px;
        }

        .url-upload-group {
            display: flex;
            gap: 5px;
        }
        .url-upload-group input[type="text"] {
            flex-grow: 1;
            width: auto; /* Override width: 100% */
        }

        /* === NEW STYLES FOR COMPARISON VIEW === */
        #comparisonViewContainer {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #9c27b0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .comparison-header h2 {
            margin: 0;
            color: #9c27b0;
            font-size: 1.5em;
        }

        .comparison-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }

        .comparison-controls label {
            font-weight: bold;
        }

        .comparison-controls select, .comparison-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .comparison-controls input[type="text"] {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }

        .priority-checkbox-list {
            max-height: 150px; /* Giới hạn chiều cao */
            overflow-y: auto;  /* Thêm thanh cuộn khi cần */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            flex-basis: 100%; /* Chiếm toàn bộ chiều rộng trong flex container */
        }

        .priority-checkbox-list label {
            display: block; /* Mỗi checkbox một dòng */
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: normal; /* Bỏ bold mặc định của label */
        }

        .priority-checkbox-list input[type="checkbox"] {
            margin-right: 5px; /* Khoảng cách giữa checkbox và label */
        }
        .priority-checkbox-list {
            max-height: 150px; /* Giới hạn chiều cao */
            overflow-y: auto;  /* Thêm thanh cuộn khi cần */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            flex-basis: 100%; /* Chiếm toàn bộ chiều rộng trong flex container */
        }

        .priority-checkbox-list label {
            display: block; /* Mỗi checkbox một dòng */
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: normal; /* Bỏ bold mặc định của label */
        }

        .priority-checkbox-list input[type="checkbox"] {
            margin-right: 5px; /* Khoảng cách giữa checkbox và label */
        }
        .priority-checkbox-list {
            max-height: 150px; /* Giới hạn chiều cao */
            overflow-y: auto;  /* Thêm thanh cuộn khi cần */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            flex-basis: 100%; /* Chiếm toàn bộ chiều rộng trong flex container */
        }

        .priority-checkbox-list label {
            display: block; /* Mỗi checkbox một dòng */
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: normal; /* Bỏ bold mặc định của label */
        }
        #comparisonResult table {
            margin-top: 0;
        }

        #comparisonResult {
            overflow-x: auto; /* Thêm cuộn ngang cho bảng trên mobile */
            -webkit-overflow-scrolling: touch; /* Cải thiện trải nghiệm cuộn trên iOS */
        }

        #comparisonResult th {
            background-color: #f5eef8;
        }

        /* === NEW STYLES FOR DETAILED VIEW === */
        #detailedViewContainer {
            margin-top: 20px;
        }

        .detailed-view-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .detailed-view-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 15px;
            gap: 10px;
        }

        .detailed-view-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }
        
        .detailed-view-header .user-id {
            font-size: 0.9em;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .detailed-view-body table {
            width: 100%;
            border-collapse: collapse;
        }

        .detailed-view-body {
            overflow-x: auto; /* Thêm cuộn ngang cho bảng trên mobile */
            -webkit-overflow-scrolling: touch; /* Cải thiện trải nghiệm cuộn trên iOS */
        }

        .detailed-view-body th, .detailed-view-body td {
            padding: 5px; /* Giảm padding cho gọn, giống bảng chính */
            border: 1px solid #ddd; /* Thêm border đầy đủ giống bảng chính */
            text-align: left; /* Căn lề trái mặc định */
            white-space: nowrap; /* Ngăn xuống dòng */
        }

        .detailed-view-body .stat-name {
            text-align: left;
            font-weight: bold;
            color: #555;
        }

        /* === MODAL STYLES FOR USER SELECTION === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .modal-header .close-button {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #888;
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        .modal-body {
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Công cụ So sánh Thống kê</h1>

        <div class="upload-section">
            <div class="upload-box">
                <h2>Dữ liệu Tháng 6</h2>
                <label for="juneFile">Tải từ máy:</label>
                <input type="file" id="juneFile" accept=".xlsx,.xls" />
                <label for="juneUrl">Hoặc tải từ URL:</label>
                <div class="url-upload-group">
                    <input type="text" id="juneUrl" placeholder="Dán link Google Sheets...">
                    <button onclick="loadFromUrl('june')" class="secondary">Tải</button>
                </div>
                <div id="juneStatus" class="status"></div>
            </div>

            <div class="upload-box">
                <h2>Dữ liệu Tháng 7</h2>
                <label for="julyFile">Tải từ máy:</label>
                <input type="file" id="julyFile" accept=".xlsx,.xls" />
                <label for="julyUrl">Hoặc tải từ URL:</label>
                <div class="url-upload-group">
                    <input type="text" id="julyUrl" placeholder="Dán link Google Sheets...">
                    <button onclick="loadFromUrl('july')" class="secondary">Tải</button>
                </div>
                <div id="julyStatus" class="status"></div>
            </div>
        </div>

        <div class="filter-controls">
            <div class="filter-section">
                <label class="priority-label">ID ưu tiên (cách nhau bằng dấu phẩy):</label>
                <input type="text" id="priorityIds" class="priority-input"
                    placeholder="Nhập các ID ưu tiên, ví dụ: 123,456,789" 
                    value="416381060,765602761,417896120,537487142,360966484"/>
                <div class="action-buttons">
                    <button onclick="applyPriorityFilter()" class="secondary">Áp dụng lọc</button>
                    <div class="realtime-filter">
                        <input type="checkbox" id="realtimeFilter" checked>
                        <label for="realtimeFilter">Lọc realtime</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="flex: 1;">
                <input type="text" id="searchInput" placeholder="Tìm theo tên hoặc ID..." />
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="searchTable()">Tìm kiếm</button>
                    <button onclick="showDetailedView()" class="secondary">Xem chi tiết</button>
                    <button onclick="showComparisonView()" class="quaternary">So sánh với Ưu tiên</button>
                    <button onclick="sortTable('killsDiff', 'asc')" class="secondary">Sắp xếp Kills (Tăng)</button>
                    <button onclick="sortTable('killsDiff', 'desc')" class="secondary">Sắp xếp Kills (Giảm)</button>
                    <button onclick="toggleIdColumn()" class="tertiary">Ẩn/Hiện ID</button>
                    <button id="exportPngBtn" onclick="exportToPNG()" class="tertiary">Xuất ảnh PNG</button>
                    <button onclick="exportToExcel()" class="quaternary">Xuất file Excel</button>
                    <button onclick="resetTable()">Đặt lại</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Đang xử lý...</p>
        </div>

        <div id="tableContainer">
            <table id="comparisonTable">
                <thead>
                    <!-- Dòng tiêu đề chính -->
                    <tr>
                        <th rowspan="2">STT</th>
                        <th rowspan="2">Tên</th>
                        <th rowspan="2" class="id-col">User ID</th>
                        <th rowspan="2" class="info-group-separator">Rank</th>
                        <th colspan="3" class="group-might">Tổng Might</th>
                        <th colspan="3" class="group-kills">Tổng Kills</th>
                        <th colspan="3" class="group-captured">Tổng Kẻ Thù Bị Bắt</th>
                        <th colspan="3" class="group-destroyed">Tổng Kẻ Thù Tiêu Diệt</th>
                        <th colspan="3" class="group-enemy-wounded">Tổng Quân Địch Bị Thương</th>
                        <th colspan="3" class="group-troops-killed">Tổng Quân Đội Đã Giết</th>
                        <th colspan="3" class="group-troops-lost">Tổng Số Quân Tổn Thất</th>
                        <th colspan="3" class="group-troops-wounded">Tổng Quân Đội Bị Thương</th>
                        <th colspan="3" class="group-losses">Tổng Thua</th>
                        <th colspan="3" class="group-attacks">Tổng Tấn công Thành công</th>
                        <th colspan="3" class="group-defenses">Tổng Phòng thủ Thành công</th>
                        <th colspan="3" class="group-victories">Tổng Chiến Thắng</th>
                        <th colspan="3" class="group-win-rate">Tổng Tỉ Lệ Chiến Thắng</th>
                    </tr>
                    <!-- Dòng tiêu đề phụ -->
                    <tr>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                        <th>Tháng 6</th><th>Tháng 7</th><th>Tổng</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dữ liệu sẽ được thêm vào đây -->
                </tbody>
            </table>
        </div>

        <!-- Container for the new comparison view -->
        <div id="comparisonViewContainer" style="display: none;"></div>

        <!-- Container for the new detailed vertical view -->
        <div id="detailedViewContainer" style="display: none;"></div>
    </div>

    <!-- Modal for user selection -->
    <div id="userSelectionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vui lòng chọn kết quả</h2>
                <button class="close-button" onclick="hideUserSelectionModal()">&times;</button>
            </div>
            <div class="modal-body" id="userSelectionList">
                <!-- User list will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục
        let juneData = {};
        let julyData = {};
        let currentData = [];
        let showIdColumn = true;
        let priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
        let realtimeFilterEnabled = true;
        let currentSort = { column: 'name', direction: 'asc' };

        // Hàm xử lý upload file
        function handleFileUpload(file, type) {
            const reader = new FileReader();
            const statusElement = document.getElementById(`${type}Status`);

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (type === 'june') {
                        juneData = processData(jsonData);
                        statusElement.textContent = `Đã tải tháng 6: ${Object.keys(juneData).length} người chơi`;
                        statusElement.className = 'status success';
                    } else {
                        julyData = processData(jsonData);
                        statusElement.textContent = `Đã tải tháng 7: ${Object.keys(julyData).length} người chơi`;
                        statusElement.className = 'status success';
                    }

                    if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                        compareData();
                    }
                } catch (error) {
                    statusElement.textContent = `Lỗi: ${error.message}`;
                    statusElement.className = 'status error';
                }
            };

            reader.onerror = function () {
                statusElement.textContent = `Lỗi đọc file`;
                statusElement.className = 'status error';
            };

            reader.readAsArrayBuffer(file);
        }

        // Hàm tải từ URL, được lấy và chỉnh sửa từ file index.html
        async function loadFromUrl(type) {
            const urlInputId = `${type}Url`;
            const statusElementId = `${type}Status`;
            const urlInput = document.getElementById(urlInputId);
            const statusElement = document.getElementById(statusElementId);

            const rawUrl = urlInput.value.trim();
            if (!rawUrl) {
                alert(`Vui lòng nhập URL cho tháng ${type === 'june' ? '6' : '7'}!`);
                return;
            }

            let exportUrl = '';
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                const sheetId = match[1];
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                exportUrl = rawUrl;
            } else {
                alert("URL không hợp lệ. Vui lòng cung cấp link Google Sheets/File hợp lệ (đã chia sẻ công khai) hoặc link trực tiếp đến file .xlsx.");
                return;
            }

            statusElement.textContent = 'Đang tải từ URL...';
            statusElement.className = 'status';
            const loading = showLoading(`Đang tải dữ liệu tháng ${type === 'june' ? '6' : '7'}...`);

            try {
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
                const fetchUrl = proxyUrl + encodeURIComponent(exportUrl);

                const response = await fetch(fetchUrl, { signal: AbortSignal.timeout(30000) });

                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status} ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !(contentType.includes('spreadsheetml.sheet') || contentType.includes('application/vnd.ms-excel') || contentType.includes('octet-stream'))) {
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();
                    if (responseText.trim().toLowerCase().startsWith('<html') || responseText.trim().toLowerCase().startsWith('<!doctype html')) {
                        throw new Error("Lỗi định dạng: Nhận được HTML thay vì file Excel. Đảm bảo link được chia sẻ công khai.");
                    }
                }

                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength < 100) {
                    throw new Error("Tải file thất bại: File nhận được quá nhỏ.");
                }

                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                const processed = processData(jsonData);
                if (type === 'june') {
                    juneData = processed;
                    statusElement.textContent = `Đã tải tháng 6 từ URL: ${Object.keys(juneData).length} người chơi`;
                    statusElement.className = 'status success';
                } else {
                    julyData = processed;
                    statusElement.textContent = `Đã tải tháng 7 từ URL: ${Object.keys(julyData).length} người chơi`;
                    statusElement.className = 'status success';
                }

                if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                    compareData();
                }
            } catch (error) {
                console.error(`Lỗi khi tải URL cho ${type}:`, error);
                statusElement.textContent = `Lỗi tải URL: ${error.message}`;
                statusElement.className = 'status error';
            } finally {
                loading.remove();
            }
        }

        // Hàm xử lý dữ liệu
        function processData(sheetData) {
            const result = {};
            let headerRowIndex = -1;

            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row && row.includes("User ID")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) throw new Error("Không tìm thấy hàng tiêu đề");

            const headers = sheetData[headerRowIndex];
            const getColIndex = (headerName) => {
                return headers.findIndex(h => h && h.toString().trim().toLowerCase() === headerName.toLowerCase());
            };

            const indices = {
                name: getColIndex("Name"),
                userId: getColIndex("User ID"),
                rank: getColIndex("Rank"),
                might: getColIndex("Might"),
                kills: getColIndex("Kills"),
                enemiesCaptured: getColIndex("Enemies captured"),
                enemiesDestroyed: getColIndex("Enemies Destroyed Might"),
                enemyWounded: getColIndex("Enemy Troops Wounded"),
                troopsKilled: getColIndex("Troops Killed"),
                troopsLost: getColIndex("Troops Lost"),
                troopsWounded: getColIndex("Troops Wounded"),
                losses: getColIndex("Losses"),
                successfulAttacks: getColIndex("Successful Attacks"),
                successfulDefenses: getColIndex("Phòng thủ thành công"),
                victories: getColIndex("Victories"),
                winRate: getColIndex("Win Rate")
            };

            for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;

                const userId = row[indices.userId];
                if (!userId) continue;

                const getValue = (index, defaultValue = 0) => {
                    if (index === -1) return defaultValue;
                    const val = row[index];
                    if (val === undefined || val === null) return defaultValue;
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string') {
                        if (indices.winRate === index && val.includes('%')) {
                            return parseFloat(val.replace(',', '.').replace('%', '')) || 0;
                        }
                        const num = parseFloat(val.replace(/[^0-9.-]/g, ''));
                        return isNaN(num) ? defaultValue : num;
                    }
                    return defaultValue;
                };

                result[userId] = {
                    name: row[indices.name] || 'Không xác định',
                    rank: row[indices.rank] || 'Không xác định',
                    might: getValue(indices.might),
                    kills: getValue(indices.kills),
                    enemies_captured: getValue(indices.enemiesCaptured),
                    enemies_destroyed: getValue(indices.enemiesDestroyed),
                    enemy_wounded: getValue(indices.enemyWounded),
                    troops_killed: getValue(indices.troopsKilled),
                    troops_lost: getValue(indices.troopsLost),
                    troops_wounded: getValue(indices.troopsWounded),
                    losses: getValue(indices.losses),
                    successful_attacks: getValue(indices.successfulAttacks),
                    successful_defenses: getValue(indices.successfulDefenses),
                    victories: getValue(indices.victories),
                    win_rate: row[indices.winRate] ? row[indices.winRate].toString() : '0%'
                };
            }

            return result;
        }

        // Hàm so sánh dữ liệu
        function compareData() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';

            setTimeout(() => {
                try {
                    const allUserIds = new Set([...Object.keys(juneData), ...Object.keys(julyData)]);
                    currentData = [];

                    Array.from(allUserIds).forEach(userId => {
                        const juneStats = juneData[userId];
                        const julyStats = julyData[userId];

                        if (!juneStats && !julyStats) return;

                        const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                        const isPriority = priorityIds.includes(userId);

                        currentData.push({
                            userId,
                            name: julyStats?.name || juneStats?.name || 'Không xác định',
                            rank: julyStats?.rank || juneStats?.rank || 'Không xác định',
                            juneStats,
                            julyStats,
                            killsDiff,
                            hasBothData: juneStats && julyStats,
                            isPriority
                        });
                    });

                    applyPriorityFilter();

                } catch (error) {
                    console.error('Lỗi khi so sánh:', error);
                } finally {
                    loadingElement.style.display = 'none';
                }
            }, 100);
        }

        // Hàm cập nhật ID ưu tiên
        function updatePriorityIds() {
            const input = document.getElementById('priorityIds').value;
            priorityIds = input.split(',')
                .map(id => id.trim())
                .filter(id => id !== '');

            currentData.forEach(item => {
                item.isPriority = priorityIds.includes(item.userId);
            });
        }

        // Hàm áp dụng bộ lọc ưu tiên
        function applyPriorityFilter() {
            updatePriorityIds();
            sortTable(currentSort.column, currentSort.direction);
        }

        // Hàm sắp xếp bảng
        function sortTable(column, direction) {
            if (!currentData.length) return;

            currentSort = { column, direction };
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const sortedData = [...currentData].sort((a, b) => {
                // Ưu tiên các ID trong danh sách priorityIds lên đầu
                if (a.isPriority && !b.isPriority) return -1;
                if (!a.isPriority && b.isPriority) return 1;
                if (a.isPriority && b.isPriority) {
                    return a.name.localeCompare(b.name);
                }

                if (column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else {
                    return direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // Hàm hiển thị dữ liệu đã sắp xếp
        function displaySortedData(sortedData) {
            const tableBody = document.getElementById('tableBody');

            sortedData.forEach((item, index) => {
                const { userId, name, rank, juneStats, julyStats, hasBothData, isPriority } = item;
                const row = document.createElement('tr');

                if (!hasBothData) row.classList.add('missing-data-row');
                if (isPriority) row.classList.add('priority-row');

                const mightDiff = calculateDifference(julyStats?.might, juneStats?.might);
                const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                const enemiesCapturedDiff = calculateDifference(julyStats?.enemies_captured, juneStats?.enemies_captured);
                const enemiesDestroyedDiff = calculateDifference(julyStats?.enemies_destroyed, juneStats?.enemies_destroyed);
                const enemyWoundedDiff = calculateDifference(julyStats?.enemy_wounded, juneStats?.enemy_wounded);
                const troopsKilledDiff = calculateDifference(julyStats?.troops_killed, juneStats?.troops_killed);
                const troopsLostDiff = calculateDifference(julyStats?.troops_lost, juneStats?.troops_lost);
                const troopsWoundedDiff = calculateDifference(julyStats?.troops_wounded, juneStats?.troops_wounded);
                const lossesDiff = calculateDifference(julyStats?.losses, juneStats?.losses);
                const successfulAttacksDiff = calculateDifference(julyStats?.successful_attacks, juneStats?.successful_attacks);
                const successfulDefensesDiff = calculateDifference(julyStats?.successful_defenses, juneStats?.successful_defenses);
                const victoriesDiff = calculateDifference(julyStats?.victories, juneStats?.victories);
                const winRateDiff = compareWinRates(julyStats?.win_rate, juneStats?.win_rate);

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td class="id-col">${userId}</td>
                    <td>${rank}</td>
                    <!-- Might -->
                    <td class="group-might-cell">${formatNumber(juneStats?.might)}</td>
                    <td class="group-might-cell">${formatNumber(julyStats?.might)}</td>
                    <td class="group-might-cell">${formatDifference(mightDiff)}</td>
                    <!-- Kills -->
                    <td class="group-kills-cell">${formatNumber(juneStats?.kills)}</td>
                    <td class="group-kills-cell">${formatNumber(julyStats?.kills)}</td>
                    <td class="group-kills-cell">${formatDifference(killsDiff)}</td>
                    <!-- Enemies Captured -->
                    <td class="group-captured-cell">${formatNumber(juneStats?.enemies_captured)}</td>
                    <td class="group-captured-cell">${formatNumber(julyStats?.enemies_captured)}</td>
                    <td class="group-captured-cell">${formatDifference(enemiesCapturedDiff)}</td>
                    <!-- Enemies Destroyed -->
                    <td class="group-destroyed-cell">${formatNumber(juneStats?.enemies_destroyed)}</td>
                    <td class="group-destroyed-cell">${formatNumber(julyStats?.enemies_destroyed)}</td>
                    <td class="group-destroyed-cell">${formatDifference(enemiesDestroyedDiff)}</td>
                    <!-- Enemy Wounded -->
                    <td class="group-enemy-wounded-cell">${formatNumber(juneStats?.enemy_wounded)}</td>
                    <td class="group-enemy-wounded-cell">${formatNumber(julyStats?.enemy_wounded)}</td>
                    <td class="group-enemy-wounded-cell">${formatDifference(enemyWoundedDiff)}</td>
                    <!-- Troops Killed -->
                    <td class="group-troops-killed-cell">${formatNumber(juneStats?.troops_killed)}</td>
                    <td class="group-troops-killed-cell">${formatNumber(julyStats?.troops_killed)}</td>
                    <td class="group-troops-killed-cell">${formatDifference(troopsKilledDiff)}</td>
                    <!-- Troops Lost -->
                    <td class="group-troops-lost-cell">${formatNumber(juneStats?.troops_lost)}</td>
                    <td class="group-troops-lost-cell">${formatNumber(julyStats?.troops_lost)}</td>
                    <td class="group-troops-lost-cell">${formatDifference(troopsLostDiff)}</td>
                    <!-- Troops Wounded -->
                    <td class="group-troops-wounded-cell">${formatNumber(juneStats?.troops_wounded)}</td>
                    <td class="group-troops-wounded-cell">${formatNumber(julyStats?.troops_wounded)}</td>
                    <td class="group-troops-wounded-cell">${formatDifference(troopsWoundedDiff)}</td>
                    <!-- Losses -->
                    <td class="group-losses-cell">${formatNumber(juneStats?.losses)}</td>
                    <td class="group-losses-cell">${formatNumber(julyStats?.losses)}</td>
                    <td class="group-losses-cell">${formatDifference(lossesDiff)}</td>
                    <!-- Successful Attacks -->
                    <td class="group-attacks-cell">${formatNumber(juneStats?.successful_attacks)}</td>
                    <td class="group-attacks-cell">${formatNumber(julyStats?.successful_attacks)}</td>
                    <td class="group-attacks-cell">${formatDifference(successfulAttacksDiff)}</td>
                    <!-- Successful Defenses -->
                    <td class="group-defenses-cell">${formatNumber(juneStats?.successful_defenses)}</td>
                    <td class="group-defenses-cell">${formatNumber(julyStats?.successful_defenses)}</td>
                    <td class="group-defenses-cell">${formatDifference(successfulDefensesDiff)}</td>
                    <!-- Victories -->
                    <td class="group-victories-cell">${formatNumber(juneStats?.victories)}</td>
                    <td class="group-victories-cell">${formatNumber(julyStats?.victories)}</td>
                    <td class="group-victories-cell">${formatDifference(victoriesDiff)}</td>
                    <!-- Win Rate -->
                    <td class="group-win-rate-cell">${juneStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
                    <td class="group-win-rate-cell">${julyStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
                    <td class="group-win-rate-cell">${winRateDiff}</td>
                `;

                tableBody.appendChild(row);
            });

            toggleIdColumn(showIdColumn);
        }

        // Các hàm tiện ích
        function formatNumber(num) {
            if (num === undefined || num === null) return '<span class="no-data">N/A</span>';
            return num.toLocaleString();
        }

        function calculateDifference(newVal, oldVal) {
            if (newVal === undefined || oldVal === undefined) return null;
            return newVal - oldVal;
        }

        function formatDifference(diff) {
            if (diff === null) return '<span class="no-data">N/A</span>';
            if (diff > 0) return `<span class="positive">+${formatNumber(diff)}</span>`;
            if (diff < 0) return `<span class="negative">${formatNumber(diff)}</span>`;
            return `<span class="neutral">0</span>`;
        }

        function compareWinRates(newRate, oldRate) {
            if (!newRate || !oldRate) return '<span class="no-data">N/A</span>';

            const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
            const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
            const diff = newNum - oldNum;

            if (diff > 0) return `<span class="positive">+${diff.toFixed(2)}%</span>`;
            if (diff < 0) return `<span class="negative">${diff.toFixed(2)}%</span>`;
            return `<span class="neutral">0%</span>`;
        }

        // Các hàm xử lý giao diện
        function searchTable() {
            // Hide detailed view when performing a general table search
            hideComparisonView();
            hideDetailedView();

            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('comparisonTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[1];
                const idCell = rows[i].getElementsByTagName('td')[2];

                if (nameCell && idCell) {
                    const nameText = nameCell.textContent || nameCell.innerText;
                    const idText = idCell.textContent || idCell.innerText;

                    if (nameText.toUpperCase().indexOf(filter) > -1 || idText.toUpperCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function toggleIdColumn() {
            const idCols = document.querySelectorAll('.id-col');
            showIdColumn = !showIdColumn;

            idCols.forEach(col => {
                if (showIdColumn) {
                    col.classList.remove('hidden-col');
                } else {
                    col.classList.add('hidden-col');
                }
            });
        }

        function hideDetailedView() {
            const container = document.getElementById('detailedViewContainer');
            if (container) container.style.display = 'none';
            
            // Only show main content if comparison view is also hidden
            if (document.getElementById('comparisonViewContainer').style.display === 'none') {
                showMainContent();
            }
        }

        function showDetailedView() {
            hideComparisonView();
            
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                // Nếu không có gì trong ô tìm kiếm, có thể người dùng muốn xem toàn bộ danh sách
                // hoặc ta nên yêu cầu họ tìm kiếm trước. Ở đây, ta yêu cầu tìm kiếm.
                alert("Vui lòng nhập Tên hoặc ID và nhấn 'Tìm kiếm' trước khi xem chi tiết.");
                return;
            }

            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const visibleUserIds = [];

            for (let i = 0; i < rows.length; i++) {
                // Một hàng được coi là hiển thị nếu style.display của nó không phải là 'none'
                if (rows[i].style.display !== 'none') {
                    // Tìm ô ID trong hàng. Giả sử ID là cột thứ 3 (index 2).
                    const idCell = rows[i].getElementsByTagName('td')[2];
                    if (idCell) {
                        visibleUserIds.push(idCell.textContent.trim());
                    }
                }
            }

            // Lấy các đối tượng người dùng đầy đủ từ currentData bằng các ID đã thu thập
            const foundUsers = currentData.filter(item => visibleUserIds.includes(item.userId));

            if (foundUsers.length === 0) {
                alert(`Không có kết quả nào đang được hiển thị cho "${searchTerm}".`);
                return;
            }

            if (foundUsers.length === 1) {
                renderDetailedView(foundUsers[0]);
            } else {
                showUserSelectionModal(foundUsers);
            }
        }


        function renderDetailedView(foundUser) {
            if (!foundUser) {
                alert(`Lỗi: Không có thông tin người dùng để hiển thị.`);
                return;
            }

            // Hide the main table and controls
            hideMainContent();
            // Prepare data for rendering
            const { userId, name, rank, juneStats, julyStats } = foundUser;
            const statMapping = {
                might: "Might",
                kills: "Kills",
                enemies_captured: "Kẻ Thù Bị Bắt",
                enemies_destroyed: "Kẻ Thù Tiêu Diệt",
                enemy_wounded: "Quân Địch Bị Thương",
                troops_killed: "Quân Đội Đã Giết",
                troops_lost: "Số Quân Tổn Thất",
                troops_wounded: "Quân Đội Bị Thương",
                losses: "Thua",
                successful_attacks: "Tấn công Thành công",
                successful_defenses: "Phòng thủ Thành công",
                victories: "Chiến Thắng",
                win_rate: "Tỉ Lệ Chiến Thắng"
            };

            let tableBodyHtml = '';
            for (const key in statMapping) {
                const statName = statMapping[key];
                const juneValue = juneStats ? juneStats[key] : undefined;
                const julyValue = julyStats ? julyStats[key] : undefined;
                
                let diffHtml;
                if (key === 'win_rate') {
                    diffHtml = compareWinRates(julyValue, juneValue);
                } else {
                    const diff = calculateDifference(julyValue, juneValue);
                    diffHtml = formatDifference(diff);
                }

                tableBodyHtml += `
                    <tr>
                        <td class="stat-name">${statName}</td>
                        <td style="text-align: right;">${key === 'win_rate' ? (juneValue || '<span class="no-data">N/A</span>') : formatNumber(juneValue)}</td>
                        <td style="text-align: right;">${key === 'win_rate' ? (julyValue || '<span class="no-data">N/A</span>') : formatNumber(julyValue)}</td>
                        <td style="text-align: right;">${diffHtml}</td>
                    </tr>
                `;
            }

            const detailedViewHtml = `
                <div class="detailed-view-card">
                    <div class="detailed-view-header">
                        <div>
                            <h2>${name}</h2>
                            <span class="user-id">ID: ${userId} | Rank: ${rank}</span>
                        </div>
                        <div>
                            <button onclick="compareThisUser('${userId}')" class="quaternary">So sánh ID này</button>
                            <button onclick="hideDetailedView()" class="tertiary">Quay lại bảng</button>
                        </div>
                    </div>
                    <div class="detailed-view-body">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Chỉ số</th>
                                    <th style="text-align: right;">Tháng 6</th>
                                    <th style="text-align: right;">Tháng 7</th>
                                    <th style="text-align: right;">Chênh lệch</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableBodyHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const container = document.getElementById('detailedViewContainer');
            container.innerHTML = detailedViewHtml;
            container.style.display = 'block';
        }

        function showUserSelectionModal(users) {
            const listContainer = document.getElementById('userSelectionList');
            listContainer.innerHTML = ''; // Clear previous results

            users.forEach(user => {
                const button = document.createElement('button');
                button.className = 'quaternary'; // Re-use button style
                button.style.width = '100%';
                button.style.marginBottom = '5px';
                button.style.textAlign = 'left';
                button.innerHTML = `<strong>${user.name}</strong> <span style="color: #666; font-size: 0.9em;">(ID: ${user.userId})</span>`;
                button.onclick = () => showSpecificUserDetail(user.userId);
                listContainer.appendChild(button);
            });

            document.getElementById('userSelectionModal').style.display = 'flex';
        }

        function hideUserSelectionModal() {
            document.getElementById('userSelectionModal').style.display = 'none';
        }

        function showSpecificUserDetail(userId) {
            const user = currentData.find(u => u.userId === userId);
            if (user) {
                renderDetailedView(user);
            }
            hideUserSelectionModal();
        }

        function compareThisUser(userId) {
            // Chuyển sang giao diện so sánh
            showComparisonView();

            // Đợi một chút để DOM cập nhật, sau đó chọn thành viên
            setTimeout(() => {
                const memberSelect = document.getElementById('comparisonMemberSelect');
                if (memberSelect) {
                    memberSelect.value = userId;
                }
            }, 100);
        }

        function showMainContent() {
            document.getElementById('tableContainer').style.display = 'block';
            document.querySelector('.controls').style.display = 'flex';
            document.querySelector('.filter-controls').style.display = 'flex';
        }

        function hideMainContent() {
            document.getElementById('tableContainer').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            document.querySelector('.filter-controls').style.display = 'none';
        }

        function hideComparisonView() {
            const container = document.getElementById('comparisonViewContainer');
            if (container) container.style.display = 'none';

            // Only show main content if detailed view is also hidden
            if (document.getElementById('detailedViewContainer').style.display === 'none') {
                showMainContent();
            }
        }

        function showComparisonView() {
            if (currentData.length === 0) {
                alert("Vui lòng tải dữ liệu trước khi so sánh.");
                return;
            }
            hideDetailedView();
            hideMainContent();

            const priorityMembers = currentData.filter(item => item.isPriority && item.hasBothData);
            if (priorityMembers.length === 0) {
                alert("Không có thành viên ưu tiên nào có đủ dữ liệu 2 tháng để so sánh.");
                hideComparisonView(); // Quay lại màn hình chính
                return;
            }

            // Sắp xếp tất cả thành viên theo tên để dễ chọn
            const sortedAllMembers = [...currentData].sort((a, b) => a.name.localeCompare(b.name));

            let allMembersOptionsHtml = '<option value="">-- Chọn thành viên --</option>';
            sortedAllMembers.forEach(member => {
                allMembersOptionsHtml += `<option value="${member.userId}">${member.name} (${member.userId})</option>`;
            });

            let priorityCheckboxesHtml = '';
            priorityMembers.forEach(member => {
                priorityCheckboxesHtml += `
                    <label>
                        <input type="checkbox" class="priority-compare-checkbox" value="${member.userId}">
                        ${member.name} (${member.userId})
                    </label>
                `;
            });

             const comparisonHtml = `
                <div class="comparison-card">
                    <div class="comparison-header">
                        <h2>So sánh Tăng trưởng</h2>
                        <button onclick="hideComparisonView()" class="tertiary">Quay lại bảng</button>
                    </div>
                    <div class="comparison-controls">
                        <label for="comparisonMemberSelect">Thành viên:</label>
                        <select id="comparisonMemberSelect" style="flex-grow: 1;">
                            ${allMembersOptionsHtml}
                        </select>
                    </div>
                    <div class="comparison-controls" style="background-color: transparent; padding-top: 0;">
                        <label>So sánh với các thành viên ưu tiên:</label>
                        <div class="priority-checkbox-list">${priorityCheckboxesHtml}</div>
                    </div>
                    <div class="comparison-controls" style="justify-content: center; background-color: transparent; padding-top: 0;">
                         <button onclick="performMultiComparison()" class="secondary">Thực hiện so sánh</button>
                    </div>
                    <div id="comparisonResult">
                        <p><i>Chọn một thành viên và một hoặc nhiều thành viên ưu tiên, sau đó nhấn "Thực hiện so sánh".</i></p>
                    </div>
                </div>
            `;

            const container = document.getElementById('comparisonViewContainer');
            container.innerHTML = comparisonHtml;
            container.style.display = 'block';
        }

        function performMultiComparison() {
            const memberId = document.getElementById('comparisonMemberSelect').value;
            if (!memberId) {
                alert("Vui lòng chọn thành viên chính để so sánh.");
                return;
            }

            const selectedPriorityIds = Array.from(document.querySelectorAll('.priority-compare-checkbox:checked')).map(cb => cb.value);

            if (selectedPriorityIds.length === 0) {
                alert("Vui lòng chọn ít nhất một thành viên ưu tiên để so sánh.");
                return;
            }

            const userToCompare = currentData.find(item => item.userId === memberId);
            const priorityUsers = selectedPriorityIds.map(id => currentData.find(item => item.userId === id));

            renderComparisonResult(userToCompare, priorityUsers);
        }


        function renderComparisonResult(mainUser, comparisonUsers) {
            const resultContainer = document.getElementById('comparisonResult');
            const statMapping = {
                might: "Might", kills: "Kills", enemies_captured: "Kẻ Thù Bị Bắt", enemies_destroyed: "Kẻ Thù Tiêu Diệt",
                enemy_wounded: "Quân Địch Bị Thương", troops_killed: "Quân Đội Đã Giết", troops_lost: "Số Quân Tổn Thất",
                troops_wounded: "Quân Đội Bị Thương", losses: "Thua", successful_attacks: "Tấn công Thành công",
                successful_defenses: "Phòng thủ Thành công", victories: "Chiến Thắng"
            };

            const shortenName = (name) => name.length > 15 ? name.substring(0, 12) + '...' : name;

            // Build table headers dynamically
            let headerHtml = `
                <th style="text-align: left;">Chỉ số</th>
                <th class="positive">${shortenName(mainUser.name)}</th>
            `;
            comparisonUsers.forEach(user => {
                headerHtml += `<th>${shortenName(user.name)}</th>`;
            });

            let tableHtml = `
                <h4>So sánh Chênh lệch (Tháng 7 vs Tháng 6)</h4>
                <table>
                    <thead>
                        <tr>
                            ${headerHtml}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const key in statMapping) {
                let rowHtml = `<tr><td class="stat-name">${statMapping[key]}</td>`;

                // Main user's diff
                const mainUserDiff = calculateDifference(
                    mainUser.julyStats ? mainUser.julyStats[key] : undefined,
                    mainUser.juneStats ? mainUser.juneStats[key] : undefined
                );
                rowHtml += `<td style="text-align: right;">${formatDifference(mainUserDiff)}</td>`;

                // Comparison users' diffs
                comparisonUsers.forEach(user => {
                    const comparisonUserDiff = calculateDifference(
                        user.julyStats ? user.julyStats[key] : undefined,
                        user.juneStats ? user.juneStats[key] : undefined
                    );
                    rowHtml += `<td style="text-align: right;">${formatDifference(comparisonUserDiff)}</td>`;
                });

                rowHtml += '</tr>';
                tableHtml += rowHtml;
            }

            tableHtml += `</tbody></table>`;
            resultContainer.innerHTML = tableHtml;
        }

        // Chức năng xuất ảnh được lấy từ file index.html theo yêu cầu
        async function exportToPNG() {
            if (!currentData.length) {
                alert("Vui lòng tải dữ liệu trước!");
                return;
            }

            // Lấy trực tiếp bảng dữ liệu
            const tableElement = document.getElementById('comparisonTable');

            if (!tableElement) {
                alert(`Không tìm thấy bảng dữ liệu để xuất ảnh.`);
                return;
            }

            // --- Chuẩn bị chụp: Tạm thời bỏ style sticky của header ---
            const thElements = tableElement.querySelectorAll('th');
            const originalThStyles = [];
            thElements.forEach(th => {
                originalThStyles.push(th.style.position);
                th.style.position = 'static';
            });

            // --- Phản hồi UI ---
            const exportButton = document.getElementById('exportPngBtn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = '📸 Đang xử lý...';
            exportButton.disabled = true;

            setTimeout(async () => {
                let stylesRestored = false;
                const restoreStyles = () => {
                    if (!stylesRestored) {
                        thElements.forEach((th, index) => {
                            th.style.position = originalThStyles[index] || '';
                        });
                        stylesRestored = true;
                    }
                };

                try {
                    // Chụp ảnh với kích thước đầy đủ của bảng (bao gồm cả phần bị cuộn)
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });

                    restoreStyles();

                    const imageDataUrl = canvas.toDataURL('image/png');

                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write(`<!DOCTYPE html><html><head><title>Báo cáo so sánh</title></head><body style="margin:0;"><img src="${imageDataUrl}" alt="Báo cáo so sánh" style="max-width: 100%; display: block;"></body></html>`);
                        newWindow.document.close();
                    } else {
                        alert("Không thể mở tab mới. Vui lòng kiểm tra cài đặt chặn pop-up của trình duyệt và thử lại.");
                    }

                } catch (error) {
                    console.error('Lỗi xuất ảnh:', error);
                    alert(`Xuất ảnh thất bại! Lỗi: ${error.message}. Vui lòng thử lại hoặc kiểm tra console (F12).`);
                    restoreStyles(); // Đảm bảo khôi phục nếu có lỗi
                } finally {
                    // --- Khôi phục nút ---
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
            }, 150);
        }

        function exportToExcel() {
            if (currentData.length === 0) {
                alert("Không có dữ liệu để xuất file Excel.");
                return;
            }

            const loading = showLoading("Đang tạo file Excel...");

            setTimeout(() => {
                try {
                    // Lấy dữ liệu đang hiển thị
                    const visibleData = [];
                    const tableRows = document.getElementById('tableBody').getElementsByTagName('tr');
                    for (const row of tableRows) {
                        if (row.style.display !== 'none') {
                            const userId = row.cells[2].innerText;
                            const dataItem = currentData.find(item => item.userId === userId);
                            if (dataItem) visibleData.push(dataItem);
                        }
                    }

                    if (visibleData.length === 0) {
                        alert("Không có dữ liệu nào đang được hiển thị để xuất.");
                        throw new Error("No visible data");
                    }

                    const dataToExport = [];
                    const headers = [
                        "Loại Dữ Liệu", "Tên", "User ID", "Rank", "Might", "Kills",
                        "Kẻ Thù Bị Bắt", "Kẻ Thù Tiêu Diệt", "Quân Địch Bị Thương",
                        "Quân Đội Đã Giết", "Số Quân Tổn Thất", "Quân Đội Bị Thương",
                        "Thua", "Tấn công Thành công", "Phòng thủ Thành công",
                        "Chiến Thắng", "Tỉ Lệ Chiến Thắng"
                    ];

                    // Tiêu đề chính
                    dataToExport.push([`Báo cáo so sánh thống kê - Ngày xuất: ${new Date().toLocaleString('vi-VN')}`]);
                    dataToExport.push([]);
                    dataToExport.push(headers.map(h => ({ v: h, t: 's', s: { font: { bold: true }, alignment: { horizontal: 'center' } } })));

                    // --- Các hàm tiện ích để tạo ô trong Excel ---
                    const createCell = (value, type = 's', format = null, style = {}) => {
                        const cell = { v: value, t: type, s: style };
                        if (format) cell.z = format;
                        return cell;
                    };

                    const createNumericCell = (value) => {
                        if (value === undefined || value === null || value === "Không có dữ liệu") {
                            return createCell("Không có dữ liệu");
                        }
                        return createCell(value, 'n', '#,##0');
                    };

                    const createDiffCell = (diff) => {
                        if (diff === null || diff === undefined) return createCell("N/A");
                        const style = { font: {} };
                        if (diff > 0) style.font.color = { rgb: "FF008000" }; // Green
                        if (diff < 0) style.font.color = { rgb: "FFFF0000" }; // Red
                        return createCell(diff, 'n', '+#,##0;-#,##0;0', style);
                    };

                    const createWinRateDiffCell = (newRate, oldRate) => {
                        if (!newRate || !oldRate) return createCell("N/A");
                        const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
                        const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
                        if (isNaN(newNum) || isNaN(oldNum)) return createCell("N/A");

                        const diff = newNum - oldNum;
                        const style = { font: {} };
                        let text = `${diff.toFixed(2)}%`;
                        if (diff > 0) {
                            style.font.color = { rgb: "FF008000" }; // Green
                            text = `+${text}`;
                        } else if (diff < 0) {
                            style.font.color = { rgb: "FFFF0000" }; // Red
                        }
                        return createCell(text, 's', null, style);
                    };

                    visibleData.forEach(item => {
                        const { userId, name, rank, juneStats, julyStats } = item;
                        const getStat = (stats, key) => (stats ? stats[key] : undefined);

                        const juneRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(juneStats, 'might')), createNumericCell(getStat(juneStats, 'kills')),
                            createNumericCell(getStat(juneStats, 'enemies_captured')), createNumericCell(getStat(juneStats, 'enemies_destroyed')),
                            createNumericCell(getStat(juneStats, 'enemy_wounded')), createNumericCell(getStat(juneStats, 'troops_killed')),
                            createNumericCell(getStat(juneStats, 'troops_lost')), createNumericCell(getStat(juneStats, 'troops_wounded')),
                            createNumericCell(getStat(juneStats, 'losses')), createNumericCell(getStat(juneStats, 'successful_attacks')),
                            createNumericCell(getStat(juneStats, 'successful_defenses')), createNumericCell(getStat(juneStats, 'victories')),
                            createCell(getStat(juneStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(juneRow);

                        const julyRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(julyStats, 'might')), createNumericCell(getStat(julyStats, 'kills')),
                            createNumericCell(getStat(julyStats, 'enemies_captured')), createNumericCell(getStat(julyStats, 'enemies_destroyed')),
                            createNumericCell(getStat(julyStats, 'enemy_wounded')), createNumericCell(getStat(julyStats, 'troops_killed')),
                            createNumericCell(getStat(julyStats, 'troops_lost')), createNumericCell(getStat(julyStats, 'troops_wounded')),
                            createNumericCell(getStat(julyStats, 'losses')), createNumericCell(getStat(julyStats, 'successful_attacks')),
                            createNumericCell(getStat(julyStats, 'successful_defenses')), createNumericCell(getStat(julyStats, 'victories')),
                            createCell(getStat(julyStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(julyRow);

                        const diffRow = [
                            createCell("Tổng", 's', null, { font: { bold: true } }), createCell(""), createCell(""), createCell(""),
                            createDiffCell(calculateDifference(getStat(julyStats, 'might'), getStat(juneStats, 'might'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'kills'), getStat(juneStats, 'kills'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_captured'), getStat(juneStats, 'enemies_captured'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_destroyed'), getStat(juneStats, 'enemies_destroyed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemy_wounded'), getStat(juneStats, 'enemy_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_killed'), getStat(juneStats, 'troops_killed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_lost'), getStat(juneStats, 'troops_lost'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_wounded'), getStat(juneStats, 'troops_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'losses'), getStat(juneStats, 'losses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_attacks'), getStat(juneStats, 'successful_attacks'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_defenses'), getStat(juneStats, 'successful_defenses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'victories'), getStat(juneStats, 'victories'))),
                            createWinRateDiffCell(getStat(julyStats, 'win_rate'), getStat(juneStats, 'win_rate'))
                        ];
                        dataToExport.push(diffRow);

                        dataToExport.push([]); // Dòng trống phân cách
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataToExport);

                    // Tự động điều chỉnh độ rộng cột
                    const objectMaxLength = dataToExport.reduce((acc, row) => {
                        row.forEach((cell, i) => {
                            const cellValue = cell && cell.v ? cell.v : '';
                            const cellLength = String(cellValue).length;
                            acc[i] = Math.max(acc[i] || 0, cellLength);
                        });
                        return acc;
                    }, []);
                    ws["!cols"] = objectMaxLength.map(width => ({ wch: Math.min(width + 2, 40) })); // Giới hạn độ rộng tối đa
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "So Sánh Thống Kê");
                    XLSX.writeFile(wb, `SoSanhThongKe_${new Date().toISOString().slice(0, 10)}.xlsx`);
                } catch (error) {
                    if (error.message === "No visible data") return; // Đã có alert, không cần báo lỗi thêm
                    console.error("Lỗi khi xuất Excel:", error);
                    alert("Đã xảy ra lỗi khi tạo file Excel. Vui lòng kiểm tra console (F12) để biết chi tiết.");
                } finally {
                    loading.remove();
                }
            }, 50);
        }

        function showLoading(message) {
            const loading = document.createElement('div');
            loading.style.position = 'fixed';
            loading.style.top = '0';
            loading.style.left = '0';
            loading.style.width = '100%';
            loading.style.height = '100%';
            loading.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loading.style.display = 'flex';
            loading.style.flexDirection = 'column';
            loading.style.justifyContent = 'center';
            loading.style.alignItems = 'center';
            loading.style.zIndex = '9999';
            loading.innerHTML = `
                <div style="color:white;font-size:20px;margin-bottom:10px;">${message}</div>
                <div class="spinner"></div>
            `;
            document.body.appendChild(loading);
            return loading;
        }

        function resetTable() {
            document.getElementById('searchInput').value = '';
            document.getElementById('priorityIds').value = '416381060,765602761,417896120,537487142,360966484';
            priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
            hideComparisonView();
            hideDetailedView();
            sortTable('name', 'asc');
        }

        // Khởi tạo sự kiện
        window.onload = function () {
            document.getElementById('juneFile').addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], 'june');
                }
            });

            document.getElementById('julyFile').addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], 'july');
                }
            });

            document.getElementById('searchInput').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    searchTable();
                }
            });

            document.getElementById('priorityIds').addEventListener('input', function () {
                if (realtimeFilterEnabled) {
                    applyPriorityFilter();
                }
            });

            document.getElementById('realtimeFilter').addEventListener('change', function (e) {
                realtimeFilterEnabled = e.target.checked;
            });

            // Khởi tạo giá trị mặc định cho priorityIds
            document.getElementById('priorityIds').value = priorityIds.join(',');
        
    // === TỰ ĐỘNG TẢI DỮ LIỆU MẶC ĐỊNH ===
    document.getElementById('juneUrl').value = 'https://docs.google.com/spreadsheets/d/1pF9hCZz0kzafaZQxGJDVZVwd275kgGc4rbWr9LnoBoQ/edit?usp=drivesdk';
    document.getElementById('julyUrl').value = 'https://docs.google.com/spreadsheets/d/1vxjNifx_pgJjDlZ-FK6_Y2NpzKU1ArcV/edit?usp=drivesdk&ouid=102277306545046971176&rtpof=true&sd=true';
    loadFromUrl('june');
    loadFromUrl('july');
};
    </script>
</body>
</html>
