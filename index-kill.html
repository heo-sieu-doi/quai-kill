<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ So sánh Thống kê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            overflow-x: auto;
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upload-box {
            border: 1px solid #ddd;
            padding: 10px;
            flex: 1;
            border-radius: 4px;
        }

        .upload-box h2 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            margin-right: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.tertiary {
            background-color: #ff9800;
        }

        button.tertiary:hover {
            background-color: #e68a00;
        }

        button.quaternary {
            background-color: #9c27b0;
        }

        button.quaternary:hover {
            background-color: #7b1fa2;
        }

        table {
            border-collapse: collapse;
            /* width: 100%; */
            /* Bỏ width để cột tự co giãn theo nội dung */
            margin-top: 10px;
            font-size: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 5px;
            /* Giảm padding cho giao diện gọn hơn */
            text-align: left;
            /* Căn lề trái cho tất cả các cột */
            white-space: nowrap;
            /* Ngăn không cho nội dung xuống dòng, giúp cột co giãn */
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        /* Style cho header nhóm */
        th[colspan] {
            text-align: left;
            /* Căn lề trái cho header nhóm */
            padding-left: 10px;
            /* Thêm khoảng đệm cho dễ nhìn */
            border-bottom: 2px solid #ccc;
            /* Đường kẻ dưới đậm hơn để phân tách cấp */
            border-right: 2px solid #adadad;
            /* Đường kẻ phải đậm hơn để phân tách các nhóm */
            font-weight: bold;
            color: #333;
        }

        th[colspan]:last-child {
            border-right: 1px solid #ddd;
            /* Giữ border cho cột cuối cùng của header */
        }

        /* Thêm đường viền đậm cho cột cuối của nhóm thông tin (Rank) */
        .info-group-separator {
            border-right: 2px solid #adadad;
        }

        /* Màu nền cho từng nhóm để phân biệt rõ ràng */
        .group-might {
            background-color: #eaf2f8;
        }

        .group-kills {
            background-color: #e8f8f5;
        }

        .group-captured {
            background-color: #fef5e7;
        }

        .group-destroyed {
            background-color: #feebef;
        }

        .group-enemy-wounded {
            background-color: #f4ecf7;
        }

        .group-troops-killed {
            background-color: #d6eaf8;
        }

        .group-troops-lost {
            background-color: #fdedec;
        }

        .group-troops-wounded {
            background-color: #d7bde2;
        }

        .group-losses {
            background-color: #fef9e7;
        }

        .group-attacks {
            background-color: #e8f6f3;
        }

        .group-defenses {
            background-color: #eaeded;
        }

        .group-victories {
            background-color: #a9cce3;
        }

        .group-win-rate {
            background-color: #a3e4d7;
        }

        thead tr:last-child th {
            white-space: nowrap;
            background-color: #f8f9f9;
            /* Màu nền riêng cho header phụ */
        }

        .positive {
            color: green;
            font-weight: bold;
        }

        .negative {
            color: red;
            font-weight: bold;
        }

        .neutral {
            color: #666;
        }

        .no-data {
            color: #999;
            font-style: italic;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .realtime-filter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-filter input[type="checkbox"] {
            margin: 0;
        }

        .status {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .success {
            background-color: #e6ffe6;
            color: #006600;
        }

        .error {
            background-color: #ffebeb;
            color: #cc0000;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .compact-col {
            min-width: 70px;
        }

        .missing-data-row {
            background-color: #f9f9f9;
        }

        .priority-row {
            background-color: #fffacd !important;
        }

        .hidden-col {
            display: none;
        }

        .priority-input {
            margin-top: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .priority-label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .upload-box input[type="file"] {
            margin-bottom: 10px;
        }

        .url-upload-group {
            display: flex;
            gap: 5px;
        }

        .url-upload-group input[type="text"] {
            flex-grow: 1;
            width: auto;
            /* Override width: 100% */
        }

        /* === NEW STYLES FOR COMPARISON VIEW === */
        #comparisonViewContainer {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #9c27b0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .comparison-header h2 {
            margin: 0;
            color: #9c27b0;
            font-size: 1.5em;
        }

        .comparison-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }

        .comparison-controls label {
            font-weight: bold;
        }

        .comparison-controls select,
        .comparison-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .comparison-controls input[type="text"] {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }

        .priority-checkbox-list {
            max-height: 150px;
            /* Giới hạn chiều cao */
            overflow-y: auto;
            /* Thêm thanh cuộn khi cần */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            flex-basis: 100%;
            /* Chiếm toàn bộ chiều rộng trong flex container */
        }

        .priority-checkbox-list label {
            display: block;
            /* Mỗi checkbox một dòng */
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: normal;
            /* Bỏ bold mặc định của label */
        }

        .file-name-display {
            display: block;
            margin-top: 5px;
            font-style: italic;
            color: #555;
            font-size: 12px;
            min-height: 1em;
            /* Giữ khoảng trống */
        }

        #comparisonResult {
            width: 100%;
            overflow-x: auto;
            /* Thêm thanh cuộn ngang khi cần */
        }

        #comparisonResult table {
            margin-top: 0;
        }

        #comparisonResult th {
            background-color: #f5eef8;
        }

        /* === NEW STYLES FOR DETAILED VIEW === */
        #detailedViewContainer {
            margin-top: 20px;
        }

        .detailed-view-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .detailed-view-body {
            width: 100%;
            overflow-x: auto;
            /* Thêm thanh cuộn ngang khi cần */
        }

        .detailed-view-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 15px;
            gap: 10px;
        }

        .detailed-view-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .detailed-view-header .user-id {
            font-size: 0.9em;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .detailed-view-body table {
            width: 100%;
            border-collapse: collapse;
        }

        .detailed-view-body th,
        .detailed-view-body td {
            padding: 8px;
            /* Giảm padding cho đồng bộ và gọn hơn */
            border-bottom: 1px solid #eee;
        }

        .detailed-view-body .stat-name {
            text-align: left;
            font-weight: bold;
            color: #555;
        }

        /* === COMPACT VIEW STYLES === */
        /* Hide entire groups not needed in compact view */
        body.compact-view .group-captured,
        body.compact-view .group-captured-cell,
        body.compact-view .group-losses,
        body.compact-view .group-losses-cell,
        body.compact-view .group-attacks,
        body.compact-view .group-attacks-cell,
        body.compact-view .group-defenses,
        body.compact-view .group-defenses-cell,
        body.compact-view .group-victories,
        body.compact-view .group-victories-cell,
        body.compact-view .group-win-rate,
        body.compact-view .group-win-rate-cell,
        body.compact-view .id-col,
        body.compact-view .rank-col {
            /* Ẩn cột ID và Rank */
            display: none;
        }

        /* In compact view, hide the month columns for the remaining groups */
        body.compact-view .month-col {
            display: none;
        }

        /* In compact view, change the main header text alignment to center since it only has one sub-column */
        body.compact-view th[colspan] {
            text-align: center;
            padding-left: 0;
            /* Reset
             padding */
        }

        .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Công cụ So sánh Thống kê</h1>

        <div class="upload-section">
            <div class="upload-box">
                <h2 id="monthTitleJune">Dữ liệu Tháng 6</h2>
                <label for="juneMonthSelect">Chọn tháng:</label>
                <select id="juneMonthSelect" onchange="updateMonth('june')">
                    <option value="1">Tháng 1</option>
                    <option value="2">Tháng 2</option>
                    <option value="3">Tháng 3</option>
                    <option value="4">Tháng 4</option>
                    <option value="5">Tháng 5</option>
                    <option value="6" selected>Tháng 6</option>
                    <option value="7">Tháng 7</option>
                    <option value="8">Tháng 8</option>
                    <option value="9">Tháng 9</option>
                    <option value="10">Tháng 10</option>
                    <option value="11">Tháng 11</option>
                    <option value="12">Tháng 12</option>
                </select>
                <label for="juneFile">1. Tải từ máy (ưu tiên):</label>
                <input type="file" id="juneFile" accept=".xlsx,.xls" />
                <span class="file-name-display" id="juneFileName"></span>
                <label for="juneUrl" style="margin-top:10px; display:block;">2. Hoặc dán URL vào đây:</label>
                <input type="text" id="juneUrl" placeholder="Dán link Google Sheets/GitHub Raw cho Tháng 6...">
                <button onclick="loadData('june')" class="secondary" style="width: 100%; margin-top: 10px;">Tải Dữ Liệu
                    Tháng 6</button>
                <button onclick="showGitHubFiles('june')" class="secondary" style="width: 100%; margin-top: 10px;">Chọn
                    tệp từ GitHub</button>
                <div id="githubFilesJune" style="display: none; margin-top: 10px;">
                    <label for="githubFileSelectJune">Chọn file:</label>
                    <select id="githubFileSelectJune" onchange="selectGitHubFile('june')">
                        <option value="">-- Chọn file --</option>
                    </select>
                </div>
                <div id="juneStatus" class="status"></div>
            </div>

            <div class="upload-box">
                <h2 id="monthTitleJuly">Dữ liệu Tháng 7</h2>
                <label for="julyMonthSelect">Chọn tháng:</label>
                <select id="julyMonthSelect" onchange="updateMonth('july')">
                    <option value="1">Tháng 1</option>
                    <option value="2">Tháng 2</option>
                    <option value="3">Tháng 3</option>
                    <option value="4">Tháng 4</option>
                    <option value="5">Tháng 5</option>
                    <option value="6">Tháng 6</option>
                    <option value="7" selected>Tháng 7</option>
                    <option value="8">Tháng 8</option>
                    <option value="9">Tháng 9</option>
                    <option value="10">Tháng 10</option>
                    <option value="11">Tháng 11</option>
                    <option value="12">Tháng 12</option>
                </select>
                <label for="julyFile">1. Tải từ máy (ưu tiên):</label>
                <input type="file" id="julyFile" accept=".xlsx,.xls" />
                <span class="file-name-display" id="julyFileName"></span>
                <label for="julyUrl" style="margin-top:10px; display:block;">2. Hoặc dán URL vào đây:</label>
                <input type="text" id="julyUrl" placeholder="Dán link Google Sheets/GitHub Raw cho Tháng 7...">
                <button onclick="loadData('july')" class="secondary" style="width: 100%; margin-top: 10px;">Tải Dữ Liệu
                    Tháng 7</button>
                <button onclick="showGitHubFiles('july')" class="secondary" style="width: 100%; margin-top: 10px;">Chọn
                    tệp từ GitHub</button>
                <div id="githubFilesJuly" style="display: none; margin-top: 10px;">
                    <label for="githubFileSelectJuly">Chọn file:</label>
                    <select id="githubFileSelectJuly" onchange="selectGitHubFile('july')">
                        <option value="">-- Chọn file --</option>
                    </select>
                </div>
                <div id="julyStatus" class="status"></div>
            </div>
        </div>

        <div class="filter-controls">
            <div class="filter-section">
                <label class="priority-label">ID ưu tiên (cách nhau bằng dấu phẩy):</label>
                <input type="text" id="priorityIds" class="priority-input"
                    placeholder="Nhập các ID ưu tiên, ví dụ: 123,456,789"
                    value="416381060,765602761,417896120,537487142,360966484" />
                <div class="action-buttons">
                    <button onclick="applyPriorityFilter()" class="secondary">Áp dụng lọc</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="flex: 1;">
                <input type="text" id="searchInput" placeholder="Tìm theo tên hoặc ID..." />
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="searchTable()">Tìm kiếm</button>
                    <button onclick="showDetailedView()" class="secondary">Xem chi tiết</button>
                    <button id="compactViewBtn" onclick="toggleCompactView()" class="tertiary">Tinh gọn</button>
                    <button onclick="showComparisonView()" class="quaternary">So sánh với Ưu tiên</button>
                    <button onclick="sortTable('killsDiff', 'asc')" class="secondary">Sắp xếp Kills (Tăng)</button>
                    <button onclick="sortTable('killsDiff', 'desc')" class="secondary">Sắp xếp Kills (Giảm)</button>
                    <button onclick="toggleIdColumn()" class="tertiary">Ẩn/Hiện ID</button>
                    <button id="exportPngBtn" onclick="exportToPNG()" class="tertiary">Xuất ảnh PNG</button>
                    <button onclick="exportToExcel()" class="quaternary">Xuất file Excel</button>
                    <button onclick="resetTable()">Đặt lại</button>
                </div>
            </div>
        </div>
        <div id="totalsContainer"
            style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; display: none;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Tổng Thống Kê</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div><strong>Tổng Kills:</strong> <span id="totalKills">0</span></div>
                <div><strong>Tổng Số Quân Tổn Thất:</strong> <span id="totalTroopsLost">0</span></div>
                <div><strong>Tổng Quân Địch Bị Thương:</strong> <span id="totalEnemyWounded">0</span></div>
                <div><strong>Tổng Quân Đội Đã Giết:</strong> <span id="totalTroopsKilled">0</span></div>
                <div><strong>Tổng Quân Đội Bị Thương:</strong> <span id="totalTroopsWounded">0</span></div>
            </div>
        </div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Đang xử lý...</p>
        </div>

        <div id="tableContainer">
            <table id="comparisonTable">
                <thead>
                    <!-- Dòng tiêu đề chính -->
                    <tr>
                        <th rowspan="2">STT</th>
                        <th rowspan="2">Tên</th>
                        <th rowspan="2" class="id-col">User ID</th>
                        <th rowspan="2" class="info-group-separator rank-col">Rank</th>
                        <th colspan="3" class="group-might">Might</th>
                        <th colspan="3" class="group-kills">Kills</th>
                        <th colspan="3" class="group-captured">Kẻ Thù Bị Bắt</th>
                        <th colspan="3" class="group-destroyed">Kẻ Thù Tiêu Diệt</th>
                        <th colspan="3" class="group-enemy-wounded">Quân Địch Bị Thương</th>
                        <th colspan="3" class="group-troops-killed">Quân Đội Đã Giết</th>
                        <th colspan="3" class="group-troops-lost">Số Quân Tổn Thất</th>
                        <th colspan="3" class="group-troops-wounded">Quân Đội Bị Thương</th>
                        <th colspan="3" class="group-losses">Thua</th>
                        <th colspan="3" class="group-attacks">Tấn công Thành công</th>
                        <th colspan="3" class="group-defenses">Phòng thủ Thành công</th>
                        <th colspan="3" class="group-victories">Chiến Thắng</th>
                        <th colspan="3" class="group-win-rate">Tỉ Lệ Chiến Thắng</th>
                    </tr>
                    <!-- Dòng tiêu đề phụ -->
                    <tr id="sub-header-row">
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <th class="month-col month-col-june">Tháng 6</th>
                        <th class="month-col month-col-july">Tháng 7</th>
                        <th class="diff-col">Tổng</th>
                        <!-- Tiếp tục cho các cột khác -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dữ liệu sẽ được thêm vào đây -->
                </tbody>
            </table>
        </div>

        <!-- Container for the new comparison view -->
        <div id="comparisonViewContainer" style="display: none;"></div>

        <!-- Container for the new detailed vertical view -->
        <div id="detailedViewContainer" style="display: none;"></div>


    </div>

    <script>
        // Biến toàn cục
        let juneData = {};
        let julyData = {};
        let currentData = [];
        let showIdColumn = true;
        let priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
        let currentSort = { column: 'name', direction: 'asc' };
        let selectedMonths = {
            june: 6, // Mặc định là tháng 6
            july: 7  // Mặc định là tháng 7
        };

        // Mảng cấu hình cho các chỉ số để tránh lặp code
        const STATS_CONFIG = [
            { key: 'might', name: 'Might', groupClass: 'group-might-cell' },
            { key: 'kills', name: 'Kills', groupClass: 'group-kills-cell' },
            { key: 'enemies_captured', name: 'Kẻ Thù Bị Bắt', groupClass: 'group-captured-cell' },
            { key: 'enemies_destroyed', name: 'Kẻ Thù Tiêu Diệt', groupClass: 'group-destroyed-cell' },
            { key: 'enemy_wounded', name: 'Quân Địch Bị Thương', groupClass: 'group-enemy-wounded-cell' },
            { key: 'troops_killed', name: 'Quân Đội Đã Giết', groupClass: 'group-troops-killed-cell' },
            { key: 'troops_lost', name: 'Số Quân Tổn Thất', groupClass: 'group-troops-lost-cell' },
            { key: 'troops_wounded', name: 'Quân Đội Bị Thương', groupClass: 'group-troops-wounded-cell' },
            { key: 'losses', name: 'Thua', groupClass: 'group-losses-cell' },
            { key: 'successful_attacks', name: 'Tấn công Thành công', groupClass: 'group-attacks-cell' },
            { key: 'successful_defenses', name: 'Phòng thủ Thành công', groupClass: 'group-defenses-cell' },
            { key: 'victories', name: 'Chiến Thắng', groupClass: 'group-victories-cell' }
        ];

        // Hàm tải dữ liệu với logic ưu tiên
        function loadData(type) {
            const fileInput = document.getElementById(`${type}File`);
            const urlInput = document.getElementById(`${type}Url`);

            // Ưu tiên 1: Kiểm tra file đã chọn
            if (fileInput.files.length > 0) {
                handleFileUpload(fileInput.files[0], type);
            }
            // Ưu tiên 2: Kiểm tra URL
            else if (urlInput.value.trim() !== '') {
                loadFromUrl(type);
            }
            // Không có nguồn dữ liệu
            else {
                alert(`Vui lòng chọn một file hoặc dán URL cho tháng ${type === 'june' ? '6' : '7'}.`);
            }
        }
        // Hàm xử lý upload file
        function handleFileUpload(file, type) {
            const reader = new FileReader();
            const statusElement = document.getElementById(`${type}Status`);

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (type === 'june') {
                        juneData = processData(jsonData);
                        statusElement.textContent = `Đã tải tháng 6: ${Object.keys(juneData).length} người chơi`;
                        statusElement.className = 'status success';
                    } else {
                        julyData = processData(jsonData);
                        statusElement.textContent = `Đã tải tháng 7: ${Object.keys(julyData).length} người chơi`;
                        statusElement.className = 'status success';
                    }

                    if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                        compareData();
                    }
                } catch (error) {
                    statusElement.textContent = `Lỗi: ${error.message}`;
                    statusElement.className = 'status error';
                }
            };

            reader.onerror = function () {
                statusElement.textContent = `Lỗi đọc file`;
                statusElement.className = 'status error';
            };

            reader.readAsArrayBuffer(file);
        }

        // Hàm tải từ URL, được lấy và chỉnh sửa từ file index.html
        async function loadFromUrl(type) {
            const urlInputId = `${type}Url`;
            const statusElementId = `${type}Status`;
            const urlInput = document.getElementById(urlInputId);
            const statusElement = document.getElementById(statusElementId);

            const rawUrl = urlInput.value.trim();
            if (!rawUrl) {
                alert(`Vui lòng nhập URL cho tháng ${type === 'june' ? '6' : '7'}!`);
                return;
            }

            let exportUrl = '';
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                const sheetId = match[1];
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                exportUrl = rawUrl;
            } else {
                alert("URL không hợp lệ. Vui lòng cung cấp link Google Sheets/File hợp lệ (đã chia sẻ công khai) hoặc link trực tiếp đến file .xlsx.");
                return;
            }

            statusElement.textContent = 'Đang tải từ URL...';
            statusElement.className = 'status';
            const loading = showLoading(`Đang tải dữ liệu tháng ${type === 'june' ? '6' : '7'}...`);

            try {
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
                const fetchUrl = proxyUrl + encodeURIComponent(exportUrl);

                const response = await fetch(fetchUrl, { signal: AbortSignal.timeout(30000) });

                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status} ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !(contentType.includes('spreadsheetml.sheet') || contentType.includes('application/vnd.ms-excel') || contentType.includes('octet-stream'))) {
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();
                    if (responseText.trim().toLowerCase().startsWith('<html') || responseText.trim().toLowerCase().startsWith('<!doctype html')) {
                        throw new Error("Lỗi định dạng: Nhận được HTML thay vì file Excel. Đảm bảo link được chia sẻ công khai.");
                    }
                }

                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength < 100) {
                    throw new Error("Tải file thất bại: File nhận được quá nhỏ.");
                }

                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                const processed = processData(jsonData);
                if (type === 'june') {
                    juneData = processed;
                    statusElement.textContent = `Đã tải tháng 6 từ URL: ${Object.keys(juneData).length} người chơi`;
                    statusElement.className = 'status success';
                } else {
                    julyData = processed;
                    statusElement.textContent = `Đã tải tháng 7 từ URL: ${Object.keys(julyData).length} người chơi`;
                    statusElement.className = 'status success';
                }

                if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                    compareData();
                }
            } catch (error) {
                console.error(`Lỗi khi tải URL cho ${type}:`, error);
                statusElement.textContent = `Lỗi tải URL: ${error.message}`;
                statusElement.className = 'status error';
            } finally {
                loading.remove();
            }
        }

        // Hàm xử lý dữ liệu
        function processData(sheetData) {
            const result = {};
            let headerRowIndex = -1;

            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row && row.includes("User ID")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) throw new Error("Không tìm thấy hàng tiêu đề");

            const headers = sheetData[headerRowIndex];
            const getColIndex = (headerName) => {
                const possibleNames = Array.isArray(headerName) ? headerName.map(n => n.toLowerCase()) : [headerName.toLowerCase()];
                for (const name of possibleNames) {
                    const index = headers.findIndex(h => h && h.toString().trim().toLowerCase() === name);
                    if (index !== -1) return index;
                }
                return -1;
            };

            const indices = {
                name: getColIndex("Name"),
                userId: getColIndex("User ID"),
                rank: getColIndex("Rank"),
                might: getColIndex("Might"),
                kills: getColIndex("Kills"),
                enemiesCaptured: getColIndex("Enemies captured"),
                enemiesDestroyed: getColIndex("Enemies Destroyed Might"),
                enemyWounded: getColIndex("Enemy Troops Wounded"),
                troopsKilled: getColIndex("Troops Killed"),
                troopsLost: getColIndex("Troops Lost"),
                troopsWounded: getColIndex("Troops Wounded"),
                losses: getColIndex("Losses"),
                successfulAttacks: getColIndex("Successful Attacks"),
                successfulDefenses: getColIndex("Phòng thủ thành công"),
                victories: getColIndex("Victories"),
                winRate: getColIndex("Win Rate")
            };

            for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;

                const userId = row[indices.userId];
                if (!userId) continue;

                const getValue = (index, defaultValue = 0) => {
                    if (index === -1) return defaultValue;
                    const val = row[index];
                    if (val === undefined || val === null) return defaultValue;
                    if (typeof val === 'number') return val;
                    // Only parse numbers from strings if it's not the win_rate column
                    if (typeof val === 'string' && index !== indices.winRate) {
                        const num = parseFloat(val.replace(/[^0-9.-]/g, ''));
                        return isNaN(num) ? defaultValue : num;
                    }
                    return defaultValue;
                };

                result[userId] = {
                    name: row[indices.name] || 'Không xác định',
                    rank: row[indices.rank] || 'Không xác định',
                    might: getValue(indices.might),
                    kills: getValue(indices.kills),
                    enemies_captured: getValue(indices.enemiesCaptured),
                    enemies_destroyed: getValue(indices.enemiesDestroyed),
                    enemy_wounded: getValue(indices.enemyWounded),
                    troops_killed: getValue(indices.troopsKilled),
                    troops_lost: getValue(indices.troopsLost),
                    troops_wounded: getValue(indices.troopsWounded),
                    losses: getValue(indices.losses),
                    successful_attacks: getValue(indices.successfulAttacks),
                    successful_defenses: getValue(indices.successfulDefenses),
                    victories: getValue(indices.victories),
                    win_rate: row[indices.winRate] ? row[indices.winRate].toString() : '0%'
                };
            }

            return result;
        }


        // Hàm so sánh dữ liệu
        function compareData() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';

            setTimeout(() => {
                try {
                    const allUserIds = new Set([...Object.keys(juneData), ...Object.keys(julyData)]);
                    currentData = [];

                    Array.from(allUserIds).forEach(userId => {
                        const juneStats = juneData[userId];
                        const julyStats = julyData[userId];

                        if (!juneStats && !julyStats) return;

                        const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                        const isPriority = priorityIds.includes(userId);

                        currentData.push({
                            userId,
                            name: julyStats?.name || juneStats?.name || 'Không xác định',
                            rank: julyStats?.rank || juneStats?.rank || 'Không xác định',
                            juneStats,
                            julyStats,
                            killsDiff,
                            hasBothData: juneStats && julyStats,
                            isPriority
                        });
                    });

                    // Sắp xếp theo tên mặc định thay vì áp dụng bộ lọc ưu tiên ngay
                    sortTable('name', 'asc');

                } catch (error) {
                    console.error('Lỗi khi so sánh:', error);
                } finally {
                    loadingElement.style.display = 'none';
                }
            }, 100);
        }


        // Hàm cập nhật ID ưu tiên
        function updatePriorityIds() {
            const input = document.getElementById('priorityIds').value;
            priorityIds = input.split(',')
                .map(id => id.trim())
                .filter(id => id !== '');

            currentData.forEach(item => {
                item.isPriority = priorityIds.includes(item.userId);
            });
        }

        // Hàm áp dụng bộ lọc ưu tiên
        function applyPriorityFilter() {
            updatePriorityIds();

            const sortedData = [...currentData].sort((a, b) => {
                // Logic ưu tiên
                const aIsPriority = a.isPriority;
                const bIsPriority = b.isPriority;

                if (aIsPriority && !bIsPriority) return -1;
                if (!aIsPriority && bIsPriority) return 1;

                // Nếu cả hai cùng trạng thái ưu tiên (hoặc cùng không), sắp xếp theo tiêu chí hiện tại
                if (currentSort.column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return currentSort.direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else { // Sắp xếp theo tên
                    return currentSort.direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // Hàm sắp xếp bảng
        function sortTable(column, direction) {
            if (!currentData.length) return;

            currentSort = { column, direction };

            const sortedData = [...currentData].sort((a, b) => {
                // Bỏ hoàn toàn logic ưu tiên ở đây
                if (column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else {
                    return direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // Hàm hiển thị dữ liệu đã sắp xếp
        function displaySortedData(sortedData) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Xóa nội dung cũ

            sortedData.forEach((item, index) => {
                const { userId, name, rank, juneStats, julyStats, hasBothData, isPriority } = item;
                const row = document.createElement('tr');

                if (!hasBothData) row.classList.add('missing-data-row');
                if (isPriority) row.classList.add('priority-row');

                // Tạo HTML cho các chỉ số bằng cách lặp qua mảng cấu hình
                let statsHtml = '';
                STATS_CONFIG.forEach(stat => {
                    const diff = calculateDifference(julyStats?.[stat.key], juneStats?.[stat.key]);
                    statsHtml += `
                <td class="${stat.groupClass} month-col">${formatNumber(juneStats?.[stat.key])}</td>
                <td class="${stat.groupClass} month-col">${formatNumber(julyStats?.[stat.key])}</td>
                <td class="${stat.groupClass} diff-col">${formatDifference(diff)}</td>
            `;
                });

                // Xử lý riêng cho Tỉ lệ thắng
                const winRateDiff = compareWinRates(julyStats?.win_rate, juneStats?.win_rate);
                const winRateHtml = `
            <td class="group-win-rate-cell month-col">${juneStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
            <td class="group-win-rate-cell month-col">${julyStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
            <td class="group-win-rate-cell diff-col">${winRateDiff}</td>
        `;

                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${name}</td>
            <td class="id-col">${userId}</td>
            <td class="rank-col">${rank}</td>
            ${statsHtml}
            ${winRateHtml}
        `;

                tableBody.appendChild(row);
            });

            // Hiển thị tổng
            displayTotals();
        }

        function toggleCompactView() {
            const body = document.body;
            const btn = document.getElementById('compactViewBtn');
            const isCompact = body.classList.toggle('compact-view'); // toggle() trả về true nếu class được thêm vào

            const mainHeaders = document.querySelectorAll('#comparisonTable th[colspan]');
            const subHeaderRow = document.getElementById('sub-header-row');

            if (isCompact) {
                // Khi ở chế độ Tinh gọn
                btn.textContent = 'Xem đầy đủ';
                mainHeaders.forEach(th => th.setAttribute('colspan', '1')); // Đặt colspan về 1
                if (subHeaderRow) subHeaderRow.style.display = 'none'; // Ẩn hàng tiêu đề phụ
            } else {
                // Khi ở chế độ Xem đầy đủ
                btn.textContent = 'Tinh gọn';
                mainHeaders.forEach(th => th.setAttribute('colspan', '3')); // Trả colspan về 3
                if (subHeaderRow) subHeaderRow.style.display = ''; // Hiện lại hàng tiêu đề phụ
            }
        }

        // Các hàm tiện ích
        function formatNumber(num) {
            if (num === undefined || num === null) return '<span class="no-data">N/A</span>';
            return num.toLocaleString();
        }

        function calculateDifference(newVal, oldVal) {
            if (newVal === undefined || oldVal === undefined) return null;
            return newVal - oldVal;
        }

        function formatDifference(diff) {
            if (diff === null) return '<span class="no-data">N/A</span>';
            if (diff > 0) return `<span class="positive">+${formatNumber(diff)}</span>`;
            if (diff < 0) return `<span class="negative">${formatNumber(diff)}</span>`;
            return `<span class="neutral">0</span>`;
        }

        function compareWinRates(newRate, oldRate) {
            if (!newRate || !oldRate) return '<span class="no-data">N/A</span>';

            const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
            const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
            const diff = newNum - oldNum;

            if (diff > 0) return `<span class="positive">+${diff.toFixed(2)}%</span>`;
            if (diff < 0) return `<span class="negative">${diff.toFixed(2)}%</span>`;
            return `<span class="neutral">0%</span>`;
        }

        // Các hàm xử lý giao diện
        function searchTable() {
            // Lấy giá trị tìm kiếm từ ô nhập
            const input = document.getElementById('searchInput');
            const filter = input.value.trim().toLowerCase();

            if (!filter) {
                alert("Vui lòng nhập Tên hoặc ID để tìm kiếm.");
                return;
            }

            // Lọc dữ liệu trong currentData
            const filteredData = currentData.filter(item =>
                item.name.toLowerCase().includes(filter) || // Tìm theo tên
                item.userId.toString().includes(filter)    // Tìm theo ID
            );

            if (filteredData.length === 0) {
                alert(`Không tìm thấy người chơi với Tên hoặc ID chứa: "${filter}"`);
                return;
            }

            // Hiển thị dữ liệu đã lọc
            displaySortedData(filteredData);
        }

        function toggleIdColumn() {
            const idCols = document.querySelectorAll('.id-col');
            showIdColumn = !showIdColumn;

            idCols.forEach(col => {
                if (showIdColumn) {
                    col.classList.remove('hidden-col');
                } else {
                    col.classList.add('hidden-col');
                }
            });
        }

        function hideDetailedView() {
            const container = document.getElementById('detailedViewContainer');
            if (container) container.style.display = 'none';

            // Only show main content if comparison view is also hidden
            if (document.getElementById('comparisonViewContainer').style.display === 'none') {
                showMainContent();
            }
        }

        function displayDetailedView(user) {
            if (!user) {
                alert("Không tìm thấy thông tin chi tiết của người dùng.");
                return;
            }

            const { userId, name, rank, juneStats, julyStats } = user;

            // Lấy tháng được chọn từ biến toàn cục
            const juneMonth = selectedMonths.june;
            const julyMonth = selectedMonths.july;

            const statMapping = {
                might: "Might",
                kills: "Kills",
                enemies_captured: "Kẻ Thù Bị Bắt",
                enemies_destroyed: "Kẻ Thù Tiêu Diệt",
                enemy_wounded: "Quân Địch Bị Thương",
                troops_killed: "Quân Đội Đã Giết",
                troops_lost: "Số Quân Tổn Thất",
                troops_wounded: "Quân Đội Bị Thương",
                losses: "Thua",
                successful_attacks: "Tấn công Thành công",
                successful_defenses: "Phòng thủ Thành công",
                victories: "Chiến Thắng",
                win_rate: "Tỉ Lệ Chiến Thắng"
            };

            let tableBodyHtml = '';
            for (const key in statMapping) {
                const statName = statMapping[key];
                const juneValue = juneStats ? juneStats[key] : undefined;
                const julyValue = julyStats ? julyStats[key] : undefined;

                let diffHtml;
                if (key === 'win_rate') {
                    diffHtml = compareWinRates(julyValue, juneValue);
                } else {
                    const diff = calculateDifference(julyValue, juneValue);
                    diffHtml = formatDifference(diff);
                }

                tableBodyHtml += `
            <tr>
                <td class="stat-name">${statName}</td>
                <td style="text-align: right;">${key === 'win_rate' ? (juneValue || '<span class="no-data">N/A</span>') : formatNumber(juneValue)}</td>
                <td style="text-align: right;">${key === 'win_rate' ? (julyValue || '<span class="no-data">N/A</span>') : formatNumber(julyValue)}</td>
                <td style="text-align: right;">${diffHtml}</td>
            </tr>
        `;
            }

            const detailedViewHtml = `
        <div class="detailed-view-card">
            <div class="detailed-view-header">
                <div>
                    <h2>${name}</h2>
                    <span class="user-id">ID: ${userId} | Rank: ${rank}</span>
                </div>
                <div>
                    <button onclick="hideDetailedView()" class="tertiary">Quay lại bảng</button>
                </div>
            </div>
            <div class="detailed-view-body">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left;">Chỉ số</th>
                            <th style="text-align: right;">Tháng ${juneMonth}</th>
                            <th style="text-align: right;">Tháng ${julyMonth}</th>
                            <th style="text-align: right;">Chênh lệch</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBodyHtml}
                    </tbody>
                </table>
            </div>
        </div>
    `;

            const container = document.getElementById('detailedViewContainer');
            container.innerHTML = detailedViewHtml;
            container.style.display = 'block';
        }

        function showDetailedView() {
            // Lấy giá trị tìm kiếm từ ô nhập
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                alert("Vui lòng nhập Tên hoặc ID để xem chi tiết.");
                return;
            }

            // Tìm kiếm người dùng dựa trên tên hoặc ID
            const foundUsers = currentData.filter(item =>
                item.name.toLowerCase().includes(searchTerm) || // Tìm theo tên
                item.userId.toString().includes(searchTerm)    // Tìm theo ID
            );

            if (foundUsers.length === 0) {
                alert(`Không tìm thấy người chơi với Tên hoặc ID chứa: "${searchTerm}"`);
                return;
            }

            // Nếu chỉ tìm thấy một người dùng, hiển thị chi tiết
            if (foundUsers.length === 1) {
                displayDetailedView(foundUsers[0]);
            } else {
                // Nếu tìm thấy nhiều người dùng, hiển thị danh sách lựa chọn
                displayUserSelection(foundUsers);
            }
        }

        function displayUserSelection(users) {
            let selectionHtml = `
        <div class="detailed-view-card">
            <div class="detailed-view-header">
                <h2>Chọn người chơi để xem chi tiết:</h2>
                <button onclick="hideDetailedView()" class="tertiary">Quay lại bảng</button>
            </div>
            <div class="detailed-view-body">
                <ul style="list-style-type: none; padding: 0; margin: 0;">
    `;

            users.forEach(user => {
                selectionHtml += `
            <li style="padding: 10px; border-bottom: 1px solid #eee;">
                <a href="#" onclick="displayDetailedView(currentData.find(item => item.userId === '${user.userId}')); return false;" style="text-decoration: none; color: #2196F3; font-weight: bold;">
                    ${user.name} (ID: ${user.userId})
                </a>
            </li>
        `;
            });

            selectionHtml += `
                </ul>
            </div>
        </div>
    `;

            const container = document.getElementById('detailedViewContainer');
            container.innerHTML = selectionHtml;
            container.style.display = 'block';
        }

        function performMultiComparison() {
            const memberId = document.getElementById('comparisonMemberSelect').value;
            if (!memberId) {
                alert("Vui lòng chọn thành viên chính để so sánh.");
                return;
            }

            const selectedPriorityIds = Array.from(document.querySelectorAll('.priority-compare-checkbox:checked')).map(cb => cb.value);

            if (selectedPriorityIds.length === 0) {
                alert("Vui lòng chọn ít nhất một thành viên ưu tiên để so sánh.");
                return;
            }

            const userToCompare = currentData.find(item => item.userId === memberId);
            const priorityUsers = selectedPriorityIds.map(id => currentData.find(item => item.userId === id));

            renderComparisonResult(userToCompare, priorityUsers);
        }


        function renderComparisonResult(mainUser, comparisonUsers) {
            const resultContainer = document.getElementById('comparisonResult');
            const statMapping = {
                might: "Might", kills: "Kills", enemies_captured: "Kẻ Thù Bị Bắt", enemies_destroyed: "Kẻ Thù Tiêu Diệt",
                enemy_wounded: "Quân Địch Bị Thương", troops_killed: "Quân Đội Đã Giết", troops_lost: "Số Quân Tổn Thất",
                troops_wounded: "Quân Đội Bị Thương", losses: "Thua", successful_attacks: "Tấn công Thành công",
                successful_defenses: "Phòng thủ Thành công", victories: "Chiến Thắng"
            };

            const shortenName = (name) => name.length > 15 ? name.substring(0, 12) + '...' : name;

            // Build table headers dynamically
            let headerHtml = `
                <th style="text-align: left;">Chỉ số</th>
                <th class="positive">${shortenName(mainUser.name)}</th>
            `;
            comparisonUsers.forEach(user => {
                headerHtml += `<th>${shortenName(user.name)}</th>`;
            });

            let tableHtml = `
                <h4>So sánh Tổng (Tháng 7 vs Tháng 6)</h4>
                <table>
                    <thead>
                        <tr>
                            ${headerHtml}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const key in statMapping) {
                let rowHtml = `<tr><td class="stat-name">${statMapping[key]}</td>`;

                // Main user's diff
                const mainUserDiff = calculateDifference(
                    mainUser.julyStats ? mainUser.julyStats[key] : undefined,
                    mainUser.juneStats ? mainUser.juneStats[key] : undefined
                );
                rowHtml += `<td style="text-align: right;">${formatDifference(mainUserDiff)}</td>`;

                // Comparison users' diffs
                comparisonUsers.forEach(user => {
                    const comparisonUserDiff = calculateDifference(
                        user.julyStats ? user.julyStats[key] : undefined,
                        user.juneStats ? user.juneStats[key] : undefined
                    );
                    rowHtml += `<td style="text-align: right;">${formatDifference(comparisonUserDiff)}</td>`;
                });

                rowHtml += '</tr>';
                tableHtml += rowHtml;
            }

            tableHtml += `</tbody></table>`;
            resultContainer.innerHTML = tableHtml;
        }

        // Chức năng xuất ảnh được lấy từ file index.html theo yêu cầu
        async function exportToPNG() {
            if (!currentData.length) {
                alert("Vui lòng tải dữ liệu trước!");
                return;
            }

            // Lấy trực tiếp bảng dữ liệu
            const tableElement = document.getElementById('comparisonTable');

            if (!tableElement) {
                alert(`Không tìm thấy bảng dữ liệu để xuất ảnh.`);
                return;
            }

            // --- Chuẩn bị chụp: Tạm thời bỏ style sticky của header ---
            const thElements = tableElement.querySelectorAll('th');
            const originalThStyles = [];
            thElements.forEach(th => {
                originalThStyles.push(th.style.position);
                th.style.position = 'static';
            });

            // --- Phản hồi UI ---
            const exportButton = document.getElementById('exportPngBtn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = '📸 Đang xử lý...';
            exportButton.disabled = true;

            setTimeout(async () => {
                let stylesRestored = false;
                const restoreStyles = () => {
                    if (!stylesRestored) {
                        thElements.forEach((th, index) => {
                            th.style.position = originalThStyles[index] || '';
                        });
                        stylesRestored = true;
                    }
                };

                try {
                    // Chụp ảnh với kích thước đầy đủ của bảng (bao gồm cả phần bị cuộn)
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });

                    restoreStyles();

                    const imageDataUrl = canvas.toDataURL('image/png');

                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write(`<!DOCTYPE html><html><head><title>Báo cáo so sánh</title></head><body style="margin:0;"><img src="${imageDataUrl}" alt="Báo cáo so sánh" style="max-width: 100%; display: block;"></body></html>`);
                        newWindow.document.close();
                    } else {
                        alert("Không thể mở tab mới. Vui lòng kiểm tra cài đặt chặn pop-up của trình duyệt và thử lại.");
                    }

                } catch (error) {
                    console.error('Lỗi xuất ảnh:', error);
                    alert(`Xuất ảnh thất bại! Lỗi: ${error.message}. Vui lòng thử lại hoặc kiểm tra console (F12).`);
                    restoreStyles(); // Đảm bảo khôi phục nếu có lỗi
                } finally {
                    // --- Khôi phục nút ---
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
            }, 150);
        }

        function exportToExcel() {
            if (currentData.length === 0) {
                alert("Không có dữ liệu để xuất file Excel.");
                return;
            }

            const loading = showLoading("Đang tạo file Excel...");

            setTimeout(() => {
                try {
                    // Lấy dữ liệu đang hiển thị
                    const visibleData = [];
                    const tableRows = document.getElementById('tableBody').getElementsByTagName('tr');
                    for (const row of tableRows) {
                        if (row.style.display !== 'none') {
                            const userId = row.cells[2].innerText;
                            const dataItem = currentData.find(item => item.userId === userId);
                            if (dataItem) visibleData.push(dataItem);
                        }
                    }

                    if (visibleData.length === 0) {
                        alert("Không có dữ liệu nào đang được hiển thị để xuất.");
                        throw new Error("No visible data");
                    }

                    const dataToExport = [];
                    const headers = [
                        "Loại Dữ Liệu", "Tên", "User ID", "Rank", "Might", "Kills",
                        "Kẻ Thù Bị Bắt", "Kẻ Thù Tiêu Diệt", "Quân Địch Bị Thương",
                        "Quân Đội Đã Giết", "Số Quân Tổn Thất", "Quân Đội Bị Thương",
                        "Thua", "Tấn công Thành công", "Phòng thủ Thành công",
                        "Chiến Thắng", "Tỉ Lệ Chiến Thắng"
                    ];

                    // Tiêu đề chính
                    dataToExport.push([`Báo cáo so sánh thống kê - Ngày xuất: ${new Date().toLocaleString('vi-VN')}`]);
                    dataToExport.push([]);
                    dataToExport.push(headers.map(h => ({ v: h, t: 's', s: { font: { bold: true }, alignment: { horizontal: 'center' } } })));

                    // --- Các hàm tiện ích để tạo ô trong Excel ---
                    const createCell = (value, type = 's', format = null, style = {}) => {
                        const cell = { v: value, t: type, s: style };
                        if (format) cell.z = format;
                        return cell;
                    };

                    const createNumericCell = (value) => {
                        if (value === undefined || value === null || value === "Không có dữ liệu") {
                            return createCell("Không có dữ liệu");
                        }
                        return createCell(value, 'n', '#,##0');
                    };

                    const createDiffCell = (diff) => {
                        if (diff === null || diff === undefined) return createCell("N/A");
                        const style = { font: {} };
                        if (diff > 0) style.font.color = { rgb: "FF008000" }; // Green
                        if (diff < 0) style.font.color = { rgb: "FFFF0000" }; // Red
                        return createCell(diff, 'n', '+#,##0;-#,##0;0', style);
                    };

                    const createWinRateDiffCell = (newRate, oldRate) => {
                        if (!newRate || !oldRate) return createCell("N/A");
                        const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
                        const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
                        if (isNaN(newNum) || isNaN(oldNum)) return createCell("N/A");

                        const diff = newNum - oldNum;
                        const style = { font: {} };
                        let text = `${diff.toFixed(2)}%`;
                        if (diff > 0) {
                            style.font.color = { rgb: "FF008000" }; // Green
                            text = `+${text}`;
                        } else if (diff < 0) {
                            style.font.color = { rgb: "FFFF0000" }; // Red
                        }
                        return createCell(text, 's', null, style);
                    };

                    visibleData.forEach(item => {
                        const { userId, name, rank, juneStats, julyStats } = item;
                        const getStat = (stats, key) => (stats ? stats[key] : undefined);

                        const juneRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(juneStats, 'might')), createNumericCell(getStat(juneStats, 'kills')),
                            createNumericCell(getStat(juneStats, 'enemies_captured')), createNumericCell(getStat(juneStats, 'enemies_destroyed')),
                            createNumericCell(getStat(juneStats, 'enemy_wounded')), createNumericCell(getStat(juneStats, 'troops_killed')),
                            createNumericCell(getStat(juneStats, 'troops_lost')), createNumericCell(getStat(juneStats, 'troops_wounded')),
                            createNumericCell(getStat(juneStats, 'losses')), createNumericCell(getStat(juneStats, 'successful_attacks')),
                            createNumericCell(getStat(juneStats, 'successful_defenses')), createNumericCell(getStat(juneStats, 'victories')),
                            createCell(getStat(juneStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(juneRow);

                        const julyRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(julyStats, 'might')), createNumericCell(getStat(julyStats, 'kills')),
                            createNumericCell(getStat(julyStats, 'enemies_captured')), createNumericCell(getStat(julyStats, 'enemies_destroyed')),
                            createNumericCell(getStat(julyStats, 'enemy_wounded')), createNumericCell(getStat(julyStats, 'troops_killed')),
                            createNumericCell(getStat(julyStats, 'troops_lost')), createNumericCell(getStat(julyStats, 'troops_wounded')),
                            createNumericCell(getStat(julyStats, 'losses')), createNumericCell(getStat(julyStats, 'successful_attacks')),
                            createNumericCell(getStat(julyStats, 'successful_defenses')), createNumericCell(getStat(julyStats, 'victories')),
                            createCell(getStat(julyStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(julyRow);

                        const diffRow = [
                            createCell("Tổng", 's', null, { font: { bold: true } }), createCell(""), createCell(""), createCell(""),
                            createDiffCell(calculateDifference(getStat(julyStats, 'might'), getStat(juneStats, 'might'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'kills'), getStat(juneStats, 'kills'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_captured'), getStat(juneStats, 'enemies_captured'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_destroyed'), getStat(juneStats, 'enemies_destroyed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemy_wounded'), getStat(juneStats, 'enemy_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_killed'), getStat(juneStats, 'troops_killed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_lost'), getStat(juneStats, 'troops_lost'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_wounded'), getStat(juneStats, 'troops_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'losses'), getStat(juneStats, 'losses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_attacks'), getStat(juneStats, 'successful_attacks'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_defenses'), getStat(juneStats, 'successful_defenses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'victories'), getStat(juneStats, 'victories'))),
                            createWinRateDiffCell(getStat(julyStats, 'win_rate'), getStat(juneStats, 'win_rate'))
                        ];
                        dataToExport.push(diffRow);

                        dataToExport.push([]); // Dòng trống phân cách
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataToExport);

                    // Tự động điều chỉnh độ rộng cột
                    const objectMaxLength = dataToExport.reduce((acc, row) => {
                        row.forEach((cell, i) => {
                            const cellValue = cell && cell.v ? cell.v : '';
                            const cellLength = String(cellValue).length;
                            acc[i] = Math.max(acc[i] || 0, cellLength);
                        });
                        return acc;
                    }, []);
                    ws["!cols"] = objectMaxLength.map(width => ({ wch: Math.min(width + 2, 40) })); // Giới hạn độ rộng tối đa
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "So Sánh Thống Kê");
                    XLSX.writeFile(wb, `SoSanhThongKe_${new Date().toISOString().slice(0, 10)}.xlsx`);
                } catch (error) {
                    if (error.message === "No visible data") return; // Đã có alert, không cần báo lỗi thêm
                    console.error("Lỗi khi xuất Excel:", error);
                    alert("Đã xảy ra lỗi khi tạo file Excel. Vui lòng kiểm tra console (F12) để biết chi tiết.");
                } finally {
                    loading.remove();
                }
            }, 50);
        }

        function showLoading(message) {
            const loading = document.createElement('div');
            loading.style.position = 'fixed';
            loading.style.top = '0';
            loading.style.left = '0';
            loading.style.width = '100%';
            loading.style.height = '100%';
            loading.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loading.style.display = 'flex';
            loading.style.flexDirection = 'column';
            loading.style.justifyContent = 'center';
            loading.style.alignItems = 'center';
            loading.style.zIndex = '9999';
            loading.innerHTML = `
                <div style="color:white;font-size:20px;margin-bottom:10px;">${message}</div>
                <div class="spinner"></div>
            `;
            document.body.appendChild(loading);
            return loading;
        }

        function resetTable() {
            document.getElementById('searchInput').value = '';
            document.getElementById('priorityIds').value = '416381060,765602761,417896120,537487142,360966484';
            priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
            hideComparisonView();
            hideDetailedView();
            document.body.classList.remove('compact-view');
            document.getElementById('compactViewBtn').textContent = 'Tinh gọn';
            sortTable('name', 'asc');
        }

        // Khởi tạo sự kiện
        window.onload = function () {
            document.getElementById('searchInput').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    searchTable();
                }
            });

            // Thêm sự kiện để xử lý việc chọn file
            document.getElementById('juneFile').addEventListener('change', function (e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : '';
                document.getElementById('juneFileName').textContent = fileName;
                if (fileName) {
                    document.getElementById('juneUrl').value = ''; // Xóa URL nếu đã chọn file
                }
            });

            document.getElementById('julyFile').addEventListener('change', function (e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : '';
                document.getElementById('julyFileName').textContent = fileName;
                if (fileName) {
                    document.getElementById('julyUrl').value = ''; // Xóa URL nếu đã chọn file
                }
            });

            // Thêm sự kiện để xử lý việc nhập URL
            document.getElementById('juneUrl').addEventListener('input', function (e) {
                // Nếu người dùng bắt đầu nhập URL, xóa lựa chọn file
                if (e.target.value.trim() !== '') {
                    document.getElementById('juneFile').value = '';
                    document.getElementById('juneFileName').textContent = '';
                }
            });

            document.getElementById('julyUrl').addEventListener('input', function (e) {
                // Nếu người dùng bắt đầu nhập URL, xóa lựa chọn file
                if (e.target.value.trim() !== '') {
                    document.getElementById('julyFile').value = '';
                    document.getElementById('julyFileName').textContent = '';
                }
            });

            // Khởi tạo giá trị mặc định cho priorityIds
            document.getElementById('priorityIds').value = priorityIds.join(',');

            // === TỰ ĐỘNG ĐIỀN URL MẶC ĐỊNH TỪC TỪ GITHUB ===
            // Người dùng sẽ cần nhấn nút "Tải Dữ Liệu" để bắt đầu
            const juneFileUrl = 'https://docs.google.com/spreadsheets/d/1vxjNifx_pgJjDlZ-FK6_Y2NpzKU1ArcV/edit?gid=45285307#gid=45285307';
            const julyFileUrl = 'https://docs.google.com/spreadsheets/d/1nTET8tLm4cYlci3_LWljMXPlTlxuvBOS/edit?gid=823266667#gid=823266667';

            document.getElementById('juneUrl').value = juneFileUrl;
            document.getElementById('julyUrl').value = julyFileUrl;
        };

        function updateMonth(type) {
            const monthSelect = document.getElementById(`${type}MonthSelect`);
            const selectedMonth = parseInt(monthSelect.value, 10); // Lấy giá trị tháng được chọn
            selectedMonths[type] = selectedMonth; // Lưu tháng được chọn vào biến toàn cục

            const monthTitle = document.getElementById(`monthTitle${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const monthButton = document.querySelector(`button[onclick="loadData('${type}')"]`);

            // Cập nhật tiêu đề và nút
            monthTitle.textContent = `Dữ liệu Tháng ${selectedMonth}`;
            monthButton.textContent = `Tải Dữ Liệu Tháng ${selectedMonth}`;

            // Cập nhật placeholder URL
            const urlInput = document.getElementById(`${type}Url`);
            urlInput.placeholder = `Dán link Google Sheets/GitHub Raw cho Tháng ${selectedMonth}...`;

            // Cập nhật tiêu đề các cột trong bảng
            updateTableHeaders(type, selectedMonth);
        }

        function updateTableHeaders(type, selectedMonth) {
            const columnClass = type === 'june' ? 'month-col-june' : 'month-col-july';
            const headers = document.querySelectorAll(`.${columnClass}`);
            headers.forEach(header => {
                header.textContent = `Tháng ${selectedMonth}`;
            });
        }
        function calculateTotals() {
            const totals = {
                killsDiff: 0,
                troopsLostDiff: 0,
                enemyWoundedDiff: 0,
                troopsKilledDiff: 0,
                troopsWoundedDiff: 0
            };

            currentData.forEach(item => {
                const { juneStats, julyStats } = item;

                // Hàm chuyển đổi giá trị thành số hợp lệ
                const parseValue = (value) => {
                    if (typeof value === 'number') return value;
                    if (typeof value === 'string') {
                        const parsed = parseFloat(value.replace(/[^0-9.-]/g, ''));
                        return isNaN(parsed) ? 0 : parsed;
                    }
                    return 0;
                };

                // Tính tổng Kills
                const killsJune = parseValue(juneStats?.kills);
                const killsJuly = parseValue(julyStats?.kills);
                if (juneStats && julyStats) {
                    const killsDiff = killsJuly - killsJune;
                    totals.killsDiff += killsDiff; // Cộng chênh lệch vào tổng
                }

                // Tính tổng Số Quân Tổn Thất
                const troopsLostJune = parseValue(juneStats?.troops_lost);
                const troopsLostJuly = parseValue(julyStats?.troops_lost);
                if (juneStats && julyStats) {
                    const troopsLostDiff = troopsLostJuly - troopsLostJune;
                    totals.troopsLostDiff += troopsLostDiff;
                }

                // Tính tổng Quân Địch Bị Thương
                const enemyWoundedJune = parseValue(juneStats?.enemy_wounded);
                const enemyWoundedJuly = parseValue(julyStats?.enemy_wounded);
                if (juneStats && julyStats) {
                    const enemyWoundedDiff = enemyWoundedJuly - enemyWoundedJune;
                    totals.enemyWoundedDiff += enemyWoundedDiff;
                }

                // Tính tổng Quân Đội Đã Giết
                const troopsKilledJune = parseValue(juneStats?.troops_killed);
                const troopsKilledJuly = parseValue(julyStats?.troops_killed);
                if (juneStats && julyStats) {
                    const troopsKilledDiff = troopsKilledJuly - troopsKilledJune;
                    totals.troopsKilledDiff += troopsKilledDiff;
                }

                // Tính tổng Quân Đội Bị Thương
                const troopsWoundedJune = parseValue(juneStats?.troops_wounded);
                const troopsWoundedJuly = parseValue(julyStats?.troops_wounded);
                if (juneStats && julyStats) {
                    const troopsWoundedDiff = troopsWoundedJuly - troopsWoundedJune;
                    totals.troopsWoundedDiff += troopsWoundedDiff;
                }
            });

            return totals;
        }
        function displayTotals() {
            const totals = calculateTotals();

            document.getElementById('totalKills').textContent = formatNumber(totals.killsDiff);
            document.getElementById('totalTroopsLost').textContent = formatNumber(totals.troopsLostDiff);
            document.getElementById('totalEnemyWounded').textContent = formatNumber(totals.enemyWoundedDiff);
            document.getElementById('totalTroopsKilled').textContent = formatNumber(totals.troopsKilledDiff);
            document.getElementById('totalTroopsWounded').textContent = formatNumber(totals.troopsWoundedDiff);

            document.getElementById('totalsContainer').style.display = 'block';
        }
        async function showGitHubFiles(type) {
            const githubFilesContainer = document.getElementById(`githubFiles${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const githubFileSelect = document.getElementById(`githubFileSelect${type.charAt(0).toUpperCase() + type.slice(1)}`);

            // Hiển thị container
            githubFilesContainer.style.display = 'block';

            // Gọi GitHub API để lấy danh sách file
            try {
                const response = await fetch('https://api.github.com/repos/heo-sieu-doi/quai-kill/contents/');
                if (!response.ok) {
                    throw new Error(`Lỗi khi gọi GitHub API: ${response.status}`);
                }

                const files = await response.json();
                githubFileSelect.innerHTML = '<option value="">-- Chọn file --</option>'; // Reset danh sách

                // Lọc các file Excel và thêm vào dropdown
                files
                    .filter(file => file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))
                    .forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.download_url; // URL tải file
                        option.textContent = file.name; // Tên file
                        githubFileSelect.appendChild(option);
                    });
            } catch (error) {
                console.error('Lỗi khi lấy danh sách file từ GitHub:', error);
                alert('Không thể lấy danh sách file từ GitHub. Vui lòng thử lại sau.');
            }
        }

        function selectGitHubFile(type) {
            const githubFileSelect = document.getElementById(`githubFileSelect${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const selectedFileUrl = githubFileSelect.value;

            if (selectedFileUrl) {
                // Gán URL file vào ô nhập URL
                document.getElementById(`${type}Url`).value = selectedFileUrl;

                // Tự động tải file
                loadData(type);
            }
        }
        function validateData() {
            currentData.forEach((item, index) => {
                const { juneStats, julyStats } = item;

                const checkValue = (value, key, month) => {
                    if (value === undefined || value === null || isNaN(value)) {
                        console.warn(`Dữ liệu không hợp lệ tại bản ghi ${index + 1}, cột ${key}, tháng ${month}:`, value);
                    }
                };

                if (juneStats) {
                    Object.keys(juneStats).forEach(key => checkValue(juneStats[key], key, 'June'));
                }
                if (julyStats) {
                    Object.keys(julyStats).forEach(key => checkValue(julyStats[key], key, 'July'));
                }
            });
        }
    </script>
</body>

</html>
