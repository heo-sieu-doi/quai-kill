<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• So s√°nh Th·ªëng k√™</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            overflow-x: auto;
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upload-box {
            border: 1px solid #ddd;
            padding: 10px;
            flex: 1;
            border-radius: 4px;
        }

        .upload-box h2 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            margin-right: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.tertiary {
            background-color: #ff9800;
        }

        button.tertiary:hover {
            background-color: #e68a00;
        }

        button.quaternary {
            background-color: #9c27b0;
        }

        button.quaternary:hover {
            background-color: #7b1fa2;
        }

        table {
            border-collapse: collapse;
            /* width: 100%; */
            /* B·ªè width ƒë·ªÉ c·ªôt t·ª± co gi√£n theo n·ªôi dung */
            margin-top: 10px;
            font-size: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 5px;
            /* Gi·∫£m padding cho giao di·ªán g·ªçn h∆°n */
            text-align: left;
            /* CƒÉn l·ªÅ tr√°i cho t·∫•t c·∫£ c√°c c·ªôt */
            white-space: nowrap;
            /* NgƒÉn kh√¥ng cho n·ªôi dung xu·ªëng d√≤ng, gi√∫p c·ªôt co gi√£n */
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        /* Style cho header nh√≥m */
        th[colspan] {
            text-align: left;
            /* CƒÉn l·ªÅ tr√°i cho header nh√≥m */
            padding-left: 10px;
            /* Th√™m kho·∫£ng ƒë·ªám cho d·ªÖ nh√¨n */
            border-bottom: 2px solid #ccc;
            /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi ƒë·∫≠m h∆°n ƒë·ªÉ ph√¢n t√°ch c·∫•p */
            border-right: 2px solid #adadad;
            /* ƒê∆∞·ªùng k·∫ª ph·∫£i ƒë·∫≠m h∆°n ƒë·ªÉ ph√¢n t√°ch c√°c nh√≥m */
            font-weight: bold;
            color: #333;
        }

        th[colspan]:last-child {
            border-right: 1px solid #ddd;
            /* Gi·ªØ border cho c·ªôt cu·ªëi c√πng c·ªßa header */
        }

        /* Th√™m ƒë∆∞·ªùng vi·ªÅn ƒë·∫≠m cho c·ªôt cu·ªëi c·ªßa nh√≥m th√¥ng tin (Rank) */
        .info-group-separator {
            border-right: 2px solid #adadad;
        }

        /* M√†u n·ªÅn cho t·ª´ng nh√≥m ƒë·ªÉ ph√¢n bi·ªát r√µ r√†ng */
        .group-might {
            background-color: #eaf2f8;
        }

        .group-kills {
            background-color: #e8f8f5;
        }

        .group-captured {
            background-color: #fef5e7;
        }

        .group-destroyed {
            background-color: #feebef;
        }

        .group-enemy-wounded {
            background-color: #f4ecf7;
        }

        .group-troops-killed {
            background-color: #d6eaf8;
        }

        .group-troops-lost {
            background-color: #fdedec;
        }

        .group-troops-wounded {
            background-color: #d7bde2;
        }

        .group-losses {
            background-color: #fef9e7;
        }

        .group-attacks {
            background-color: #e8f6f3;
        }

        .group-defenses {
            background-color: #eaeded;
        }

        .group-victories {
            background-color: #a9cce3;
        }

        .group-win-rate {
            background-color: #a3e4d7;
        }

        thead tr:last-child th {
            white-space: nowrap;
            background-color: #f8f9f9;
            /* M√†u n·ªÅn ri√™ng cho header ph·ª• */
        }

        .positive {
            color: green;
            font-weight: bold;
        }

        .negative {
            color: red;
            font-weight: bold;
        }

        .neutral {
            color: #666;
        }

        .no-data {
            color: #999;
            font-style: italic;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .realtime-filter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-filter input[type="checkbox"] {
            margin: 0;
        }

        .status {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .success {
            background-color: #e6ffe6;
            color: #006600;
        }

        .error {
            background-color: #ffebeb;
            color: #cc0000;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .compact-col {
            min-width: 70px;
        }

        .missing-data-row {
            background-color: #f9f9f9;
        }

        .priority-row {
            background-color: #fffacd !important;
        }

        .hidden-col {
            display: none;
        }

        .priority-input {
            margin-top: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .priority-label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .upload-box input[type="file"] {
            margin-bottom: 10px;
        }

        .url-upload-group {
            display: flex;
            gap: 5px;
        }

        .url-upload-group input[type="text"] {
            flex-grow: 1;
            width: auto;
            /* Override width: 100% */
        }

        /* === NEW STYLES FOR COMPARISON VIEW === */
        #comparisonViewContainer {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #9c27b0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .comparison-header h2 {
            margin: 0;
            color: #9c27b0;
            font-size: 1.5em;
        }

        .comparison-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }

        .comparison-controls label {
            font-weight: bold;
        }

        .comparison-controls select,
        .comparison-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .comparison-controls input[type="text"] {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }

        .priority-checkbox-list {
            max-height: 150px;
            /* Gi·ªõi h·∫°n chi·ªÅu cao */
            overflow-y: auto;
            /* Th√™m thanh cu·ªôn khi c·∫ßn */
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            flex-basis: 100%;
            /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông trong flex container */
        }

        .priority-checkbox-list label {
            display: block;
            /* M·ªói checkbox m·ªôt d√≤ng */
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: normal;
            /* B·ªè bold m·∫∑c ƒë·ªãnh c·ªßa label */
        }

        .file-name-display {
            display: block;
            margin-top: 5px;
            font-style: italic;
            color: #555;
            font-size: 12px;
            min-height: 1em;
            /* Gi·ªØ kho·∫£ng tr·ªëng */
        }

        #comparisonResult {
            width: 100%;
            overflow-x: auto;
            /* Th√™m thanh cu·ªôn ngang khi c·∫ßn */
        }

        #comparisonResult table {
            margin-top: 0;
        }

        #comparisonResult th {
            background-color: #f5eef8;
        }

        /* === NEW STYLES FOR DETAILED VIEW === */
        #detailedViewContainer {
            margin-top: 20px;
        }

        .detailed-view-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .detailed-view-body {
            width: 100%;
            overflow-x: auto;
            /* Th√™m thanh cu·ªôn ngang khi c·∫ßn */
        }

        .detailed-view-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 15px;
            gap: 10px;
        }

        .detailed-view-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .detailed-view-header .user-id {
            font-size: 0.9em;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .detailed-view-body table {
            width: 100%;
            border-collapse: collapse;
        }

        .detailed-view-body th,
        .detailed-view-body td {
            padding: 8px;
            /* Gi·∫£m padding cho ƒë·ªìng b·ªô v√† g·ªçn h∆°n */
            border-bottom: 1px solid #eee;
        }

        .detailed-view-body .stat-name {
            text-align: left;
            font-weight: bold;
            color: #555;
        }

        /* === COMPACT VIEW STYLES === */
        /* Hide entire groups not needed in compact view */
        body.compact-view .group-captured,
        body.compact-view .group-captured-cell,
        body.compact-view .group-losses,
        body.compact-view .group-losses-cell,
        body.compact-view .group-attacks,
        body.compact-view .group-attacks-cell,
        body.compact-view .group-defenses,
        body.compact-view .group-defenses-cell,
        body.compact-view .group-victories,
        body.compact-view .group-victories-cell,
        body.compact-view .group-win-rate,
        body.compact-view .group-win-rate-cell,
        body.compact-view .id-col,
        body.compact-view .rank-col {
            /* ·∫®n c·ªôt ID v√† Rank */
            display: none;
        }

        /* In compact view, hide the month columns for the remaining groups */
        body.compact-view .month-col {
            display: none;
        }

        /* In compact view, change the main header text alignment to center since it only has one sub-column */
        body.compact-view th[colspan] {
            text-align: center;
            padding-left: 0;
            /* Reset
             padding */
        }

        .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
            text-align: right;
        }

        body.compact-view .group-troops-killed,
        body.compact-view .group-troops-killed-cell {
            display: none;
        }

        #updateDataModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #updateDataModal>div {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #updateDataModal h2 {
            margin-top: 0;
        }

        #updateDataModal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        #updateDataModal th,
        #updateDataModal td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
            white-space: nowrap;
        }

        #updateDataModal th {
            background-color: #f2f2f2;
        }

        #updateDataModal>div {
            max-height: 90vh;
            /* Gi·ªõi h·∫°n chi·ªÅu cao modal t·ªëi ƒëa l√† 90% chi·ªÅu cao m√†n h√¨nh */
            overflow-y: auto;
            /* Th√™m thanh cu·ªôn d·ªçc n·∫øu n·ªôi dung v∆∞·ª£t qu√° chi·ªÅu cao */
        }

        #updateDataTableContainer {
            max-height: 60vh;
            /* Gi·ªõi h·∫°n chi·ªÅu cao b·∫£ng */
            overflow-y: auto;
            /* Th√™m thanh cu·ªôn d·ªçc */
            border: 1px solid #ddd;
            /* Th√™m vi·ªÅn */
            padding: 10px;
            /* Th√™m kho·∫£ng c√°ch b√™n trong */
            background-color: #f9f9f9;
            /* M√†u n·ªÅn nh·∫π */
            position: relative;
            /* ƒê·∫£m b·∫£o sticky ho·∫°t ƒë·ªông tr√™n Safari */
        }

        th,
        td {
            white-space: nowrap;
            overflow-wrap: break-word;
            /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng b·ªã tr√†n */
        }

        #updateDataModal table thead th {
            position: sticky;
            top: 0;
            background-color: #ce8686;
            /* M√†u n·ªÅn cho ti√™u ƒë·ªÅ */
            z-index: 1;
        }

        .upload-section {
            display: flex;
            margin-bottom: 10px;
        }

        .upload-box {
            margin-right: 10px;
            /* Thay th·∫ø gap */
        }

        /* Styles for Chart Modal */
        #chartModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #chartModal>div {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
        }

        #chartModal .chart-controls {
            margin-bottom: 15px;
        }

        #chartModal .chart-controls select {
            padding: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>C√¥ng c·ª• So s√°nh Th·ªëng k√™</h1>

        <div class="upload-section">
            <div class="upload-box">
                <h2 id="monthTitleJune">D·ªØ li·ªáu Th√°ng 6</h2>
                <label for="juneMonthSelect">Ch·ªçn th√°ng:</label>
                <select id="juneMonthSelect" onchange="updateMonth('june')">
                    <option value="1">Th√°ng 1</option>
                    <option value="2">Th√°ng 2</option>
                    <option value="3">Th√°ng 3</option>
                    <option value="4">Th√°ng 4</option>
                    <option value="5">Th√°ng 5</option>
                    <option value="6" selected>Th√°ng 6</option>
                    <option value="7">Th√°ng 7</option>
                    <option value="8">Th√°ng 8</option>
                    <option value="9">Th√°ng 9</option>
                    <option value="10">Th√°ng 10</option>
                    <option value="11">Th√°ng 11</option>
                    <option value="12">Th√°ng 12</option>
                </select>
                <label for="juneFile">1. T·∫£i t·ª´ m√°y (∆∞u ti√™n):</label>
                <input type="file" id="juneFile" accept=".xlsx,.xls" />
                <span class="file-name-display" id="juneFileName"></span>
                <label for="juneUrl" style="margin-top:10px; display:block;">2. Ho·∫∑c d√°n URL v√†o ƒë√¢y:</label>
                <input type="text" id="juneUrl" placeholder="D√°n link Google Sheets/GitHub Raw cho Th√°ng 6...">
                <button onclick="loadData('june')" class="secondary" style="width: 100%; margin-top: 10px;">T·∫£i D·ªØ Li·ªáu
                    Th√°ng 6</button>
                <button onclick="showGitHubFiles('june')" class="secondary" style="width: 100%; margin-top: 10px;">Ch·ªçn
                    t·ªáp t·ª´ GitHub</button>
                <div id="githubFilesJune" style="display: none; margin-top: 10px;">
                    <label for="githubFileSelectJune">Ch·ªçn file:</label>
                    <select id="githubFileSelectJune" onchange="selectGitHubFile('june')">
                        <option value="">-- Ch·ªçn file --</option>
                    </select>
                </div>
                <div id="juneStatus" class="status"></div>
            </div>

            <div class="upload-box">
                <h2 id="monthTitleJuly">D·ªØ li·ªáu Th√°ng 7</h2>
                <label for="julyMonthSelect">Ch·ªçn th√°ng:</label>
                <select id="julyMonthSelect" onchange="updateMonth('july')">
                    <option value="1">Th√°ng 1</option>
                    <option value="2">Th√°ng 2</option>
                    <option value="3">Th√°ng 3</option>
                    <option value="4">Th√°ng 4</option>
                    <option value="5">Th√°ng 5</option>
                    <option value="6">Th√°ng 6</option>
                    <option value="7" selected>Th√°ng 7</option>
                    <option value="8">Th√°ng 8</option>
                    <option value="9">Th√°ng 9</option>
                    <option value="10">Th√°ng 10</option>
                    <option value="11">Th√°ng 11</option>
                    <option value="12">Th√°ng 12</option>
                </select>
                <label for="julyFile">1. T·∫£i t·ª´ m√°y (∆∞u ti√™n):</label>
                <input type="file" id="julyFile" accept=".xlsx,.xls" />
                <span class="file-name-display" id="julyFileName"></span>
                <label for="julyUrl" style="margin-top:10px; display:block;">2. Ho·∫∑c d√°n URL v√†o ƒë√¢y:</label>
                <input type="text" id="julyUrl" placeholder="D√°n link Google Sheets/GitHub Raw cho Th√°ng 7...">
                <button onclick="loadData('july')" class="secondary" style="width: 100%; margin-top: 10px;">T·∫£i D·ªØ Li·ªáu
                    Th√°ng 7</button>
                <button onclick="showGitHubFiles('july')" class="secondary" style="width: 100%; margin-top: 10px;">Ch·ªçn
                    t·ªáp t·ª´ GitHub</button>
                <div id="githubFilesJuly" style="display: none; margin-top: 10px;">
                    <label for="githubFileSelectJuly">Ch·ªçn file:</label>
                    <select id="githubFileSelectJuly" onchange="selectGitHubFile('july')">
                        <option value="">-- Ch·ªçn file --</option>
                    </select>
                </div>
                <div id="julyStatus" class="status"></div>
            </div>
        </div>

        <div class="filter-controls">
            <div class="filter-section">
                <label class="priority-label">ID ∆∞u ti√™n (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
                <input type="text" id="priorityIds" class="priority-input"
                    placeholder="Nh·∫≠p c√°c ID ∆∞u ti√™n, v√≠ d·ª•: 123,456,789"
                    value="416381060,765602761,417896120,537487142,360966484" />
                <div class="action-buttons">
                    <button onclick="applyPriorityFilter()" class="secondary">√Åp d·ª•ng l·ªçc</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="flex: 1;">
                <input type="text" id="searchInput" placeholder="T√¨m theo t√™n ho·∫∑c ID..." />
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="searchTable()">T√¨m ki·∫øm</button>
                    <button onclick="showDetailedView()" class="secondary">Xem chi ti·∫øt</button>
                    <button id="compactViewBtn" onclick="toggleCompactView()" class="tertiary">Tinh g·ªçn</button>
                    <button onclick="showComparisonView()" class="quaternary">So s√°nh v·ªõi ∆Øu ti√™n</button>
                    <button onclick="sortTable('killsDiff', 'asc')" class="secondary">S·∫Øp x·∫øp Kills (TƒÉng)</button>
                    <button onclick="sortTable('killsDiff', 'desc')" class="secondary">S·∫Øp x·∫øp Kills (Gi·∫£m)</button>
                    <button onclick="toggleIdColumn()" class="tertiary">·∫®n/Hi·ªán ID</button>
                    <button id="exportPngBtn" onclick="exportToPNGByRange()" class="tertiary">Xu·∫•t ·∫£nh theo ph·∫°m
                        vi</button>
                    <button onclick="exportToExcel()" class="quaternary">Xu·∫•t Excel (ƒê·∫ßy ƒë·ªß)</button>
                    <button onclick="exportToCompactExcel()" class="quaternary">Xu·∫•t Excel (Tinh g·ªçn)</button>
                    <button onclick="resetTable()">ƒê·∫∑t l·∫°i</button>
                    <button id="updateDataBtn" onclick="showUpdateDataModal()" class="secondary">C·∫≠p nh·∫≠t d·ªØ
                        li·ªáu</button>
                    <button onclick="showChartModal()" class="secondary">Hi·ªÉn th·ªã Bi·ªÉu ƒë·ªì</button>
                    <button onclick="showOverallComparisonChart()" class="secondary">Bi·ªÉu ƒë·ªì so s√°nh</button>
                </div>
            </div>
        </div>
        <div id="totalsContainer"
            style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; display: none;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">T·ªïng Th·ªëng K√™</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div><strong>T·ªïng Kills:</strong> <span id="totalKills">0</span></div>
                <div><strong>T·ªïng S·ªë Qu√¢n T·ªïn Th·∫•t:</strong> <span id="totalTroopsLost">0</span></div>
                <div><strong>T·ªïng Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng:</strong> <span id="totalEnemyWounded">0</span></div>
                <div><strong>T·ªïng Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng:</strong> <span id="totalTroopsWounded">0</span></div>
                <div><strong>T·ªïng K·∫ª Th√π Ti√™u Di·ªát:</strong> <span id="totalEnemiesDestroyed">0</span></div>
                <!-- Th√™m d√≤ng n√†y -->
            </div>
        </div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ƒêang x·ª≠ l√Ω...</p>
        </div>

        <div id="tableContainer">
            <table id="comparisonTable">
                <thead>
                    <!-- D√≤ng ti√™u ƒë·ªÅ ch√≠nh -->
                    <tr>
                        <th rowspan="2">STT</th>
                        <th rowspan="2">T√™n</th>
                        <th rowspan="2" class="id-col">User ID</th>
                        <th rowspan="2" class="info-group-separator rank-col">Rank</th>
                        <th colspan="3" class="group-might">Might</th>
                        <th colspan="3" class="group-kills">Kills</th>
                        <th colspan="3" class="group-captured">K·∫ª Th√π B·ªã B·∫Øt</th>
                        <th colspan="3" class="group-destroyed">K·∫ª Th√π Ti√™u Di·ªát</th>
                        <th colspan="3" class="group-enemy-wounded">Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng</th>
                        <th colspan="3" class="group-troops-killed">Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt</th>
                        <th colspan="3" class="group-troops-lost">S·ªë Qu√¢n T·ªïn Th·∫•t</th>
                        <th colspan="3" class="group-troops-wounded">Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng</th>
                        <th colspan="3" class="group-losses">Thua</th>
                        <th colspan="3" class="group-attacks">T·∫•n c√¥ng Th√†nh c√¥ng</th>
                        <th colspan="3" class="group-defenses">Ph√≤ng th·ªß Th√†nh c√¥ng</th>
                        <th colspan="3" class="group-victories">Chi·∫øn Th·∫Øng</th>
                        <th colspan="3" class="group-win-rate">T·ªâ L·ªá Chi·∫øn Th·∫Øng</th>
                    </tr>
                    <!-- D√≤ng ti√™u ƒë·ªÅ ph·ª• -->
                    <tr id="sub-header-row">
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                        <th class="month-col month-col-june">Th√°ng 6</th>
                        <th class="month-col month-col-july">Th√°ng 7</th>
                        <th class="diff-col">T·ªïng</th>
                </thead>
                <tbody id="tableBody">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <!-- Container for the new comparison view -->
        <div id="comparisonViewContainer" style="display: none;"></div>

        <!-- Container for the new detailed vertical view -->
        <div id="detailedViewContainer" style="display: none;"></div>
        <div id="updateDataModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999;">
            <div
                style="background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                <h2 style="margin-top: 0;">C·∫≠p nh·∫≠t d·ªØ li·ªáu</h2>
                <button onclick="showGitHubFilesForUpdate()" class="secondary">Ch·ªçn t·ªáp t·ª´ GitHub</button>
                <div id="githubFilesUpdate" style="display: none; margin-top: 10px;">
                    <label for="githubFileSelectUpdate">Ch·ªçn file:</label>
                    <select id="githubFileSelectUpdate" onchange="loadGitHubFileForUpdate()">
                        <option value="">-- Ch·ªçn file --</option>
                    </select>
                </div>
                <div id="updateDataTableContainer"
                    style="margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n</th>
                                <th>User ID</th>
                                <th>Rank</th>
                                <th>Might</th>
                                <th>Kills</th>
                                <th>K·∫ª Th√π B·ªã B·∫Øt</th>
                                <th>K·∫ª Th√π Ti√™u Di·ªát</th>
                                <th>Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng</th>
                                <th>Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt</th>
                                <th>S·ªë Qu√¢n T·ªïn Th·∫•t</th>
                                <th>Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng</th>
                                <th>Thua</th>
                                <th>T·∫•n c√¥ng Th√†nh c√¥ng</th>
                                <th>Ph√≤ng th·ªß Th√†nh c√¥ng</th>
                                <th>Chi·∫øn Th·∫Øng</th>
                                <th>T·ªâ L·ªá Chi·∫øn Th·∫Øng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
                <button onclick="addNewRow()" class="secondary" style="margin-top: 10px;">Th√™m D·ªØ Li·ªáu M·ªõi</button>
                <button onclick="saveUpdatedData()" class="secondary" style="margin-top: 10px;">L∆∞u thay ƒë·ªïi</button>
                <button onclick="closeUpdateDataModal()" class="tertiary" style="float: right;">ƒê√≥ng</button>
            </div>
        </div>
        <!-- Chart Modal -->
        <div id="chartModal">
            <div>
                <h2 style="margin-top: 0;">Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Ch·ªâ s·ªë</h2>
                <div class="chart-controls">
                    <label for="playerSelectChart">Ch·ªçn ng∆∞·ªùi ch∆°i:</label>
                    <select id="playerSelectChart" onchange="updateChart()"></select>
                </div>
                <div style="position: relative; height:60vh; width:100%">
                    <canvas id="statsChart"></canvas>
                </div>
                <button onclick="hideChartModal()" class="tertiary"
                    style="float: right; margin-top: 15px;">ƒê√≥ng</button>
            </div>
        </div>
        <!-- Overall Comparison Chart Modal -->
        <div id="overallComparisonChartModal"
            style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
            <div
                style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 8px;">
                <h2 style="margin-top: 0;">Bi·ªÉu ƒë·ªì So s√°nh T·ªïng quan Ng∆∞·ªùi ch∆°i</h2>
                <button id="toggleOverallChartBtn" class="secondary">Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu</button>
                <div id="overallChartContainer" style="position: relative; height: 80vh; overflow-y: auto;">
                    <!-- Bi·ªÉu ƒë·ªì s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <button onclick="exportComparisonChartPDF()">üìÑ Xu·∫•t PDF</button>
                    <button onclick="hideOverallComparisonChart()" class="tertiary">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let juneData = {};
        let julyData = {};
        let chartInstance;
        let currentData = [];
        let showIdColumn = true;
        window.showMonthlyDataOverall = false; // Track whether to show monthly data or total diff
        let priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
        let currentSort = { column: 'name', direction: 'asc' };
        let selectedMonths = {
            june: 6, // M·∫∑c ƒë·ªãnh l√† th√°ng 6
            july: 7  // M·∫∑c ƒë·ªãnh l√† th√°ng 7
        };

        // ƒêƒÉng k√Ω plugin datalabels cho t·∫•t c·∫£ c√°c bi·ªÉu ƒë·ªì
        Chart.register(ChartDataLabels);

        // M·∫£ng c·∫•u h√¨nh cho c√°c ch·ªâ s·ªë ƒë·ªÉ tr√°nh l·∫∑p code
        const STATS_CONFIG = [
            { key: 'might', name: 'Might', groupClass: 'group-might-cell' },
            { key: 'kills', name: 'Kills', groupClass: 'group-kills-cell' },
            { key: 'enemies_captured', name: 'K·∫ª Th√π B·ªã B·∫Øt', groupClass: 'group-captured-cell' },
            { key: 'enemies_destroyed', name: 'K·∫ª Th√π Ti√™u Di·ªát', groupClass: 'group-destroyed-cell' },
            { key: 'enemy_wounded', name: 'Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng', groupClass: 'group-enemy-wounded-cell' },
            { key: 'troops_killed', name: 'Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt', groupClass: 'group-troops-killed-cell' },
            { key: 'troops_lost', name: 'S·ªë Qu√¢n T·ªïn Th·∫•t', groupClass: 'group-troops-lost-cell' },
            { key: 'troops_wounded', name: 'Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng', groupClass: 'group-troops-wounded-cell' },
            { key: 'losses', name: 'Thua', groupClass: 'group-losses-cell' },
            { key: 'successful_attacks', name: 'T·∫•n c√¥ng Th√†nh c√¥ng', groupClass: 'group-attacks-cell' },
            { key: 'successful_defenses', name: 'Ph√≤ng th·ªß Th√†nh c√¥ng', groupClass: 'group-defenses-cell' },
            { key: 'victories', name: 'Chi·∫øn Th·∫Øng', groupClass: 'group-victories-cell' }
        ];

        // H√†m t·∫£i d·ªØ li·ªáu v·ªõi logic ∆∞u ti√™n
        function loadData(type) {
            const fileInput = document.getElementById(`${type}File`);
            const urlInput = document.getElementById(`${type}Url`);

            // ∆Øu ti√™n 1: Ki·ªÉm tra file ƒë√£ ch·ªçn
            if (fileInput.files.length > 0) {
                handleFileUpload(fileInput.files[0], type);
            }
            // ∆Øu ti√™n 2: Ki·ªÉm tra URL
            else if (urlInput.value.trim() !== '') {
                loadFromUrl(type);
            }
            // Kh√¥ng c√≥ ngu·ªìn d·ªØ li·ªáu
            else {
                alert(`Vui l√≤ng ch·ªçn m·ªôt file ho·∫∑c d√°n URL cho th√°ng ${type === 'june' ? '6' : '7'}.`);
            }
        }
        // H√†m x·ª≠ l√Ω upload file
        function handleFileUpload(file, type) {
            const reader = new FileReader();
            const statusElement = document.getElementById(`${type}Status`);

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (type === 'june') {
                        juneData = processData(jsonData);
                        statusElement.textContent = `ƒê√£ t·∫£i th√°ng 6: ${Object.keys(juneData).length} ng∆∞·ªùi ch∆°i`;
                        statusElement.className = 'status success';
                    } else {
                        julyData = processData(jsonData);
                        statusElement.textContent = `ƒê√£ t·∫£i th√°ng 7: ${Object.keys(julyData).length} ng∆∞·ªùi ch∆°i`;
                        statusElement.className = 'status success';
                    }

                    if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                        compareData();
                    }
                } catch (error) {
                    statusElement.textContent = `L·ªói: ${error.message}`;
                    statusElement.className = 'status error';
                }
            };

            reader.onerror = function () {
                statusElement.textContent = `L·ªói ƒë·ªçc file`;
                statusElement.className = 'status error';
            };

            reader.readAsArrayBuffer(file);
        }

        // H√†m t·∫£i t·ª´ URL, ƒë∆∞·ª£c l·∫•y v√† ch·ªânh s·ª≠a t·ª´ file index.html
        async function loadFromUrl(type) {
            const urlInputId = `${type}Url`;
            const statusElementId = `${type}Status`;
            const urlInput = document.getElementById(urlInputId);
            const statusElement = document.getElementById(statusElementId);

            const rawUrl = urlInput.value.trim();
            if (!rawUrl) {
                alert(`Vui l√≤ng nh·∫≠p URL cho th√°ng ${type === 'june' ? '6' : '7'}!`);
                return;
            }

            let exportUrl = '';
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                const sheetId = match[1];
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                exportUrl = rawUrl;
            } else {
                alert("URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng cung c·∫•p link Google Sheets/File h·ª£p l·ªá (ƒë√£ chia s·∫ª c√¥ng khai) ho·∫∑c link tr·ª±c ti·∫øp ƒë·∫øn file .xlsx.");
                return;
            }

            statusElement.textContent = 'ƒêang t·∫£i t·ª´ URL...';
            statusElement.className = 'status';
            const loading = showLoading(`ƒêang t·∫£i d·ªØ li·ªáu th√°ng ${type === 'june' ? '6' : '7'}...`);

            try {
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
                const fetchUrl = proxyUrl + encodeURIComponent(exportUrl);

                const response = await fetch(fetchUrl, { signal: AbortSignal.timeout(30000) });

                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !(contentType.includes('spreadsheetml.sheet') || contentType.includes('application/vnd.ms-excel') || contentType.includes('octet-stream'))) {
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();
                    if (responseText.trim().toLowerCase().startsWith('<html') || responseText.trim().toLowerCase().startsWith('<!doctype html')) {
                        throw new Error("L·ªói ƒë·ªãnh d·∫°ng: Nh·∫≠n ƒë∆∞·ª£c HTML thay v√¨ file Excel. ƒê·∫£m b·∫£o link ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.");
                    }
                }

                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength < 100) {
                    throw new Error("T·∫£i file th·∫•t b·∫°i: File nh·∫≠n ƒë∆∞·ª£c qu√° nh·ªè.");
                }

                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                const processed = processData(jsonData);
                if (type === 'june') {
                    juneData = processed;
                    statusElement.textContent = `ƒê√£ t·∫£i th√°ng 6 t·ª´ URL: ${Object.keys(juneData).length} ng∆∞·ªùi ch∆°i`;
                    statusElement.className = 'status success';
                } else {
                    julyData = processed;
                    statusElement.textContent = `ƒê√£ t·∫£i th√°ng 7 t·ª´ URL: ${Object.keys(julyData).length} ng∆∞·ªùi ch∆°i`;
                    statusElement.className = 'status success';
                }

                if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                    compareData();
                }
            } catch (error) {
                console.error(`L·ªói khi t·∫£i URL cho ${type}:`, error);
                statusElement.textContent = `L·ªói t·∫£i URL: ${error.message}`;
                statusElement.className = 'status error';
            } finally {
                loading.remove();
            }
        }

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu
        function processData(sheetData) {
            const result = {};
            let headerRowIndex = -1;

            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row && row.includes("User ID")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) throw new Error("Kh√¥ng t√¨m th·∫•y h√†ng ti√™u ƒë·ªÅ");

            const headers = sheetData[headerRowIndex];
            const getColIndex = (headerName) => {
                const possibleNames = Array.isArray(headerName) ? headerName.map(n => n.toLowerCase()) : [headerName.toLowerCase()];
                for (const name of possibleNames) {
                    const index = headers.findIndex(h => h && h.toString().trim().toLowerCase() === name);
                    if (index !== -1) return index;
                }
                return -1;
            };

            const indices = {
                name: getColIndex("Name"),
                userId: getColIndex("User ID"),
                rank: getColIndex("Rank"),
                might: getColIndex("Might"),
                kills: getColIndex("Kills"),
                enemiesCaptured: getColIndex("Enemies captured"),
                enemiesDestroyed: getColIndex("Enemies Destroyed Might"),
                enemyWounded: getColIndex("Enemy Troops Wounded"),
                troopsKilled: getColIndex("Troops Killed"),
                troopsLost: getColIndex("Troops Lost"),
                troopsWounded: getColIndex("Troops Wounded"),
                losses: getColIndex("Losses"),
                successfulAttacks: getColIndex("Successful Attacks"),
                successfulDefenses: getColIndex("Ph√≤ng th·ªß th√†nh c√¥ng"),
                victories: getColIndex("Victories"),
                winRate: getColIndex("Win Rate")
            };

            for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;

                const userId = row[indices.userId];
                if (!userId) continue;

                const getValue = (index, defaultValue = 0) => {
                    if (index === -1) return defaultValue;
                    const val = row[index];
                    if (val === undefined || val === null) return defaultValue;
                    if (typeof val === 'number') return val;
                    // Only parse numbers from strings if it's not the win_rate column
                    if (typeof val === 'string' && index !== indices.winRate) {
                        const num = parseFloat(val.replace(/[^0-9.-]/g, ''));
                        return isNaN(num) ? defaultValue : num;
                    }
                    return defaultValue;
                };

                result[userId] = {
                    name: row[indices.name] || 'Kh√¥ng x√°c ƒë·ªãnh',
                    rank: row[indices.rank] || 'Kh√¥ng x√°c ƒë·ªãnh',
                    might: getValue(indices.might),
                    kills: getValue(indices.kills),
                    enemies_captured: getValue(indices.enemiesCaptured),
                    enemies_destroyed: getValue(indices.enemiesDestroyed),
                    enemy_wounded: getValue(indices.enemyWounded),
                    troops_killed: getValue(indices.troopsKilled),
                    troops_lost: getValue(indices.troopsLost),
                    troops_wounded: getValue(indices.troopsWounded),
                    losses: getValue(indices.losses),
                    successful_attacks: getValue(indices.successfulAttacks),
                    successful_defenses: getValue(indices.successfulDefenses),
                    victories: getValue(indices.victories),
                    win_rate: row[indices.winRate] ? row[indices.winRate].toString() : '0%'
                };
            }

            return result;
        }


        // H√†m so s√°nh d·ªØ li·ªáu
        function compareData() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';

            setTimeout(() => {
                try {
                    const allUserIds = new Set([...Object.keys(juneData), ...Object.keys(julyData)]);
                    currentData = [];

                    Array.from(allUserIds).forEach(userId => {
                        const juneStats = juneData[userId];
                        const julyStats = julyData[userId];

                        if (!juneStats && !julyStats) return;

                        const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                        const isPriority = priorityIds.includes(userId);

                        currentData.push({
                            userId,
                            name: julyStats?.name || juneStats?.name || 'Kh√¥ng x√°c ƒë·ªãnh',
                            rank: julyStats?.rank || juneStats?.rank || 'Kh√¥ng x√°c ƒë·ªãnh',
                            juneStats,
                            julyStats,
                            killsDiff,
                            hasBothData: juneStats && julyStats,
                            isPriority
                        });
                    });

                    // S·∫Øp x·∫øp theo t√™n m·∫∑c ƒë·ªãnh thay v√¨ √°p d·ª•ng b·ªô l·ªçc ∆∞u ti√™n ngay
                    sortTable('name', 'asc');

                } catch (error) {
                    console.error('L·ªói khi so s√°nh:', error);
                } finally {
                    loadingElement.style.display = 'none';
                }
            }, 100);
        }


        // H√†m c·∫≠p nh·∫≠t ID ∆∞u ti√™n
        function updatePriorityIds() {
            const input = document.getElementById('priorityIds').value;
            priorityIds = input.split(',')
                .map(id => id.trim())
                .filter(id => id !== '');

            currentData.forEach(item => {
                item.isPriority = priorityIds.includes(item.userId);
            });
        }

        // H√†m √°p d·ª•ng b·ªô l·ªçc ∆∞u ti√™n
        function applyPriorityFilter() {
            updatePriorityIds();

            const sortedData = [...currentData].sort((a, b) => {
                // Logic ∆∞u ti√™n
                const aIsPriority = a.isPriority;
                const bIsPriority = b.isPriority;

                if (aIsPriority && !bIsPriority) return -1;
                if (!aIsPriority && bIsPriority) return 1;

                // N·∫øu c·∫£ hai c√πng tr·∫°ng th√°i ∆∞u ti√™n (ho·∫∑c c√πng kh√¥ng), s·∫Øp x·∫øp theo ti√™u ch√≠ hi·ªán t·∫°i
                if (currentSort.column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return currentSort.direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else { // S·∫Øp x·∫øp theo t√™n
                    return currentSort.direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // H√†m s·∫Øp x·∫øp b·∫£ng
        function sortTable(column, direction) {
            if (!currentData.length) return;

            currentSort = { column, direction };

            const sortedData = [...currentData].sort((a, b) => {
                // B·ªè ho√†n to√†n logic ∆∞u ti√™n ·ªü ƒë√¢y
                if (column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else {
                    return direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // H√†m hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ s·∫Øp x·∫øp
        function displaySortedData(sortedData) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©

            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu th√°ng 6 hay kh√¥ng
            juneDataExists = Object.keys(juneData).length > 0;

            // ·∫®n ho·∫∑c hi·ªán c√°c c·ªôt th√°ng 6 d·ª±a tr√™n bi·∫øn juneDataExists
            const juneColumns = document.querySelectorAll('.month-col-june');
            juneColumns.forEach(column => column.style.display = juneDataExists ? '' : 'none');


            sortedData.forEach((item, index) => {
                const { userId, name, rank, juneStats, julyStats, hasBothData, isPriority } = item;
                const row = document.createElement('tr');

                if (!hasBothData) row.classList.add('missing-data-row');
                if (isPriority) row.classList.add('priority-row');

                // T·∫°o HTML cho c√°c ch·ªâ s·ªë b·∫±ng c√°ch l·∫∑p qua m·∫£ng c·∫•u h√¨nh
                let statsHtml = '';
                STATS_CONFIG.forEach(stat => {
                    const diff = calculateDifference(julyStats?.[stat.key], juneStats?.[stat.key]);
                    statsHtml += `
                <td class="${stat.groupClass} month-col">${formatNumber(juneStats?.[stat.key])}</td>
                <td class="${stat.groupClass} month-col">${formatNumber(julyStats?.[stat.key])}</td>
                <td class="${stat.groupClass} diff-col">${formatDifference(diff)}</td>
            `;
                });

                // X·ª≠ l√Ω ri√™ng cho T·ªâ l·ªá th·∫Øng
                const winRateDiff = compareWinRates(julyStats?.win_rate, juneStats?.win_rate);
                const winRateHtml = `
            <td class="group-win-rate-cell month-col">${juneStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
            <td class="group-win-rate-cell month-col">${julyStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
            <td class="group-win-rate-cell diff-col">${winRateDiff}</td>
        `;

                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${name}</td>
            <td class="id-col">${userId}</td>
            <td class="rank-col">${rank}</td>
            ${statsHtml}
            ${winRateHtml}
        `;

                tableBody.appendChild(row);
            });

            // Hi·ªÉn th·ªã t·ªïng
            displayTotals();
        }

        function toggleCompactView() {
            const body = document.body;
            const btn = document.getElementById('compactViewBtn');
            const isCompact = body.classList.toggle('compact-view'); // toggle() tr·∫£ v·ªÅ true n·∫øu class ƒë∆∞·ª£c th√™m v√†o

            const mainHeaders = document.querySelectorAll('#comparisonTable th[colspan]');
            const subHeaderRow = document.getElementById('sub-header-row');

            if (isCompact) {
                // Khi ·ªü ch·∫ø ƒë·ªô Tinh g·ªçn
                btn.textContent = 'Xem ƒë·∫ßy ƒë·ªß';
                mainHeaders.forEach(th => th.setAttribute('colspan', '1')); // ƒê·∫∑t colspan v·ªÅ 1
                if (subHeaderRow) subHeaderRow.style.display = 'none'; // ·∫®n h√†ng ti√™u ƒë·ªÅ ph·ª•
            } else {
                // Khi ·ªü ch·∫ø ƒë·ªô Xem ƒë·∫ßy ƒë·ªß
                btn.textContent = 'Tinh g·ªçn';
                mainHeaders.forEach(th => th.setAttribute('colspan', '3')); // Tr·∫£ colspan v·ªÅ 3
                if (subHeaderRow) subHeaderRow.style.display = ''; // Hi·ªán l·∫°i h√†ng ti√™u ƒë·ªÅ ph·ª•
            }
        }

        // C√°c h√†m ti·ªán √≠ch
        function formatNumber(num) {
            if (num === undefined || num === null) return '<span class="no-data">N/A</span>';
            return num.toLocaleString();
        }

        function calculateDifference(newVal, oldVal) {
            if (newVal === undefined || oldVal === undefined) return null;
            return newVal - oldVal;
        }

        function formatDifference(diff) {
            if (diff === null) return '<span class="no-data">N/A</span>';
            if (diff > 0) return `<span class="positive">+${formatNumber(diff)}</span>`;
            if (diff < 0) return `<span class="negative">${formatNumber(diff)}</span>`;
            return `<span class="neutral">0</span>`;
        }

        function compareWinRates(newRate, oldRate) {
            if (!newRate || !oldRate) return '<span class="no-data">N/A</span>';

            const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
            const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
            const diff = newNum - oldNum;

            if (diff > 0) return `<span class="positive">+${diff.toFixed(2)}%</span>`;
            if (diff < 0) return `<span class="negative">${diff.toFixed(2)}%</span>`;
            return `<span class="neutral">0%</span>`;
        }

        // C√°c h√†m x·ª≠ l√Ω giao di·ªán
        function searchTable() {
            // L·∫•y gi√° tr·ªã t√¨m ki·∫øm t·ª´ √¥ nh·∫≠p
            const input = document.getElementById('searchInput');
            const filter = input.value.trim().toLowerCase();

            if (!filter) {
                alert("Vui l√≤ng nh·∫≠p T√™n ho·∫∑c ID ƒë·ªÉ t√¨m ki·∫øm.");
                return;
            }

            // L·ªçc d·ªØ li·ªáu trong currentData
            const filteredData = currentData.filter(item =>
                item.name.toLowerCase().includes(filter) || // T√¨m theo t√™n
                item.userId.toString().includes(filter)    // T√¨m theo ID
            );

            if (filteredData.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i v·ªõi T√™n ho·∫∑c ID ch·ª©a: "${filter}"`);
                return;
            }

            // Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc
            displaySortedData(filteredData);
        }

        function toggleIdColumn() {
            const idCols = document.querySelectorAll('.id-col');
            showIdColumn = !showIdColumn;

            idCols.forEach(col => {
                if (showIdColumn) {
                    col.classList.remove('hidden-col');
                } else {
                    col.classList.add('hidden-col');
                }
            });
        }

        function hideDetailedView() {
            const container = document.getElementById('detailedViewContainer');
            if (container) container.style.display = 'none';

            // Only show main content if comparison view is also hidden
            if (document.getElementById('comparisonViewContainer').style.display === 'none') {
                showMainContent();
            }
        }

        function displayDetailedView(user) {
            if (!user) {
                alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin chi ti·∫øt c·ªßa ng∆∞·ªùi d√πng.");
                return;
            }

            const { userId, name, rank, juneStats, julyStats } = user;

            // L·∫•y th√°ng ƒë∆∞·ª£c ch·ªçn t·ª´ bi·∫øn to√†n c·ª•c
            const juneMonth = selectedMonths.june;
            const julyMonth = selectedMonths.july;

            const statMapping = {
                might: "Might",
                kills: "Kills",
                enemies_captured: "K·∫ª Th√π B·ªã B·∫Øt",
                enemies_destroyed: "K·∫ª Th√π Ti√™u Di·ªát",
                enemy_wounded: "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng",
                troops_killed: "Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt",
                troops_lost: "S·ªë Qu√¢n T·ªïn Th·∫•t",
                troops_wounded: "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng",
                losses: "Thua",
                successful_attacks: "T·∫•n c√¥ng Th√†nh c√¥ng",
                successful_defenses: "Ph√≤ng th·ªß Th√†nh c√¥ng",
                victories: "Chi·∫øn Th·∫Øng",
                win_rate: "T·ªâ L·ªá Chi·∫øn Th·∫Øng"
            };

            let tableBodyHtml = '';
            for (const key in statMapping) {
                const statName = statMapping[key];
                const juneValue = juneStats ? juneStats[key] : undefined;
                const julyValue = julyStats ? julyStats[key] : undefined;

                let diffHtml;
                if (key === 'win_rate') {
                    diffHtml = compareWinRates(julyValue, juneValue);
                } else {
                    const diff = calculateDifference(julyValue, juneValue);
                    diffHtml = formatDifference(diff);
                }

                tableBodyHtml += `
            <tr>
                <td class="stat-name">${statName}</td>
                <td style="text-align: right;">${key === 'win_rate' ? (juneValue || '<span class="no-data">N/A</span>') : formatNumber(juneValue)}</td>
                <td style="text-align: right;">${key === 'win_rate' ? (julyValue || '<span class="no-data">N/A</span>') : formatNumber(julyValue)}</td>
                <td style="text-align: right;">${diffHtml}</td>
            </tr>
        `;
            }

            const detailedViewHtml = `
        <div class="detailed-view-card">
            <div class="detailed-view-header">
                <div>
                    <h2>${name}</h2>
                    <span class="user-id">ID: ${userId} | Rank: ${rank}</span>
                </div>
                <div>
                    <button onclick="hideDetailedView()" class="tertiary">Quay l·∫°i b·∫£ng</button>
                </div>
            </div>
            <div class="detailed-view-body">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left;">Ch·ªâ s·ªë</th>
                            <th style="text-align: right;">Th√°ng ${juneMonth}</th>
                            <th style="text-align: right;">Th√°ng ${julyMonth}</th>
                            <th style="text-align: right;">Ch√™nh l·ªách</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBodyHtml}
                    </tbody>
                </table>
            </div>
        </div>
    `;

            const container = document.getElementById('detailedViewContainer');
            container.innerHTML = detailedViewHtml;
            container.style.display = 'block';
        }

        function showDetailedView() {
            // L·∫•y gi√° tr·ªã t√¨m ki·∫øm t·ª´ √¥ nh·∫≠p
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                alert("Vui l√≤ng nh·∫≠p T√™n ho·∫∑c ID ƒë·ªÉ xem chi ti·∫øt.");
                return;
            }

            // T√¨m ki·∫øm ng∆∞·ªùi d√πng d·ª±a tr√™n t√™n ho·∫∑c ID
            const foundUsers = currentData.filter(item =>
                item.name.toLowerCase().includes(searchTerm) || // T√¨m theo t√™n
                item.userId.toString().includes(searchTerm)    // T√¨m theo ID
            );

            if (foundUsers.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i v·ªõi T√™n ho·∫∑c ID ch·ª©a: "${searchTerm}"`);
                return;
            }

            // N·∫øu ch·ªâ t√¨m th·∫•y m·ªôt ng∆∞·ªùi d√πng, hi·ªÉn th·ªã chi ti·∫øt
            if (foundUsers.length === 1) {
                displayDetailedView(foundUsers[0]);
            } else {
                // N·∫øu t√¨m th·∫•y nhi·ªÅu ng∆∞·ªùi d√πng, hi·ªÉn th·ªã danh s√°ch l·ª±a ch·ªçn
                displayUserSelection(foundUsers);
            }
        }

        function displayUserSelection(users) {
            let selectionHtml = `
        <div class="detailed-view-card">
            <div class="detailed-view-header">
                <h2>Ch·ªçn ng∆∞·ªùi ch∆°i ƒë·ªÉ xem chi ti·∫øt:</h2>
                <button onclick="hideDetailedView()" class="tertiary">Quay l·∫°i b·∫£ng</button>
            </div>
            <div class="detailed-view-body">
                <ul style="list-style-type: none; padding: 0; margin: 0;">
    `;

            users.forEach(user => {
                selectionHtml += `
            <li style="padding: 10px; border-bottom: 1px solid #eee;">
                <a href="#" onclick="displayDetailedView(currentData.find(item => item.userId === '${user.userId}')); return false;" style="text-decoration: none; color: #2196F3; font-weight: bold;">
                    ${user.name} (ID: ${user.userId})
                </a>
            </li>
        `;
            });

            selectionHtml += `
                </ul>
            </div>
        </div>
    `;

            const container = document.getElementById('detailedViewContainer');
            container.innerHTML = selectionHtml;
            container.style.display = 'block';
        }

        function performMultiComparison() {
            const memberId = document.getElementById('comparisonMemberSelect').value;
            if (!memberId) {
                alert("Vui l√≤ng ch·ªçn th√†nh vi√™n ch√≠nh ƒë·ªÉ so s√°nh.");
                return;
            }

            const selectedPriorityIds = Array.from(document.querySelectorAll('.priority-compare-checkbox:checked')).map(cb => cb.value);

            if (selectedPriorityIds.length === 0) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n ∆∞u ti√™n ƒë·ªÉ so s√°nh.");
                return;
            }

            const userToCompare = currentData.find(item => item.userId === memberId);
            const priorityUsers = selectedPriorityIds.map(id => currentData.find(item => item.userId === id));

            renderComparisonResult(userToCompare, priorityUsers);
        }


        function renderComparisonResult(mainUser, comparisonUsers) {
            const resultContainer = document.getElementById('comparisonResult');
            const statMapping = {
                might: "Might", kills: "Kills", enemies_captured: "K·∫ª Th√π B·ªã B·∫Øt", enemies_destroyed: "K·∫ª Th√π Ti√™u Di·ªát",
                enemy_wounded: "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng", troops_killed: "Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt", troops_lost: "S·ªë Qu√¢n T·ªïn Th·∫•t",
                troops_wounded: "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng", losses: "Thua", successful_attacks: "T·∫•n c√¥ng Th√†nh c√¥ng",
                successful_defenses: "Ph√≤ng th·ªß Th√†nh c√¥ng", victories: "Chi·∫øn Th·∫Øng"
            };

            const shortenName = (name) => name.length > 15 ? name.substring(0, 12) + '...' : name;

            // Build table headers dynamically
            let headerHtml = `
                <th style="text-align: left;">Ch·ªâ s·ªë</th>
                <th class="positive">${shortenName(mainUser.name)}</th>
            `;
            comparisonUsers.forEach(user => {
                headerHtml += `<th>${shortenName(user.name)}</th>`;
            });

            let tableHtml = `
                <h4>So s√°nh T·ªïng (Th√°ng 7 vs Th√°ng 6)</h4>
                <table>
                    <thead>
                        <tr>
                            ${headerHtml}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const key in statMapping) {
                let rowHtml = `<tr><td class="stat-name">${statMapping[key]}</td>`;

                // Main user's diff
                const mainUserDiff = calculateDifference(
                    mainUser.julyStats ? mainUser.julyStats[key] : undefined,
                    mainUser.juneStats ? mainUser.juneStats[key] : undefined
                );
                rowHtml += `<td style="text-align: right;">${formatDifference(mainUserDiff)}</td>`;

                // Comparison users' diffs
                comparisonUsers.forEach(user => {
                    const comparisonUserDiff = calculateDifference(
                        user.julyStats ? user.julyStats[key] : undefined,
                        user.juneStats ? user.juneStats[key] : undefined
                    );
                    rowHtml += `<td style="text-align: right;">${formatDifference(comparisonUserDiff)}</td>`;
                });

                rowHtml += '</tr>';
                tableHtml += rowHtml;
            }

            tableHtml += `</tbody></table>`;
            resultContainer.innerHTML = tableHtml;
        }

        // Ch·ª©c nƒÉng xu·∫•t ·∫£nh ƒë∆∞·ª£c l·∫•y t·ª´ file index.html theo y√™u c·∫ßu
        async function exportToPNG() {
            if (!currentData.length) {
                alert("Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!");
                return;
            }

            // L·∫•y tr·ª±c ti·∫øp b·∫£ng d·ªØ li·ªáu
            const tableElement = document.getElementById('comparisonTable');

            if (!tableElement) {
                alert(`Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu ƒë·ªÉ xu·∫•t ·∫£nh.`);
                return;
            }

            // --- Chu·∫©n b·ªã ch·ª•p: T·∫°m th·ªùi b·ªè style sticky c·ªßa header ---
            const thElements = tableElement.querySelectorAll('th');
            const originalThStyles = [];
            thElements.forEach(th => {
                originalThStyles.push(th.style.position);
                th.style.position = 'static';
            });

            // --- Ph·∫£n h·ªìi UI ---
            const exportButton = document.getElementById('exportPngBtn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = 'üì∏ ƒêang x·ª≠ l√Ω...';
            exportButton.disabled = true;

            setTimeout(async () => {
                let stylesRestored = false;
                const restoreStyles = () => {
                    if (!stylesRestored) {
                        thElements.forEach((th, index) => {
                            th.style.position = originalThStyles[index] || '';
                        });
                        stylesRestored = true;
                    }
                };

                try {
                    // Ch·ª•p ·∫£nh v·ªõi k√≠ch th∆∞·ªõc ƒë·∫ßy ƒë·ªß c·ªßa b·∫£ng (bao g·ªìm c·∫£ ph·∫ßn b·ªã cu·ªôn)
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });

                    restoreStyles();

                    const imageDataUrl = canvas.toDataURL('image/png');

                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write(`<!DOCTYPE html><html><head><title>B√°o c√°o so s√°nh</title></head><body style="margin:0;"><img src="${imageDataUrl}" alt="B√°o c√°o so s√°nh" style="max-width: 100%; display: block;"></body></html>`);
                        newWindow.document.close();
                    } else {
                        alert("Kh√¥ng th·ªÉ m·ªü tab m·ªõi. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t ch·∫∑n pop-up c·ªßa tr√¨nh duy·ªát v√† th·ª≠ l·∫°i.");
                    }

                } catch (error) {
                    console.error('L·ªói xu·∫•t ·∫£nh:', error);
                    alert(`Xu·∫•t ·∫£nh th·∫•t b·∫°i! L·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra console (F12).`);
                    restoreStyles(); // ƒê·∫£m b·∫£o kh√¥i ph·ª•c n·∫øu c√≥ l·ªói
                } finally {
                    // --- Kh√¥i ph·ª•c n√∫t ---
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
            }, 150);
        }

        function exportToExcel() {
            if (currentData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file Excel.");
                return;
            }

            const loading = showLoading("ƒêang t·∫°o file Excel...");

            setTimeout(() => {
                try {
                    // L·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã
                    const visibleData = [];
                    const tableRows = document.getElementById('tableBody').getElementsByTagName('tr');
                    for (const row of tableRows) {
                        if (row.style.display !== 'none') {
                            const userId = row.cells[2].innerText;
                            const dataItem = currentData.find(item => item.userId === userId);
                            if (dataItem) visibleData.push(dataItem);
                        }
                    }

                    if (visibleData.length === 0) {
                        alert("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t.");
                        throw new Error("No visible data");
                    }

                    const dataToExport = [];
                    const headers = [
                        "Lo·∫°i D·ªØ Li·ªáu", "T√™n", "User ID", "Rank", "Might", "Kills",
                        "K·∫ª Th√π B·ªã B·∫Øt", "K·∫ª Th√π Ti√™u Di·ªát", "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng",
                        "Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt", "S·ªë Qu√¢n T·ªïn Th·∫•t", "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng",
                        "Thua", "T·∫•n c√¥ng Th√†nh c√¥ng", "Ph√≤ng th·ªß Th√†nh c√¥ng",
                        "Chi·∫øn Th·∫Øng", "T·ªâ L·ªá Chi·∫øn Th·∫Øng"
                    ];

                    // Ti√™u ƒë·ªÅ ch√≠nh
                    dataToExport.push([`B√°o c√°o so s√°nh th·ªëng k√™ - Ng√†y xu·∫•t: ${new Date().toLocaleString('vi-VN')}`]);
                    dataToExport.push([]);
                    dataToExport.push(headers.map(h => ({ v: h, t: 's', s: { font: { bold: true }, alignment: { horizontal: 'center' } } })));

                    // --- C√°c h√†m ti·ªán √≠ch ƒë·ªÉ t·∫°o √¥ trong Excel ---
                    const createCell = (value, type = 's', format = null, style = {}) => {
                        const cell = { v: value, t: type, s: style };
                        if (format) cell.z = format;
                        return cell;
                    };

                    const createNumericCell = (value) => {
                        if (value === undefined || value === null || value === "Kh√¥ng c√≥ d·ªØ li·ªáu") {
                            return createCell("Kh√¥ng c√≥ d·ªØ li·ªáu");
                        }
                        return createCell(value, 'n', '#,##0');
                    };

                    const createDiffCell = (diff) => {
                        if (diff === null || diff === undefined) return createCell("N/A");
                        const style = { font: {} };
                        if (diff > 0) style.font.color = { rgb: "FF008000" }; // Green
                        if (diff < 0) style.font.color = { rgb: "FFFF0000" }; // Red
                        return createCell(diff, 'n', '+#,##0;-#,##0;0', style);
                    };

                    const createWinRateDiffCell = (newRate, oldRate) => {
                        if (!newRate || !oldRate) return createCell("N/A");
                        const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
                        const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
                        if (isNaN(newNum) || isNaN(oldNum)) return createCell("N/A");

                        const diff = newNum - oldNum;
                        const style = { font: {} };
                        let text = `${diff.toFixed(2)}%`;
                        if (diff > 0) {
                            style.font.color = { rgb: "FF008000" }; // Green
                            text = `+${text}`;
                        } else if (diff < 0) {
                            style.font.color = { rgb: "FFFF0000" }; // Red
                        }
                        return createCell(text, 's', null, style);
                    };

                    visibleData.forEach(item => {
                        const { userId, name, rank, juneStats, julyStats } = item;
                        const getStat = (stats, key) => (stats ? stats[key] : undefined);

                        const juneRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(juneStats, 'might')), createNumericCell(getStat(juneStats, 'kills')),
                            createNumericCell(getStat(juneStats, 'enemies_captured')), createNumericCell(getStat(juneStats, 'enemies_destroyed')),
                            createNumericCell(getStat(juneStats, 'enemy_wounded')), createNumericCell(getStat(juneStats, 'troops_killed')),
                            createNumericCell(getStat(juneStats, 'troops_lost')), createNumericCell(getStat(juneStats, 'troops_wounded')),
                            createNumericCell(getStat(juneStats, 'losses')), createNumericCell(getStat(juneStats, 'successful_attacks')),
                            createNumericCell(getStat(juneStats, 'successful_defenses')), createNumericCell(getStat(juneStats, 'victories')),
                            createCell(getStat(juneStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(juneRow);

                        const julyRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(julyStats, 'might')), createNumericCell(getStat(julyStats, 'kills')),
                            createNumericCell(getStat(julyStats, 'enemies_captured')), createNumericCell(getStat(julyStats, 'enemies_destroyed')),
                            createNumericCell(getStat(julyStats, 'enemy_wounded')), createNumericCell(getStat(julyStats, 'troops_killed')),
                            createNumericCell(getStat(julyStats, 'troops_lost')), createNumericCell(getStat(julyStats, 'troops_wounded')),
                            createNumericCell(getStat(julyStats, 'losses')), createNumericCell(getStat(julyStats, 'successful_attacks')),
                            createNumericCell(getStat(julyStats, 'successful_defenses')), createNumericCell(getStat(julyStats, 'victories')),
                            createCell(getStat(julyStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(julyRow);

                        const diffRow = [
                            createCell("T·ªïng", 's', null, { font: { bold: true } }), createCell(""), createCell(""), createCell(""),
                            createDiffCell(calculateDifference(getStat(julyStats, 'might'), getStat(juneStats, 'might'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'kills'), getStat(juneStats, 'kills'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_captured'), getStat(juneStats, 'enemies_captured'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_destroyed'), getStat(juneStats, 'enemies_destroyed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemy_wounded'), getStat(juneStats, 'enemy_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_killed'), getStat(juneStats, 'troops_killed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_lost'), getStat(juneStats, 'troops_lost'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_wounded'), getStat(juneStats, 'troops_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'losses'), getStat(juneStats, 'losses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_attacks'), getStat(juneStats, 'successful_attacks'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_defenses'), getStat(juneStats, 'successful_defenses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'victories'), getStat(juneStats, 'victories'))),
                            createWinRateDiffCell(getStat(julyStats, 'win_rate'), getStat(juneStats, 'win_rate'))
                        ];
                        dataToExport.push(diffRow);

                        dataToExport.push([]); // D√≤ng tr·ªëng ph√¢n c√°ch
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataToExport);

                    // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt
                    const objectMaxLength = dataToExport.reduce((acc, row) => {
                        row.forEach((cell, i) => {
                            const cellValue = cell && cell.v ? cell.v : '';
                            const cellLength = String(cellValue).length;
                            acc[i] = Math.max(acc[i] || 0, cellLength);
                        });
                        return acc;
                    }, []);
                    ws["!cols"] = objectMaxLength.map(width => ({ wch: Math.min(width + 2, 40) })); // Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "So S√°nh Th·ªëng K√™");
                    XLSX.writeFile(wb, `SoSanhThongKe_${new Date().toISOString().slice(0, 10)}.xlsx`);
                } catch (error) {
                    if (error.message === "No visible data") return; // ƒê√£ c√≥ alert, kh√¥ng c·∫ßn b√°o l·ªói th√™m
                    console.error("L·ªói khi xu·∫•t Excel:", error);
                    alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file Excel. Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.");
                } finally {
                    loading.remove();
                }
            }, 50);
        }

        function exportToCompactExcel() {
            if (currentData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file Excel.");
                return;
            }

            const loading = showLoading("ƒêang t·∫°o file Excel tinh g·ªçn...");

            setTimeout(() => {
                try {
                    // L·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã, t√¥n tr·ªçng c√°c b·ªô l·ªçc hi·ªán t·∫°i
                    const visibleData = [];
                    const tableRows = document.getElementById('tableBody').getElementsByTagName('tr');
                    for (const row of tableRows) {
                        if (row.style.display !== 'none') {
                            const stt = row.cells[0].innerText;
                            const userId = row.cells[2].innerText; // User ID v·∫´n ·ªü c·ªôt 3 d√π c√≥ th·ªÉ b·ªã ·∫©n
                            const dataItem = currentData.find(item => item.userId === userId);
                            if (dataItem) {
                                visibleData.push({
                                    ...dataItem,
                                    stt
                                }); // Th√™m STT v√†o ƒë·ªëi t∆∞·ª£ng
                            }
                        }
                    }

                    if (visibleData.length === 0) {
                        alert("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t.");
                        throw new Error("No visible data");
                    }

                    const dataToExport = [];
                    const headers = [
                        "STT", "T√™n", "Might", "Kills", "K·∫ª Th√π Ti√™u Di·ªát",
                        "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng", "S·ªë Qu√¢n T·ªïn Th·∫•t", "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng"
                    ];

                    dataToExport.push(headers.map(h => ({ v: h, t: 's', s: { font: { bold: true } } })));

                    const getDiff = (item, key) => {
                        const diff = calculateDifference(item.julyStats?.[key], item.juneStats?.[key]);
                        return diff === null ? "N/A" : diff;
                    };

                    visibleData.forEach(item => {
                        const row = [
                            parseInt(item.stt, 10), item.name,
                            getDiff(item, 'might'), getDiff(item, 'kills'),
                            getDiff(item, 'enemies_destroyed'), getDiff(item, 'enemy_wounded'),
                            getDiff(item, 'troops_lost'), getDiff(item, 'troops_wounded')
                        ];
                        dataToExport.push(row);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataToExport);
                    const objectMaxLength = dataToExport.reduce((acc, row) => { row.forEach((cell, i) => { const cellValue = cell && cell.v ? cell.v : cell; const cellLength = String(cellValue).length; acc[i] = Math.max(acc[i] || 0, cellLength); }); return acc; }, []);
                    ws["!cols"] = objectMaxLength.map(width => ({ wch: Math.min(width + 2, 40) }));

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTinhGon");
                    XLSX.writeFile(wb, `BaoCaoTinhGon_${new Date().toISOString().slice(0, 10)}.xlsx`);

                } catch (error) {
                    if (error.message !== "No visible data") { console.error("L·ªói khi xu·∫•t Excel tinh g·ªçn:", error); alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file Excel tinh g·ªçn. Vui l√≤ng ki·ªÉm tra console (F12)."); }
                } finally {
                    loading.remove();
                }
            }, 50);
        }

        function showLoading(message) {
            const loading = document.createElement('div');
            loading.style.position = 'fixed';
            loading.style.top = '0';
            loading.style.left = '0';
            loading.style.width = '100%';
            loading.style.height = '100%';
            loading.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loading.style.display = 'flex';
            loading.style.flexDirection = 'column';
            loading.style.justifyContent = 'center';
            loading.style.alignItems = 'center';
            loading.style.zIndex = '9999';
            loading.innerHTML = `
                <div style="color:white;font-size:20px;margin-bottom:10px;">${message}</div>
                <div class="spinner"></div>
            `;
            document.body.appendChild(loading);
            return loading;
        }

        function resetTable() {
            document.getElementById('searchInput').value = '';
            document.getElementById('priorityIds').value = '416381060,765602761,417896120,537487142,360966484';
            priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
            hideComparisonView();
            hideDetailedView();
            document.body.classList.remove('compact-view');
            document.getElementById('compactViewBtn').textContent = 'Tinh g·ªçn';
            sortTable('name', 'asc');
        }

        // Kh·ªüi t·∫°o s·ª± ki·ªán
        window.onload = function () {
            document.getElementById('searchInput').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    searchTable();
                }
            });

            // Th√™m s·ª± ki·ªán ƒë·ªÉ x·ª≠ l√Ω vi·ªác ch·ªçn file v√† t·ª± ƒë·ªông t·∫£i
            document.getElementById('juneFile').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) {
                    document.getElementById('juneFileName').textContent = '';
                    return;
                }
                document.getElementById('juneFileName').textContent = file.name;
                document.getElementById('juneUrl').value = ''; // X√≥a URL n·∫øu ƒë√£ ch·ªçn file
                handleFileUpload(file, 'june'); // T·ª± ƒë·ªông x·ª≠ l√Ω file
            });

            document.getElementById('julyFile').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) {
                    document.getElementById('julyFileName').textContent = '';
                    return;
                }
                document.getElementById('julyFileName').textContent = file.name;
                document.getElementById('julyUrl').value = ''; // X√≥a URL n·∫øu ƒë√£ ch·ªçn file
                handleFileUpload(file, 'july'); // T·ª± ƒë·ªông x·ª≠ l√Ω file
            });

            // Th√™m s·ª± ki·ªán ƒë·ªÉ x·ª≠ l√Ω vi·ªác nh·∫≠p URL
            document.getElementById('juneUrl').addEventListener('input', function (e) {
                // N·∫øu ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p URL, x√≥a l·ª±a ch·ªçn file
                if (e.target.value.trim() !== '') {
                    document.getElementById('juneFile').value = '';
                    document.getElementById('juneFileName').textContent = '';
                }
            });

            document.getElementById('julyUrl').addEventListener('input', function (e) {
                // N·∫øu ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p URL, x√≥a l·ª±a ch·ªçn file
                if (e.target.value.trim() !== '') {
                    document.getElementById('julyFile').value = '';
                    document.getElementById('julyFileName').textContent = '';
                }
            });

            // Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho priorityIds
            document.getElementById('priorityIds').value = priorityIds.join(',');

            // === T·ª∞ ƒê·ªòNG ƒêI·ªÄN URL M·∫∂C ƒê·ªäNH T·ª™C T·ª™ GITHUB ===
            // Ng∆∞·ªùi d√πng s·∫Ω c·∫ßn nh·∫•n n√∫t "T·∫£i D·ªØ Li·ªáu" ƒë·ªÉ b·∫Øt ƒë·∫ßu
            const juneFileUrl = 'https://docs.google.com/spreadsheets/d/1vxjNifx_pgJjDlZ-FK6_Y2NpzKU1ArcV/edit?gid=45285307#gid=45285307';
            const julyFileUrl = 'https://docs.google.com/spreadsheets/d/1nTET8tLm4cYlci3_LWljMXPlTlxuvBOS/edit?gid=823266667#gid=823266667';

            document.getElementById('juneUrl').value = juneFileUrl;
            document.getElementById('julyUrl').value = julyFileUrl;

            // G√°n s·ª± ki·ªán cho n√∫t chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu c·ªßa Bi·ªÉu ƒë·ªì So s√°nh
            // Ph∆∞∆°ng ph√°p n√†y ƒë·∫£m b·∫£o n√∫t ƒë√£ t·ªìn t·∫°i tr√™n trang tr∆∞·ªõc khi g√°n s·ª± ki·ªán, gi·∫£i quy·∫øt l·ªói ReferenceError
            const toggleBtn = document.getElementById('toggleOverallChartBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function () {
                    // Khi n√∫t ƒë∆∞·ª£c nh·∫•n, ƒë·∫£o ng∆∞·ª£c tr·∫°ng th√°i v√† v·∫Ω l·∫°i bi·ªÉu ƒë·ªì
                    window.showMonthlyDataOverall = !window.showMonthlyDataOverall;
                    showOverallComparisonChart();
                });
            }
        };

        function updateMonth(type) {
            const monthSelect = document.getElementById(`${type}MonthSelect`);
            const selectedMonth = parseInt(monthSelect.value, 10); // L·∫•y gi√° tr·ªã th√°ng ƒë∆∞·ª£c ch·ªçn
            selectedMonths[type] = selectedMonth; // L∆∞u th√°ng ƒë∆∞·ª£c ch·ªçn v√†o bi·∫øn to√†n c·ª•c

            const monthTitle = document.getElementById(`monthTitle${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const monthButton = document.querySelector(`button[onclick="loadData('${type}')"]`);

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v√† n√∫t
            monthTitle.textContent = `D·ªØ li·ªáu Th√°ng ${selectedMonth}`;
            monthButton.textContent = `T·∫£i D·ªØ Li·ªáu Th√°ng ${selectedMonth}`;

            // C·∫≠p nh·∫≠t placeholder URL
            const urlInput = document.getElementById(`${type}Url`);
            urlInput.placeholder = `D√°n link Google Sheets/GitHub Raw cho Th√°ng ${selectedMonth}...`;

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c√°c c·ªôt trong b·∫£ng
            updateTableHeaders(type, selectedMonth);
        }

        function updateTableHeaders(type, selectedMonth) {
            const columnClass = type === 'june' ? 'month-col-june' : 'month-col-july';
            const headers = document.querySelectorAll(`.${columnClass}`);
            headers.forEach(header => {
                header.textContent = `Th√°ng ${selectedMonth}`;
            });
        }
        function calculateTotals() {
            const totals = {
                killsDiff: 0,
                troopsLostDiff: 0,
                enemyWoundedDiff: 0,
                troopsKilledDiff: 0,
                troopsWoundedDiff: 0,
                enemiesDestroyedDiff: 0 // Th√™m t·ªïng cho "K·∫ª Th√π Ti√™u Di·ªát"
            };

            currentData.forEach(item => {
                const { juneStats, julyStats } = item;

                // H√†m chuy·ªÉn ƒë·ªïi gi√° tr·ªã th√†nh s·ªë h·ª£p l·ªá
                const parseValue = (value) => {
                    if (typeof value === 'number') return value;
                    if (typeof value === 'string') {
                        const parsed = parseFloat(value.replace(/[^0-9.-]/g, ''));
                        return isNaN(parsed) ? 0 : parsed;
                    }
                    return 0;
                };

                // T√≠nh t·ªïng Kills
                const killsJune = parseValue(juneStats?.kills);
                const killsJuly = parseValue(julyStats?.kills);
                if (juneStats && julyStats) {
                    const killsDiff = killsJuly - killsJune;
                    totals.killsDiff += killsDiff; // C·ªông ch√™nh l·ªách v√†o t·ªïng
                }

                // T√≠nh t·ªïng S·ªë Qu√¢n T·ªïn Th·∫•t
                const troopsLostJune = parseValue(juneStats?.troops_lost);
                const troopsLostJuly = parseValue(julyStats?.troops_lost);
                if (juneStats && julyStats) {
                    const troopsLostDiff = troopsLostJuly - troopsLostJune;
                    totals.troopsLostDiff += troopsLostDiff;
                }

                // T√≠nh t·ªïng Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng
                const enemyWoundedJune = parseValue(juneStats?.enemy_wounded);
                const enemyWoundedJuly = parseValue(julyStats?.enemy_wounded);
                if (juneStats && julyStats) {
                    const enemyWoundedDiff = enemyWoundedJuly - enemyWoundedJune;
                    totals.enemyWoundedDiff += enemyWoundedDiff;
                }

                // T√≠nh t·ªïng Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng
                const troopsWoundedJune = parseValue(juneStats?.troops_wounded);
                const troopsWoundedJuly = parseValue(julyStats?.troops_wounded);
                if (juneStats && julyStats) {
                    const troopsWoundedDiff = troopsWoundedJuly - troopsWoundedJune;
                    totals.troopsWoundedDiff += troopsWoundedDiff;
                }

                // T√≠nh t·ªïng "K·∫ª Th√π Ti√™u Di·ªát"
                const enemiesDestroyedJune = parseValue(juneStats?.enemies_destroyed);
                const enemiesDestroyedJuly = parseValue(julyStats?.enemies_destroyed);
                if (juneStats && julyStats) {
                    const enemiesDestroyedDiff = enemiesDestroyedJuly - enemiesDestroyedJune;
                    totals.enemiesDestroyedDiff += enemiesDestroyedDiff;
                }
            });

            return totals;
        }
        function displayTotals() {
            const totals = calculateTotals();

            document.getElementById('totalKills').textContent = formatNumber(totals.killsDiff);
            document.getElementById('totalTroopsLost').textContent = formatNumber(totals.troopsLostDiff);
            document.getElementById('totalEnemyWounded').textContent = formatNumber(totals.enemyWoundedDiff);
            document.getElementById('totalTroopsWounded').textContent = formatNumber(totals.troopsWoundedDiff);
            document.getElementById('totalEnemiesDestroyed').textContent = formatNumber(totals.enemiesDestroyedDiff); // Hi·ªÉn th·ªã t·ªïng "K·∫ª Th√π Ti√™u Di·ªát"

            document.getElementById('totalsContainer').style.display = 'block';
        }
        async function showGitHubFiles(type) {
            const githubFilesContainer = document.getElementById(`githubFiles${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const githubFileSelect = document.getElementById(`githubFileSelect${type.charAt(0).toUpperCase() + type.slice(1)}`);

            // Hi·ªÉn th·ªã container
            githubFilesContainer.style.display = 'block';

            // G·ªçi GitHub API ƒë·ªÉ l·∫•y danh s√°ch file
            try {
                const response = await fetch('https://api.github.com/repos/heo-sieu-doi/quai-kill/contents/');
                if (!response.ok) {
                    throw new Error(`L·ªói khi g·ªçi GitHub API: ${response.status}`);
                }

                const files = await response.json();
                githubFileSelect.innerHTML = '<option value="">-- Ch·ªçn file --</option>'; // Reset danh s√°ch

                // L·ªçc c√°c file Excel v√† th√™m v√†o dropdown
                files
                    .filter(file => file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))
                    .forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.download_url; // URL t·∫£i file
                        option.textContent = file.name; // T√™n file
                        githubFileSelect.appendChild(option);
                    });
            } catch (error) {
                console.error('L·ªói khi l·∫•y danh s√°ch file t·ª´ GitHub:', error);
                alert('Kh√¥ng th·ªÉ l·∫•y danh s√°ch file t·ª´ GitHub. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        function selectGitHubFile(type) {
            const githubFileSelect = document.getElementById(`githubFileSelect${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const selectedFileUrl = githubFileSelect.value;

            if (selectedFileUrl) {
                // G√°n URL file v√†o √¥ nh·∫≠p URL
                document.getElementById(`${type}Url`).value = selectedFileUrl;

                // T·ª± ƒë·ªông t·∫£i file
                loadData(type);
            }
        }
        function validateData() {
            currentData.forEach((item, index) => {
                const { juneStats, julyStats } = item;

                const checkValue = (value, key, month) => {
                    if (value === undefined || value === null || isNaN(value)) {
                        console.warn(`D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·∫°i b·∫£n ghi ${index + 1}, c·ªôt ${key}, th√°ng ${month}:`, value);
                    }
                };

                if (juneStats) {
                    Object.keys(juneStats).forEach(key => checkValue(juneStats[key], key, 'June'));
                }
                if (julyStats) {
                    Object.keys(julyStats).forEach(key => checkValue(julyStats[key], key, 'July'));
                }
            });
        }
        function getRowsByRange(rangeString) {
            const ranges = rangeString.split(',').map(range => {
                const [start, end] = range.split('-').map(num => parseInt(num.trim(), 10));
                return { start, end };
            });

            const tableRows = Array.from(document.querySelectorAll('#tableBody tr'));
            const filteredRows = [];

            ranges.forEach(({ start, end }) => {
                if (isNaN(start) || isNaN(end) || start > end) {
                    alert(`Ph·∫°m vi kh√¥ng h·ª£p l·ªá: ${start}-${end}`);
                    return;
                }

                tableRows.forEach(row => {
                    const sttCell = row.querySelector('td:first-child');
                    if (sttCell) {
                        const stt = parseInt(sttCell.textContent.trim(), 10);
                        if (stt >= start && stt <= end) {
                            filteredRows.push(row.cloneNode(true)); // Sao ch√©p h√†ng
                        }
                    }
                });
            });

            return filteredRows;
        }
        async function exportToPNGByRange() {
            const rangeInput = prompt("Nh·∫≠p ph·∫°m vi STT (v√≠ d·ª•: 1-50, 51-95):").trim();
            if (!rangeInput) {
                alert('Vui l√≤ng nh·∫≠p ph·∫°m vi STT ƒë·ªÉ xu·∫•t ·∫£nh.');
                return;
            }

            const filteredRows = getRowsByRange(rangeInput);
            if (filteredRows.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y h√†ng n√†o trong ph·∫°m vi STT ƒë√£ nh·∫≠p.');
                return;
            }

            const tableElement = document.getElementById('comparisonTable');
            const originalTableBody = document.getElementById('tableBody');
            const originalRows = Array.from(originalTableBody.children);

            const exportButton = document.getElementById('exportPngBtn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = 'üì∏ ƒêang x·ª≠ l√Ω...';
            exportButton.disabled = true;

            try {
                // Chia c√°c h√†ng th√†nh t·ª´ng nh√≥m theo ph·∫°m vi
                const rowsPerImage = [];
                let currentGroup = [];
                filteredRows.forEach((row, index) => {
                    currentGroup.push(row);
                    if ((index + 1) % 50 === 0 || index === filteredRows.length - 1) {
                        rowsPerImage.push(currentGroup);
                        currentGroup = [];
                    }
                });

                // Xu·∫•t t·ª´ng nh√≥m h√†ng th√†nh ·∫£nh
                for (let i = 0; i < rowsPerImage.length; i++) {
                    // T·∫°m th·ªùi thay th·∫ø n·ªôi dung b·∫£ng b·∫±ng nh√≥m h√†ng hi·ªán t·∫°i
                    originalTableBody.innerHTML = '';
                    rowsPerImage[i].forEach(row => originalTableBody.appendChild(row));

                    // Ch·ª•p ·∫£nh b·∫£ng
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });

                    // T·∫£i ·∫£nh xu·ªëng
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `Exported_Image_${i + 1}.png`;
                    link.click();
                }
            } catch (error) {
                console.error('L·ªói xu·∫•t ·∫£nh:', error);
                alert(`Xu·∫•t ·∫£nh th·∫•t b·∫°i! L·ªói: ${error.message}`);
            } finally {
                // Kh√¥i ph·ª•c b·∫£ng g·ªëc
                originalTableBody.innerHTML = '';
                originalRows.forEach(row => originalTableBody.appendChild(row));

                // Kh√¥i ph·ª•c n√∫t
                exportButton.textContent = originalButtonText;
                exportButton.disabled = false;
            }
        }
        function showUpdateDataModal() {
            document.getElementById('updateDataModal').style.display = 'block';
        }

        function closeUpdateDataModal() {
            document.getElementById('updateDataModal').style.display = 'none';
            document.getElementById('updateDataTableContainer').innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©
        }
        function showGitHubFilesForUpdate() {
            const githubFilesContainer = document.getElementById('githubFilesUpdate');
            const githubFileSelect = document.getElementById('githubFileSelectUpdate');

            // Hi·ªÉn th·ªã container
            githubFilesContainer.style.display = 'block';

            // G·ªçi GitHub API ƒë·ªÉ l·∫•y danh s√°ch file
            fetch('https://api.github.com/repos/heo-sieu-doi/quai-kill/contents/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`L·ªói khi g·ªçi GitHub API: ${response.status}`);
                    }
                    return response.json();
                })
                .then(files => {
                    githubFileSelect.innerHTML = '<option value="">-- Ch·ªçn file --</option>'; // Reset danh s√°ch

                    // L·ªçc c√°c file Excel v√† th√™m v√†o dropdown
                    files
                        .filter(file => file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))
                        .forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.download_url; // URL t·∫£i file
                            option.textContent = file.name; // T√™n file
                            githubFileSelect.appendChild(option);
                        });
                })
                .catch(error => {
                    console.error('L·ªói khi l·∫•y danh s√°ch file t·ª´ GitHub:', error);
                    alert('Kh√¥ng th·ªÉ l·∫•y danh s√°ch file t·ª´ GitHub. Vui l√≤ng th·ª≠ l·∫°i sau.');
                });
        }

        function loadGitHubFileForUpdate() {
            const githubFileSelect = document.getElementById('githubFileSelectUpdate');
            const selectedFileUrl = githubFileSelect.value;

            if (selectedFileUrl) {
                // G√°n URL file v√†o √¥ nh·∫≠p URL
                document.getElementById('juneUrl').value = selectedFileUrl;

                // T·ª± ƒë·ªông t·∫£i file
                loadUpdateData(selectedFileUrl);
            }
        }

        function loadUpdateData(url) {
            const statusElement = document.getElementById('juneStatus');

            // T√°ch bi·ªát ph·∫ßn x·ª≠ l√Ω URL cho c·∫≠p nh·∫≠t d·ªØ li·ªáu
            const rawUrl = url.trim();
            let exportUrl = '';
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                const sheetId = match[1];
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                exportUrl = rawUrl;
            } else {
                alert("URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng cung c·∫•p link Google Sheets/File h·ª£p l·ªá (ƒë√£ chia s·∫ª c√¥ng khai) ho·∫∑c link tr·ª±c ti·∫øp ƒë·∫øn file .xlsx.");
                return;
            }

            statusElement.textContent = 'ƒêang t·∫£i t·ª´ URL...';
            statusElement.className = 'status';
            const loading = showLoading(`ƒêang t·∫£i d·ªØ li·ªáu c·∫≠p nh·∫≠t...`);

            fetch(exportUrl, { signal: AbortSignal.timeout(30000) })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}`);
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // Hi·ªÉn th·ªã d·ªØ li·ªáu trong modal
                    displayUpdateData(jsonData);
                })
                .catch(error => {
                    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu c·∫≠p nh·∫≠t:', error);
                    statusElement.textContent = `L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`;
                    statusElement.className = 'status error';
                })
                .finally(() => {
                    loading.remove();
                });
        }

        function saveUpdatedData() {
            const container = document.getElementById('updateDataTableContainer');
            const table = container.querySelector('table');

            if (!table) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u.');
                return;
            }

            const rows = Array.from(table.querySelectorAll('tr'));
            const updatedData = rows.map(row => {
                return Array.from(row.querySelectorAll('td, th')).map(cell => cell.textContent.trim());
            });

            // Chuy·ªÉn d·ªØ li·ªáu th√†nh file Excel
            const worksheet = XLSX.utils.aoa_to_sheet(updatedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Updated Data');

            // T·∫£i file Excel
            XLSX.writeFile(workbook, 'Updated_Data.xlsx');
            alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
        }
        async function showGitHubFilesForUpdate() {
            const githubFilesContainer = document.getElementById('githubFilesUpdate');
            const githubFileSelect = document.getElementById('githubFileSelectUpdate');

            // Hi·ªÉn th·ªã container
            githubFilesContainer.style.display = 'block';

            // G·ªçi GitHub API ƒë·ªÉ l·∫•y danh s√°ch file
            try {
                const response = await fetch('https://api.github.com/repos/heo-sieu-doi/quai-kill/contents/');
                if (!response.ok) {
                    throw new Error(`L·ªói khi g·ªçi GitHub API: ${response.status}`);
                }

                const files = await response.json();
                githubFileSelect.innerHTML = '<option value="">-- Ch·ªçn file --</option>'; // Reset danh s√°ch

                // L·ªçc c√°c file Excel v√† th√™m v√†o dropdown
                files
                    .filter(file => file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))
                    .forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.download_url; // URL t·∫£i file
                        option.textContent = file.name; // T√™n file
                        githubFileSelect.appendChild(option);
                    });
            } catch (error) {
                console.error('L·ªói khi l·∫•y danh s√°ch file t·ª´ GitHub:', error);
                alert('Kh√¥ng th·ªÉ l·∫•y danh s√°ch file t·ª´ GitHub. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }
        async function loadGitHubFileForUpdate() {
            const githubFileSelect = document.getElementById('githubFileSelectUpdate');
            const selectedFileUrl = githubFileSelect.value;

            if (!selectedFileUrl) {
                alert('Vui l√≤ng ch·ªçn m·ªôt file t·ª´ GitHub.');
                return;
            }

            try {
                const response = await fetch(selectedFileUrl);
                if (!response.ok) {
                    throw new Error(`L·ªói khi t·∫£i file t·ª´ GitHub: ${response.status}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
                displayEditableData(jsonData);
            } catch (error) {
                console.error('L·ªói khi t·∫£i file t·ª´ GitHub:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i file t·ª´ GitHub. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }
        function displayEditableData(data) {
            const container = document.getElementById('updateDataTableContainer');
            container.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©

            if (!data || data.length === 0) {
                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>';
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // √Ånh x·∫° ti√™u ƒë·ªÅ ti·∫øng Anh sang ti·∫øng Vi·ªát
            const statMapping = {
                "Enemies captured": "K·∫ª Th√π B·ªã B·∫Øt",
                "Enemies Destroyed Might": "K·∫ª Th√π Ti√™u Di·ªát",
                "Enemy Troops Wounded": "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng",
                "Troops Killed": "Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt",
                "Troops Lost": "S·ªë Qu√¢n T·ªïn Th·∫•t",
                "Troops Wounded": "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng",
                "Losses": "Thua",
                "Successful Attacks": "T·∫•n c√¥ng Th√†nh c√¥ng",
                "Ph√≤ng th·ªß th√†nh c√¥ng": "Ph√≤ng th·ªß Th√†nh c√¥ng",
                "Victories": "Chi·∫øn Th·∫Øng",
                "Win Rate": "T·ªâ L·ªá Chi·∫øn Th·∫Øng"
            };

            // T·∫°o ti√™u ƒë·ªÅ b·∫£ng
            const headerRow = document.createElement('tr');
            data[0].forEach(header => {
                const th = document.createElement('th');
                th.textContent = statMapping[header] || header; // Hi·ªÉn th·ªã ti·∫øng Vi·ªát n·∫øu c√≥, n·∫øu kh√¥ng gi·ªØ nguy√™n
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // T·∫°o c√°c h√†ng d·ªØ li·ªáu
            data.slice(1).forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    td.contentEditable = true; // Cho ph√©p ch·ªânh s·ª≠a
                    td.textContent = cell || '';
                    td.dataset.row = rowIndex + 1; // L∆∞u ch·ªâ s·ªë h√†ng
                    td.dataset.col = colIndex; // L∆∞u ch·ªâ s·ªë c·ªôt
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }
        function addNewRow() {
            const container = document.getElementById('updateDataTableContainer');
            const table = container.querySelector('table');

            if (!table) {
                alert('Kh√¥ng c√≥ b·∫£ng d·ªØ li·ªáu ƒë·ªÉ th√™m h√†ng m·ªõi.');
                return;
            }

            const tbody = table.querySelector('tbody');
            const newRow = document.createElement('tr');

            // Th√™m c√°c √¥ tr·ªëng v√†o h√†ng m·ªõi
            const columnCount = table.querySelector('thead tr').children.length;
            for (let i = 0; i < columnCount; i++) {
                const td = document.createElement('td');
                td.contentEditable = true; // Cho ph√©p ch·ªânh s·ª≠a
                td.textContent = ''; // N·ªôi dung tr·ªëng
                newRow.appendChild(td);
            }

            tbody.appendChild(newRow);
        }
        function saveUpdatedData() {
            const container = document.getElementById('updateDataTableContainer');
            const table = container.querySelector('table');

            if (!table) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u.');
                return;
            }

            const rows = Array.from(table.querySelectorAll('tr'));
            const updatedData = rows.map(row => {
                return Array.from(row.querySelectorAll('td, th')).map(cell => cell.textContent.trim());
            });

            // Chuy·ªÉn d·ªØ li·ªáu th√†nh file Excel
            const worksheet = XLSX.utils.aoa_to_sheet(updatedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Updated Data');

            // T·∫£i file Excel
            XLSX.writeFile(workbook, 'Updated_Data.xlsx');
            alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
        }

        function showChartModal() {
            const playerSelect = document.getElementById('playerSelectChart');
            playerSelect.innerHTML = ''; // X√≥a c√°c l·ª±a ch·ªçn c≈©

            const eligiblePlayers = currentData.filter(p => p.hasBothData);

            if (eligiblePlayers.length === 0) {
                alert("Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i n√†o c√≥ ƒë·ªß d·ªØ li·ªáu ·ªü c·∫£ 2 th√°ng ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.");
                return;
            }

            eligiblePlayers.sort((a, b) => a.name.localeCompare(b.name)); // S·∫Øp x·∫øp theo t√™n

            eligiblePlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.userId;
                option.textContent = player.name;
                playerSelect.appendChild(option);
            });

            document.getElementById('chartModal').style.display = 'block';
            updateChart(); // V·∫Ω bi·ªÉu ƒë·ªì cho ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n
        }

        function hideChartModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function updateChart() {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const playerId = document.getElementById('playerSelectChart').value;
            const player = currentData.find(p => p.userId === playerId);

            if (!player) return;

            const statsToChart = [
                { key: 'kills', label: 'Kills', yAxisID: 'y' },
                { key: 'enemies_destroyed', label: 'K·∫ª Th√π Ti√™u Di·ªát', yAxisID: 'y1' },
                { key: 'enemy_wounded', label: 'Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng', yAxisID: 'y' },
                { key: 'troops_lost', label: 'S·ªë Qu√¢n T·ªïn Th·∫•t', yAxisID: 'y' }
            ];

            const labels = statsToChart.map(s => s.label);

            const datasets = statsToChart.map((stat, index) => {
                const value = calculateDifference(player.julyStats?.[stat.key], player.juneStats?.[stat.key]) || 0;

                let backgroundColor;
                if (stat.key === 'troops_lost') {
                    backgroundColor = value <= 0 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)';
                } else {
                    backgroundColor = value >= 0 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)';
                }

                // Create a dataset for each stat
                return {
                    label: stat.label,
                    data: labels.map((_, i) => i === index ? value : null), // Only one value per dataset
                    backgroundColor: backgroundColor,
                    borderWidth: 1,
                    yAxisID: stat.yAxisID
                };
            });

            const ctx = document.getElementById('statsChart').getContext('2d');
            chartInstance = new Chart(ctx, {

                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { // To make tooltips work better with this setup
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: { display: true, text: `Bi·∫øn ƒë·ªông ch·ªâ s·ªë c·ªßa: ${player.name}`, font: { size: 16 } },
                        legend: { display: false }, // Legend is redundant with x-axis labels
                        tooltip: {
                            callbacks: {
                                // Show only the tooltip for the non-null value
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';

                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Kills / B·ªã th∆∞∆°ng / T·ªïn th·∫•t' },
                            ticks: { callback: (value) => value.toLocaleString() }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'K·∫ª Th√π Ti√™u Di·ªát' },
                            ticks: { callback: (value) => value.toLocaleString() },
                            // This is crucial to prevent the grid lines from overlapping
                            grid: { drawOnChartArea: false, },
                        }
                    }
                }
            });
        }

        function hideOverallComparisonChart() {
            document.getElementById('overallComparisonChartModal').style.display = 'none';
            // X√≥a n·ªôi dung container ƒë·ªÉ h·ªßy c√°c bi·ªÉu ƒë·ªì v√† gi·∫£i ph√≥ng b·ªô nh·ªõ
            document.getElementById('overallChartContainer').innerHTML = '';
        }

        function showOverallComparisonChart() {
            const container = document.getElementById('overallChartContainer');
            container.innerHTML = ''; // X√≥a c√°c bi·ªÉu ƒë·ªì c≈©

            const eligiblePlayers = currentData.filter(p => p.hasBothData);
            if (eligiblePlayers.length === 0) {
                alert("Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i n√†o c√≥ ƒë·ªß d·ªØ li·ªáu ·ªü c·∫£ 2 th√°ng ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.");
                return;
            }

            // S·∫Øp x·∫øp theo ch√™nh l·ªách Kills gi·∫£m d·∫ßn ho·∫∑c theo t√™n
            if (!window.showMonthlyDataOverall) {
                eligiblePlayers.sort((a, b) => {
                    const diffA = calculateDifference(a.julyStats?.kills, a.juneStats?.kills) || 0;
                    const diffB = calculateDifference(b.julyStats?.kills, b.juneStats?.kills) || 0;
                    return diffB - diffA;
                });
            } else {
                eligiblePlayers.sort((a, b) => a.name.localeCompare(b.name));

            }

            // ƒê·ªãnh d·∫°ng s·ªë
            const formatVietnameseTick = (value) => {
                if (value === 0) return '0';
                const absVal = Math.abs(value);
                const sign = value < 0 ? '-' : '';
                if (absVal >= 1e12) return sign + (absVal / 1e12).toFixed(2).replace(/\.00$|\.0$/, '') + ' ngh√¨n t·ª∑';
                if (absVal >= 1e9) return sign + (absVal / 1e9).toFixed(2).replace(/\.00$|\.0$/, '') + ' t·ª∑';
                if (absVal >= 1e6) return sign + (absVal / 1e6).toFixed(2).replace(/\.00$|\.0$/, '') + ' tri·ªáu';
                if (absVal >= 1e3) return sign + (absVal / 1e3).toFixed(0) + 'k';
                return value.toLocaleString('vi-VN');
            };

            const statsConfig = [
                { key: 'enemies_destroyed', label: 'K·∫ª Th√π Ti√™u Di·ªát', colorJune: 'rgba(54, 162, 235, 0.7)', colorJuly: 'rgba(54, 162, 235, 0.35)', xAxisID: 'x1' },
                { key: 'kills', label: 'Kills', colorJune: 'rgba(75, 192, 192, 0.7)', colorJuly: 'rgba(75, 192, 192, 0.35)', xAxisID: 'x' },
                { key: 'enemy_wounded', label: 'Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng', colorJune: 'rgba(255, 206, 86, 0.7)', colorJuly: 'rgba(255, 206, 86, 0.35)', xAxisID: 'x' },
                { key: 'troops_lost', label: 'S·ªë Qu√¢n T·ªïn Th·∫•t', colorJune: 'rgba(255, 99, 132, 0.7)', colorJuly: 'rgba(255, 99, 132, 0.35)', xAxisID: 'x' }
            ];
            const chartLabels = statsConfig.map(s => s.label);

            eligiblePlayers.forEach((player, index) => {
                const playerChartContainer = document.createElement('div');
                playerChartContainer.style.height = '350px';
                playerChartContainer.style.position = 'relative';
                playerChartContainer.style.marginBottom = '40px';

                const canvas = document.createElement('canvas');
                playerChartContainer.appendChild(canvas);
                container.appendChild(playerChartContainer);

                let chartConfig;

                if (window.showMonthlyDataOverall) {          
                
                    // CH·∫æ ƒê·ªò 1: M·ªói th√°ng 1 d√≤ng ri√™ng bi·ªát, c√≥ 2 tr·ª•c gi√° tr·ªã
                    const labels = [];
                    const datasets = [];
                    statsConfig.forEach(stat => {
                        // Label ri√™ng cho t·ª´ng th√°ng
                        labels.push(`${stat.label} - Th√°ng ${selectedMonths.june}`);
                        labels.push(`${stat.label} - Th√°ng ${selectedMonths.july}`);

                        // Dataset th√°ng 6 (ch·ªâ c√≥ gi√° tr·ªã ·ªü d√≤ng th√°ng 6, d√≤ng th√°ng 7 null)
                        datasets.push({
                            label: `${stat.label} - Th√°ng ${selectedMonths.june}`,
                            data: labels.map(l => l === `${stat.label} - Th√°ng ${selectedMonths.june}` ? (player.juneStats?.[stat.key] || 0) : null),
                            backgroundColor: 'rgba(59, 130, 246, 0.75)', // xanh
                            barPercentage: 3,
                            categoryPercentage: 0.9,
                            maxBarThickness: 42,
                            xAxisID: stat.xAxisID
                        });

                        // Dataset th√°ng 7 (ch·ªâ c√≥ gi√° tr·ªã ·ªü d√≤ng th√°ng 7, d√≤ng th√°ng 6 null)
                        datasets.push({
                            label: `${stat.label} - Th√°ng ${selectedMonths.july}`,
                            data: labels.map(l => l === `${stat.label} - Th√°ng ${selectedMonths.july}` ? (player.julyStats?.[stat.key] || 0) : null),
                            backgroundColor: 'rgba(234, 88, 12, 0.75)', // cam
                            barPercentage: 5,
                            categoryPercentage: 0.9,
                            maxBarThickness: 42,
                            xAxisID: stat.xAxisID
                        });
                    });

                    chartConfig = {
                        type: 'bar',
                        data: { labels, datasets },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${index + 1}. ${player.name}`,
                                    align: 'start',
                                    font: { size: 16, weight: 'bold' },
                                    padding: { bottom: 10 }
                                },
                                legend: { display: false }, // legend kh√¥ng c·∫ßn v√¨ label ƒë√£ c√≥ th√°ng
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x?.toLocaleString('vi-VN')}`
                                    }
                                },
                                datalabels: {
                                    anchor: 'end', // Di chuy·ªÉn nh√£n ra cu·ªëi thanh
                                    align: 'end',  // CƒÉn l·ªÅ nh√£n ·ªü cu·ªëi thanh
                                    offset: 4,     // Th√™m m·ªôt ch√∫t kho·∫£ng c√°ch t·ª´ cu·ªëi thanh
                                    formatter: (value) => value?.toLocaleString('vi-VN'),
                                    color: '#333', // ƒê·ªïi m√†u ch·ªØ th√†nh m√†u t·ªëi ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n n·ªÅn tr·∫Øng
                                    font: {
                                        weight: 'bold',
                                        size: 10
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Kills / B·ªã th∆∞∆°ng / T·ªïn th·∫•t' },
                                    ticks: { callback: formatVietnameseTick }
                                },
                                x1: {
                                    type: 'linear',
                                    position: 'top',
                                    title: { display: true, text: 'K·∫ª Th√π Ti√™u Di·ªát' },
                                    grid: { drawOnChartArea: false },
                                    ticks: { callback: formatVietnameseTick }
                                }
                            }
                        }
                    };
                }


                else {
                    // CH·∫æ ƒê·ªò 2: T·ªïng ch√™nh l·ªách (gi·ªØ nguy√™n)
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: statsConfig.map((stat, i) => ({
                                label: stat.label,
                                data: chartLabels.map((_, j) => i === j ? (calculateDifference(player.julyStats?.[stat.key], player.juneStats?.[stat.key]) || 0) : null),
                                backgroundColor: stat.colorJune,
                                barPercentage: 3,        // tƒÉng ƒë·ªô r·ªông thanh
                                categoryPercentage: 0.9,
                                maxBarThickness: 42,
                                xAxisID: stat.xAxisID
                            }))
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: `${index + 1}. ${player.name}`, align: 'start', font: { size: 15, weight: 'bold' }, padding: { bottom: 5 } },
                                legend: { display: false },
                                tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x.toLocaleString('vi-VN')}` } },
                                datalabels: {
                                    anchor: 'end', // ƒê·∫∑t neo ·ªü cu·ªëi thanh
                                    align: 'end',  // CƒÉn l·ªÅ ·ªü cu·ªëi thanh (b√™n ngo√†i)
                                    offset: 4,     // Kho·∫£ng c√°ch nh·ªè t·ª´ cu·ªëi thanh
                                    formatter: (value) => value?.toLocaleString('vi-VN'),
                                    color: (context) => {
                                        // L·∫•y gi√° tr·ªã t·ª´ context ƒë·ªÉ quy·∫øt ƒë·ªãnh m√†u s·∫Øc
                                        const value = context.dataset.data[context.dataIndex];
                                        if (value > 0) return 'green';
                                        if (value < 0) return 'red';
                                        return '#666'; // M√†u cho gi√° tr·ªã 0
                                    },
                                    font: {
                                        size: 10,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Kills / B·ªã th∆∞∆°ng / T·ªïn th·∫•t' }, ticks: { callback: formatVietnameseTick } },
                                x1: { type: 'linear', position: 'top', title: { display: true, text: 'K·∫ª Th√π Ti√™u Di·ªát' }, grid: { drawOnChartArea: false }, ticks: { callback: formatVietnameseTick } }
                            }
                        }
                    };
                }

                new Chart(canvas.getContext('2d'), chartConfig);
            });

            document.getElementById('overallComparisonChartModal').style.display = 'block';
        }

        function exportComparisonChartPDF() {
    const charts = document.getElementById('overallChartContainer');

    if (!charts) {
        alert("Kh√¥ng t√¨m th·∫•y bi·ªÉu ƒë·ªì ƒë·ªÉ xu·∫•t PDF!");
        return;
    }

    const opt = {
        margin:       0.2,
        filename:     'bieu-do-so-sanh.pdf',
        image:        { type: 'jpeg', quality: 1 },
        html2canvas:  { scale: 2, useCORS: true, logging: false },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(charts).save();
}


    </script>


</body>

</html>
