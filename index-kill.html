<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• So s√°nh Th·ªëng k√™</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            overflow-x: auto;
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upload-box {
            border: 1px solid #ddd;
            padding: 10px;
            flex: 1;
            border-radius: 4px;
        }

        .upload-box h2 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            margin-right: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.tertiary {
            background-color: #ff9800;
        }

        button.tertiary:hover {
            background-color: #e68a00;
        }

        button.quaternary {
            background-color: #9c27b0;
        }

        button.quaternary:hover {
            background-color: #7b1fa2;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            font-size: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        /* Style cho header nh√≥m */
        th[colspan] {
            text-align: center;
            border-bottom: 2px solid #ccc; /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi ƒë·∫≠m h∆°n ƒë·ªÉ ph√¢n t√°ch c·∫•p */
            border-right: 2px solid #adadad;  /* ƒê∆∞·ªùng k·∫ª ph·∫£i ƒë·∫≠m h∆°n ƒë·ªÉ ph√¢n t√°ch c√°c nh√≥m */
            font-weight: bold;
            color: #333;
        }
        th[colspan]:last-child {
            border-right: 1px solid #ddd; /* Gi·ªØ border cho c·ªôt cu·ªëi c√πng c·ªßa header */
        }

        /* Th√™m ƒë∆∞·ªùng vi·ªÅn ƒë·∫≠m cho c·ªôt cu·ªëi c·ªßa nh√≥m th√¥ng tin (Rank) */
        .info-group-separator {
            border-right: 2px solid #adadad;
        }

        /* M√†u n·ªÅn cho t·ª´ng nh√≥m ƒë·ªÉ ph√¢n bi·ªát r√µ r√†ng */
        .group-might { background-color: #eaf2f8; }
        .group-kills { background-color: #e8f8f5; }
        .group-captured { background-color: #fef5e7; }
        .group-destroyed { background-color: #feebef; }
        .group-enemy-wounded { background-color: #f4ecf7; }
        .group-troops-killed { background-color: #d6eaf8; }
        .group-troops-lost { background-color: #fdedec; }
        .group-troops-wounded { background-color: #d7bde2; }
        .group-losses { background-color: #fef9e7; }
        .group-attacks { background-color: #e8f6f3; }
        .group-defenses { background-color: #eaeded; }
        .group-victories { background-color: #a9cce3; }
        .group-win-rate { background-color: #a3e4d7; }

        thead tr:last-child th {
            white-space: nowrap;
            background-color: #f8f9f9; /* M√†u n·ªÅn ri√™ng cho header ph·ª• */
        }

        .positive {
            color: green;
            font-weight: bold;
        }

        .negative {
            color: red;
            font-weight: bold;
        }

        .neutral {
            color: #666;
        }

        .no-data {
            color: #999;
            font-style: italic;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .realtime-filter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-filter input[type="checkbox"] {
            margin: 0;
        }

        .status {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .success {
            background-color: #e6ffe6;
            color: #006600;
        }

        .error {
            background-color: #ffebeb;
            color: #cc0000;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .compact-col {
            min-width: 70px;
        }

        .missing-data-row {
            background-color: #f9f9f9;
        }

        .priority-row {
            background-color: #fffacd !important;
        }

        .hidden-col {
            display: none;
        }

        .priority-input {
            margin-top: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .priority-label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .upload-box input[type="file"] {
            margin-bottom: 10px;
        }

        .url-upload-group {
            display: flex;
            gap: 5px;
        }
        .url-upload-group input[type="text"] {
            flex-grow: 1;
            width: auto; /* Override width: 100% */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>C√¥ng c·ª• So s√°nh Th·ªëng k√™</h1>

        <div class="upload-section">
            <div class="upload-box">
                <h2>D·ªØ li·ªáu Th√°ng 6</h2>
                <label for="juneFile">T·∫£i t·ª´ m√°y:</label>
                <input type="file" id="juneFile" accept=".xlsx,.xls" />
                <label for="juneUrl">Ho·∫∑c t·∫£i t·ª´ URL:</label>
                <div class="url-upload-group">
                    <input type="text" id="juneUrl" placeholder="D√°n link Google Sheets...">
                    <button onclick="loadFromUrl('june')" class="secondary">T·∫£i</button>
                </div>
                <div id="juneStatus" class="status"></div>
            </div>

            <div class="upload-box">
                <h2>D·ªØ li·ªáu Th√°ng 7</h2>
                <label for="julyFile">T·∫£i t·ª´ m√°y:</label>
                <input type="file" id="julyFile" accept=".xlsx,.xls" />
                <label for="julyUrl">Ho·∫∑c t·∫£i t·ª´ URL:</label>
                <div class="url-upload-group">
                    <input type="text" id="julyUrl" placeholder="D√°n link Google Sheets...">
                    <button onclick="loadFromUrl('july')" class="secondary">T·∫£i</button>
                </div>
                <div id="julyStatus" class="status"></div>
            </div>
        </div>

        <div class="filter-controls">
            <div class="filter-section">
                <label class="priority-label">ID ∆∞u ti√™n (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
                <input type="text" id="priorityIds" class="priority-input"
                    placeholder="Nh·∫≠p c√°c ID ∆∞u ti√™n, v√≠ d·ª•: 123,456,789" 
                    value="416381060,765602761,417896120,537487142,360966484"/>
                <div class="action-buttons">
                    <button onclick="applyPriorityFilter()" class="secondary">√Åp d·ª•ng l·ªçc</button>
                    <div class="realtime-filter">
                        <input type="checkbox" id="realtimeFilter" checked>
                        <label for="realtimeFilter">L·ªçc realtime</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="flex: 1;">
                <input type="text" id="searchInput" placeholder="T√¨m theo t√™n ho·∫∑c ID..." />
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="searchTable()">T√¨m ki·∫øm</button>
                    <button onclick="sortTable('killsDiff', 'asc')" class="secondary">S·∫Øp x·∫øp Kills (TƒÉng)</button>
                    <button onclick="sortTable('killsDiff', 'desc')" class="secondary">S·∫Øp x·∫øp Kills (Gi·∫£m)</button>
                    <button onclick="toggleIdColumn()" class="tertiary">·∫®n/Hi·ªán ID</button>
                    <button id="exportPngBtn" onclick="exportToPNG()" class="tertiary">Xu·∫•t ·∫£nh PNG</button>
                    <button onclick="exportToExcel()" class="quaternary">Xu·∫•t file Excel</button>
                    <button onclick="resetTable()">ƒê·∫∑t l·∫°i</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ƒêang x·ª≠ l√Ω...</p>
        </div>

        <div id="tableContainer">
            <table id="comparisonTable">
                <thead>
                    <!-- D√≤ng ti√™u ƒë·ªÅ ch√≠nh -->
                    <tr>
                        <th rowspan="2">STT</th>
                        <th rowspan="2">T√™n</th>
                        <th rowspan="2" class="id-col">User ID</th>
                        <th rowspan="2" class="info-group-separator">Rank</th>
                        <th colspan="3" class="group-might">Might</th>
                        <th colspan="3" class="group-kills">Kills</th>
                        <th colspan="3" class="group-captured">K·∫ª Th√π B·ªã B·∫Øt</th>
                        <th colspan="3" class="group-destroyed">K·∫ª Th√π Ti√™u Di·ªát</th>
                        <th colspan="3" class="group-enemy-wounded">Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng</th>
                        <th colspan="3" class="group-troops-killed">Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt</th>
                        <th colspan="3" class="group-troops-lost">S·ªë Qu√¢n T·ªïn Th·∫•t</th>
                        <th colspan="3" class="group-troops-wounded">Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng</th>
                        <th colspan="3" class="group-losses">Thua</th>
                        <th colspan="3" class="group-attacks">T·∫•n c√¥ng Th√†nh c√¥ng</th>
                        <th colspan="3" class="group-defenses">Ph√≤ng th·ªß Th√†nh c√¥ng</th>
                        <th colspan="3" class="group-victories">Chi·∫øn Th·∫Øng</th>
                        <th colspan="3" class="group-win-rate">T·ªâ L·ªá Chi·∫øn Th·∫Øng</th>
                    </tr>
                    <!-- D√≤ng ti√™u ƒë·ªÅ ph·ª• -->
                    <tr>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                        <th>Th√°ng 6</th><th>Th√°ng 7</th><th>Ch√™nh l·ªách</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let juneData = {};
        let julyData = {};
        let currentData = [];
        let showIdColumn = true;
        let priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
        let realtimeFilterEnabled = true;
        let currentSort = { column: 'name', direction: 'asc' };

        // H√†m x·ª≠ l√Ω upload file
        function handleFileUpload(file, type) {
            const reader = new FileReader();
            const statusElement = document.getElementById(`${type}Status`);

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (type === 'june') {
                        juneData = processData(jsonData);
                        statusElement.textContent = `ƒê√£ t·∫£i th√°ng 6: ${Object.keys(juneData).length} ng∆∞·ªùi ch∆°i`;
                        statusElement.className = 'status success';
                    } else {
                        julyData = processData(jsonData);
                        statusElement.textContent = `ƒê√£ t·∫£i th√°ng 7: ${Object.keys(julyData).length} ng∆∞·ªùi ch∆°i`;
                        statusElement.className = 'status success';
                    }

                    if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                        compareData();
                    }
                } catch (error) {
                    statusElement.textContent = `L·ªói: ${error.message}`;
                    statusElement.className = 'status error';
                }
            };

            reader.onerror = function () {
                statusElement.textContent = `L·ªói ƒë·ªçc file`;
                statusElement.className = 'status error';
            };

            reader.readAsArrayBuffer(file);
        }

        // H√†m t·∫£i t·ª´ URL, ƒë∆∞·ª£c l·∫•y v√† ch·ªânh s·ª≠a t·ª´ file index.html
        async function loadFromUrl(type) {
            const urlInputId = `${type}Url`;
            const statusElementId = `${type}Status`;
            const urlInput = document.getElementById(urlInputId);
            const statusElement = document.getElementById(statusElementId);

            const rawUrl = urlInput.value.trim();
            if (!rawUrl) {
                alert(`Vui l√≤ng nh·∫≠p URL cho th√°ng ${type === 'june' ? '6' : '7'}!`);
                return;
            }

            let exportUrl = '';
            const googleSheetRegex = /(?:spreadsheets|file)\/d\/([a-zA-Z0-9-_]+)/;
            const match = rawUrl.match(googleSheetRegex);

            if (match && match[1]) {
                const sheetId = match[1];
                exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            } else if (rawUrl.toLowerCase().endsWith('.xlsx') || rawUrl.toLowerCase().endsWith('.xls')) {
                exportUrl = rawUrl;
            } else {
                alert("URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng cung c·∫•p link Google Sheets/File h·ª£p l·ªá (ƒë√£ chia s·∫ª c√¥ng khai) ho·∫∑c link tr·ª±c ti·∫øp ƒë·∫øn file .xlsx.");
                return;
            }

            statusElement.textContent = 'ƒêang t·∫£i t·ª´ URL...';
            statusElement.className = 'status';
            const loading = showLoading(`ƒêang t·∫£i d·ªØ li·ªáu th√°ng ${type === 'june' ? '6' : '7'}...`);

            try {
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
                const fetchUrl = proxyUrl + encodeURIComponent(exportUrl);

                const response = await fetch(fetchUrl, { signal: AbortSignal.timeout(30000) });

                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !(contentType.includes('spreadsheetml.sheet') || contentType.includes('application/vnd.ms-excel') || contentType.includes('octet-stream'))) {
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();
                    if (responseText.trim().toLowerCase().startsWith('<html') || responseText.trim().toLowerCase().startsWith('<!doctype html')) {
                        throw new Error("L·ªói ƒë·ªãnh d·∫°ng: Nh·∫≠n ƒë∆∞·ª£c HTML thay v√¨ file Excel. ƒê·∫£m b·∫£o link ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.");
                    }
                }

                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength < 100) {
                    throw new Error("T·∫£i file th·∫•t b·∫°i: File nh·∫≠n ƒë∆∞·ª£c qu√° nh·ªè.");
                }

                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                const processed = processData(jsonData);
                if (type === 'june') {
                    juneData = processed;
                    statusElement.textContent = `ƒê√£ t·∫£i th√°ng 6 t·ª´ URL: ${Object.keys(juneData).length} ng∆∞·ªùi ch∆°i`;
                    statusElement.className = 'status success';
                } else {
                    julyData = processed;
                    statusElement.textContent = `ƒê√£ t·∫£i th√°ng 7 t·ª´ URL: ${Object.keys(julyData).length} ng∆∞·ªùi ch∆°i`;
                    statusElement.className = 'status success';
                }

                if (Object.keys(juneData).length > 0 && Object.keys(julyData).length > 0) {
                    compareData();
                }
            } catch (error) {
                console.error(`L·ªói khi t·∫£i URL cho ${type}:`, error);
                statusElement.textContent = `L·ªói t·∫£i URL: ${error.message}`;
                statusElement.className = 'status error';
            } finally {
                loading.remove();
            }
        }

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu
        function processData(sheetData) {
            const result = {};
            let headerRowIndex = -1;

            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row && row.includes("User ID")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) throw new Error("Kh√¥ng t√¨m th·∫•y h√†ng ti√™u ƒë·ªÅ");

            const headers = sheetData[headerRowIndex];
            const getColIndex = (headerName) => {
                return headers.findIndex(h => h && h.toString().trim().toLowerCase() === headerName.toLowerCase());
            };

            const indices = {
                name: getColIndex("Name"),
                userId: getColIndex("User ID"),
                rank: getColIndex("Rank"),
                might: getColIndex("Might"),
                kills: getColIndex("Kills"),
                enemiesCaptured: getColIndex("Enemies captured"),
                enemiesDestroyed: getColIndex("Enemies Destroyed Might"),
                enemyWounded: getColIndex("Enemy Troops Wounded"),
                troopsKilled: getColIndex("Troops Killed"),
                troopsLost: getColIndex("Troops Lost"),
                troopsWounded: getColIndex("Troops Wounded"),
                losses: getColIndex("Losses"),
                successfulAttacks: getColIndex("Successful Attacks"),
                successfulDefenses: getColIndex("Ph√≤ng th·ªß th√†nh c√¥ng"),
                victories: getColIndex("Victories"),
                winRate: getColIndex("Win Rate")
            };

            for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;

                const userId = row[indices.userId];
                if (!userId) continue;

                const getValue = (index, defaultValue = 0) => {
                    if (index === -1) return defaultValue;
                    const val = row[index];
                    if (val === undefined || val === null) return defaultValue;
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string') {
                        if (indices.winRate === index && val.includes('%')) {
                            return parseFloat(val.replace(',', '.').replace('%', '')) || 0;
                        }
                        const num = parseFloat(val.replace(/[^0-9.-]/g, ''));
                        return isNaN(num) ? defaultValue : num;
                    }
                    return defaultValue;
                };

                result[userId] = {
                    name: row[indices.name] || 'Kh√¥ng x√°c ƒë·ªãnh',
                    rank: row[indices.rank] || 'Kh√¥ng x√°c ƒë·ªãnh',
                    might: getValue(indices.might),
                    kills: getValue(indices.kills),
                    enemies_captured: getValue(indices.enemiesCaptured),
                    enemies_destroyed: getValue(indices.enemiesDestroyed),
                    enemy_wounded: getValue(indices.enemyWounded),
                    troops_killed: getValue(indices.troopsKilled),
                    troops_lost: getValue(indices.troopsLost),
                    troops_wounded: getValue(indices.troopsWounded),
                    losses: getValue(indices.losses),
                    successful_attacks: getValue(indices.successfulAttacks),
                    successful_defenses: getValue(indices.successfulDefenses),
                    victories: getValue(indices.victories),
                    win_rate: row[indices.winRate] ? row[indices.winRate].toString() : '0%'
                };
            }

            return result;
        }

        // H√†m so s√°nh d·ªØ li·ªáu
        function compareData() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';

            setTimeout(() => {
                try {
                    const allUserIds = new Set([...Object.keys(juneData), ...Object.keys(julyData)]);
                    currentData = [];

                    Array.from(allUserIds).forEach(userId => {
                        const juneStats = juneData[userId];
                        const julyStats = julyData[userId];

                        if (!juneStats && !julyStats) return;

                        const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                        const isPriority = priorityIds.includes(userId);

                        currentData.push({
                            userId,
                            name: julyStats?.name || juneStats?.name || 'Kh√¥ng x√°c ƒë·ªãnh',
                            rank: julyStats?.rank || juneStats?.rank || 'Kh√¥ng x√°c ƒë·ªãnh',
                            juneStats,
                            julyStats,
                            killsDiff,
                            hasBothData: juneStats && julyStats,
                            isPriority
                        });
                    });

                    applyPriorityFilter();

                } catch (error) {
                    console.error('L·ªói khi so s√°nh:', error);
                } finally {
                    loadingElement.style.display = 'none';
                }
            }, 100);
        }

        // H√†m c·∫≠p nh·∫≠t ID ∆∞u ti√™n
        function updatePriorityIds() {
            const input = document.getElementById('priorityIds').value;
            priorityIds = input.split(',')
                .map(id => id.trim())
                .filter(id => id !== '');

            currentData.forEach(item => {
                item.isPriority = priorityIds.includes(item.userId);
            });
        }

        // H√†m √°p d·ª•ng b·ªô l·ªçc ∆∞u ti√™n
        function applyPriorityFilter() {
            updatePriorityIds();
            sortTable(currentSort.column, currentSort.direction);
        }

        // H√†m s·∫Øp x·∫øp b·∫£ng
        function sortTable(column, direction) {
            if (!currentData.length) return;

            currentSort = { column, direction };
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const sortedData = [...currentData].sort((a, b) => {
                // ∆Øu ti√™n c√°c ID trong danh s√°ch priorityIds l√™n ƒë·∫ßu
                if (a.isPriority && !b.isPriority) return -1;
                if (!a.isPriority && b.isPriority) return 1;
                if (a.isPriority && b.isPriority) {
                    return a.name.localeCompare(b.name);
                }

                if (column === 'killsDiff') {
                    if (a.hasBothData && b.hasBothData) {
                        return direction === 'asc' ? a.killsDiff - b.killsDiff : b.killsDiff - a.killsDiff;
                    }
                    if (!a.hasBothData && !b.hasBothData) return 0;
                    if (!a.hasBothData) return 1;
                    if (!b.hasBothData) return -1;
                } else {
                    return direction === 'asc'
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                }
                return 0;
            });

            displaySortedData(sortedData);
        }

        // H√†m hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ s·∫Øp x·∫øp
        function displaySortedData(sortedData) {
            const tableBody = document.getElementById('tableBody');

            sortedData.forEach((item, index) => {
                const { userId, name, rank, juneStats, julyStats, hasBothData, isPriority } = item;
                const row = document.createElement('tr');

                if (!hasBothData) row.classList.add('missing-data-row');
                if (isPriority) row.classList.add('priority-row');

                const mightDiff = calculateDifference(julyStats?.might, juneStats?.might);
                const killsDiff = calculateDifference(julyStats?.kills, juneStats?.kills);
                const enemiesCapturedDiff = calculateDifference(julyStats?.enemies_captured, juneStats?.enemies_captured);
                const enemiesDestroyedDiff = calculateDifference(julyStats?.enemies_destroyed, juneStats?.enemies_destroyed);
                const enemyWoundedDiff = calculateDifference(julyStats?.enemy_wounded, juneStats?.enemy_wounded);
                const troopsKilledDiff = calculateDifference(julyStats?.troops_killed, juneStats?.troops_killed);
                const troopsLostDiff = calculateDifference(julyStats?.troops_lost, juneStats?.troops_lost);
                const troopsWoundedDiff = calculateDifference(julyStats?.troops_wounded, juneStats?.troops_wounded);
                const lossesDiff = calculateDifference(julyStats?.losses, juneStats?.losses);
                const successfulAttacksDiff = calculateDifference(julyStats?.successful_attacks, juneStats?.successful_attacks);
                const successfulDefensesDiff = calculateDifference(julyStats?.successful_defenses, juneStats?.successful_defenses);
                const victoriesDiff = calculateDifference(julyStats?.victories, juneStats?.victories);
                const winRateDiff = compareWinRates(julyStats?.win_rate, juneStats?.win_rate);

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td class="id-col">${userId}</td>
                    <td>${rank}</td>
                    <!-- Might -->
                    <td>${formatNumber(juneStats?.might)}</td>
                    <td>${formatNumber(julyStats?.might)}</td>
                    <td>${formatDifference(mightDiff)}</td>
                    <!-- Kills -->
                    <td>${formatNumber(juneStats?.kills)}</td>
                    <td>${formatNumber(julyStats?.kills)}</td>
                    <td>${formatDifference(killsDiff)}</td>
                    <!-- Enemies Captured -->
                    <td>${formatNumber(juneStats?.enemies_captured)}</td>
                    <td>${formatNumber(julyStats?.enemies_captured)}</td>
                    <td>${formatDifference(enemiesCapturedDiff)}</td>
                    <!-- Enemies Destroyed -->
                    <td>${formatNumber(juneStats?.enemies_destroyed)}</td>
                    <td>${formatNumber(julyStats?.enemies_destroyed)}</td>
                    <td>${formatDifference(enemiesDestroyedDiff)}</td>
                    <!-- Enemy Wounded -->
                    <td>${formatNumber(juneStats?.enemy_wounded)}</td>
                    <td>${formatNumber(julyStats?.enemy_wounded)}</td>
                    <td>${formatDifference(enemyWoundedDiff)}</td>
                    <!-- Troops Killed -->
                    <td>${formatNumber(juneStats?.troops_killed)}</td>
                    <td>${formatNumber(julyStats?.troops_killed)}</td>
                    <td>${formatDifference(troopsKilledDiff)}</td>
                    <!-- Troops Lost -->
                    <td>${formatNumber(juneStats?.troops_lost)}</td>
                    <td>${formatNumber(julyStats?.troops_lost)}</td>
                    <td>${formatDifference(troopsLostDiff)}</td>
                    <!-- Troops Wounded -->
                    <td>${formatNumber(juneStats?.troops_wounded)}</td>
                    <td>${formatNumber(julyStats?.troops_wounded)}</td>
                    <td>${formatDifference(troopsWoundedDiff)}</td>
                    <!-- Losses -->
                    <td>${formatNumber(juneStats?.losses)}</td>
                    <td>${formatNumber(julyStats?.losses)}</td>
                    <td>${formatDifference(lossesDiff)}</td>
                    <!-- Successful Attacks -->
                    <td>${formatNumber(juneStats?.successful_attacks)}</td>
                    <td>${formatNumber(julyStats?.successful_attacks)}</td>
                    <td>${formatDifference(successfulAttacksDiff)}</td>
                    <!-- Successful Defenses -->
                    <td>${formatNumber(juneStats?.successful_defenses)}</td>
                    <td>${formatNumber(julyStats?.successful_defenses)}</td>
                    <td>${formatDifference(successfulDefensesDiff)}</td>
                    <!-- Victories -->
                    <td>${formatNumber(juneStats?.victories)}</td>
                    <td>${formatNumber(julyStats?.victories)}</td>
                    <td>${formatDifference(victoriesDiff)}</td>
                    <!-- Win Rate -->
                    <td>${juneStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
                    <td>${julyStats?.win_rate || '<span class="no-data">N/A</span>'}</td>
                    <td>${winRateDiff}</td>
                `;

                tableBody.appendChild(row);
            });

            toggleIdColumn(showIdColumn);
        }

        // C√°c h√†m ti·ªán √≠ch
        function formatNumber(num) {
            if (num === undefined || num === null) return '<span class="no-data">N/A</span>';
            return num.toLocaleString();
        }

        function calculateDifference(newVal, oldVal) {
            if (newVal === undefined || oldVal === undefined) return null;
            return newVal - oldVal;
        }

        function formatDifference(diff) {
            if (diff === null) return '<span class="no-data">N/A</span>';
            if (diff > 0) return `<span class="positive">+${formatNumber(diff)}</span>`;
            if (diff < 0) return `<span class="negative">${formatNumber(diff)}</span>`;
            return `<span class="neutral">0</span>`;
        }

        function compareWinRates(newRate, oldRate) {
            if (!newRate || !oldRate) return '<span class="no-data">N/A</span>';

            const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
            const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
            const diff = newNum - oldNum;

            if (diff > 0) return `<span class="positive">+${diff.toFixed(2)}%</span>`;
            if (diff < 0) return `<span class="negative">${diff.toFixed(2)}%</span>`;
            return `<span class="neutral">0%</span>`;
        }

        // C√°c h√†m x·ª≠ l√Ω giao di·ªán
        function searchTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('comparisonTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[1];
                const idCell = rows[i].getElementsByTagName('td')[2];

                if (nameCell && idCell) {
                    const nameText = nameCell.textContent || nameCell.innerText;
                    const idText = idCell.textContent || idCell.innerText;

                    if (nameText.toUpperCase().indexOf(filter) > -1 || idText.indexOf(filter) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function toggleIdColumn() {
            const idCols = document.querySelectorAll('.id-col');
            showIdColumn = !showIdColumn;

            idCols.forEach(col => {
                if (showIdColumn) {
                    col.classList.remove('hidden-col');
                } else {
                    col.classList.add('hidden-col');
                }
            });
        }

        // Ch·ª©c nƒÉng xu·∫•t ·∫£nh ƒë∆∞·ª£c l·∫•y t·ª´ file index.html theo y√™u c·∫ßu
        async function exportToPNG() {
            if (!currentData.length) {
                alert("Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!");
                return;
            }

            // L·∫•y tr·ª±c ti·∫øp b·∫£ng d·ªØ li·ªáu
            const tableElement = document.getElementById('comparisonTable');

            if (!tableElement) {
                alert(`Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu ƒë·ªÉ xu·∫•t ·∫£nh.`);
                return;
            }

            // --- Chu·∫©n b·ªã ch·ª•p: T·∫°m th·ªùi b·ªè style sticky c·ªßa header ---
            const thElements = tableElement.querySelectorAll('th');
            const originalThStyles = [];
            thElements.forEach(th => {
                originalThStyles.push(th.style.position);
                th.style.position = 'static';
            });

            // --- Ph·∫£n h·ªìi UI ---
            const exportButton = document.getElementById('exportPngBtn');
            const originalButtonText = exportButton.textContent;
            exportButton.textContent = 'üì∏ ƒêang x·ª≠ l√Ω...';
            exportButton.disabled = true;

            setTimeout(async () => {
                let stylesRestored = false;
                const restoreStyles = () => {
                    if (!stylesRestored) {
                        thElements.forEach((th, index) => {
                            th.style.position = originalThStyles[index] || '';
                        });
                        stylesRestored = true;
                    }
                };

                try {
                    // Ch·ª•p ·∫£nh v·ªõi k√≠ch th∆∞·ªõc ƒë·∫ßy ƒë·ªß c·ªßa b·∫£ng (bao g·ªìm c·∫£ ph·∫ßn b·ªã cu·ªôn)
                    const canvas = await html2canvas(tableElement, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: tableElement.scrollWidth,
                        height: tableElement.scrollHeight,
                    });

                    restoreStyles();

                    const imageDataUrl = canvas.toDataURL('image/png');

                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write(`<!DOCTYPE html><html><head><title>B√°o c√°o so s√°nh</title></head><body style="margin:0;"><img src="${imageDataUrl}" alt="B√°o c√°o so s√°nh" style="max-width: 100%; display: block;"></body></html>`);
                        newWindow.document.close();
                    } else {
                        alert("Kh√¥ng th·ªÉ m·ªü tab m·ªõi. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t ch·∫∑n pop-up c·ªßa tr√¨nh duy·ªát v√† th·ª≠ l·∫°i.");
                    }

                } catch (error) {
                    console.error('L·ªói xu·∫•t ·∫£nh:', error);
                    alert(`Xu·∫•t ·∫£nh th·∫•t b·∫°i! L·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra console (F12).`);
                    restoreStyles(); // ƒê·∫£m b·∫£o kh√¥i ph·ª•c n·∫øu c√≥ l·ªói
                } finally {
                    // --- Kh√¥i ph·ª•c n√∫t ---
                    exportButton.textContent = originalButtonText;
                    exportButton.disabled = false;
                }
            }, 150);
        }

        function exportToExcel() {
            if (currentData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file Excel.");
                return;
            }

            const loading = showLoading("ƒêang t·∫°o file Excel...");

            setTimeout(() => {
                try {
                    // L·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã
                    const visibleData = [];
                    const tableRows = document.getElementById('tableBody').getElementsByTagName('tr');
                    for (const row of tableRows) {
                        if (row.style.display !== 'none') {
                            const userId = row.cells[2].innerText;
                            const dataItem = currentData.find(item => item.userId === userId);
                            if (dataItem) visibleData.push(dataItem);
                        }
                    }

                    if (visibleData.length === 0) {
                        alert("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t.");
                        throw new Error("No visible data");
                    }

                    const dataToExport = [];
                    const headers = [
                        "Lo·∫°i D·ªØ Li·ªáu", "T√™n", "User ID", "Rank", "Might", "Kills",
                        "K·∫ª Th√π B·ªã B·∫Øt", "K·∫ª Th√π Ti√™u Di·ªát", "Qu√¢n ƒê·ªãch B·ªã Th∆∞∆°ng",
                        "Qu√¢n ƒê·ªôi ƒê√£ Gi·∫øt", "S·ªë Qu√¢n T·ªïn Th·∫•t", "Qu√¢n ƒê·ªôi B·ªã Th∆∞∆°ng",
                        "Thua", "T·∫•n c√¥ng Th√†nh c√¥ng", "Ph√≤ng th·ªß Th√†nh c√¥ng",
                        "Chi·∫øn Th·∫Øng", "T·ªâ L·ªá Chi·∫øn Th·∫Øng"
                    ];

                    // Ti√™u ƒë·ªÅ ch√≠nh
                    dataToExport.push([`B√°o c√°o so s√°nh th·ªëng k√™ - Ng√†y xu·∫•t: ${new Date().toLocaleString('vi-VN')}`]);
                    dataToExport.push([]);
                    dataToExport.push(headers.map(h => ({ v: h, t: 's', s: { font: { bold: true }, alignment: { horizontal: 'center' } } })));

                    // --- C√°c h√†m ti·ªán √≠ch ƒë·ªÉ t·∫°o √¥ trong Excel ---
                    const createCell = (value, type = 's', format = null, style = {}) => {
                        const cell = { v: value, t: type, s: style };
                        if (format) cell.z = format;
                        return cell;
                    };

                    const createNumericCell = (value) => {
                        if (value === undefined || value === null || value === "Kh√¥ng c√≥ d·ªØ li·ªáu") {
                            return createCell("Kh√¥ng c√≥ d·ªØ li·ªáu");
                        }
                        return createCell(value, 'n', '#,##0');
                    };

                    const createDiffCell = (diff) => {
                        if (diff === null || diff === undefined) return createCell("N/A");
                        const style = { font: {} };
                        if (diff > 0) style.font.color = { rgb: "FF008000" }; // Green
                        if (diff < 0) style.font.color = { rgb: "FFFF0000" }; // Red
                        return createCell(diff, 'n', '+#,##0;-#,##0;0', style);
                    };

                    const createWinRateDiffCell = (newRate, oldRate) => {
                        if (!newRate || !oldRate) return createCell("N/A");
                        const newNum = parseFloat(newRate.replace(',', '.').replace('%', ''));
                        const oldNum = parseFloat(oldRate.replace(',', '.').replace('%', ''));
                        if (isNaN(newNum) || isNaN(oldNum)) return createCell("N/A");

                        const diff = newNum - oldNum;
                        const style = { font: {} };
                        let text = `${diff.toFixed(2)}%`;
                        if (diff > 0) {
                            style.font.color = { rgb: "FF008000" }; // Green
                            text = `+${text}`;
                        } else if (diff < 0) {
                            style.font.color = { rgb: "FFFF0000" }; // Red
                        }
                        return createCell(text, 's', null, style);
                    };

                    visibleData.forEach(item => {
                        const { userId, name, rank, juneStats, julyStats } = item;
                        const getStat = (stats, key) => (stats ? stats[key] : undefined);

                        const juneRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(juneStats, 'might')), createNumericCell(getStat(juneStats, 'kills')),
                            createNumericCell(getStat(juneStats, 'enemies_captured')), createNumericCell(getStat(juneStats, 'enemies_destroyed')),
                            createNumericCell(getStat(juneStats, 'enemy_wounded')), createNumericCell(getStat(juneStats, 'troops_killed')),
                            createNumericCell(getStat(juneStats, 'troops_lost')), createNumericCell(getStat(juneStats, 'troops_wounded')),
                            createNumericCell(getStat(juneStats, 'losses')), createNumericCell(getStat(juneStats, 'successful_attacks')),
                            createNumericCell(getStat(juneStats, 'successful_defenses')), createNumericCell(getStat(juneStats, 'victories')),
                            createCell(getStat(juneStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(juneRow);

                        const julyRow = [
                            createCell(""), createCell(name), createCell(userId), createCell(rank),
                            createNumericCell(getStat(julyStats, 'might')), createNumericCell(getStat(julyStats, 'kills')),
                            createNumericCell(getStat(julyStats, 'enemies_captured')), createNumericCell(getStat(julyStats, 'enemies_destroyed')),
                            createNumericCell(getStat(julyStats, 'enemy_wounded')), createNumericCell(getStat(julyStats, 'troops_killed')),
                            createNumericCell(getStat(julyStats, 'troops_lost')), createNumericCell(getStat(julyStats, 'troops_wounded')),
                            createNumericCell(getStat(julyStats, 'losses')), createNumericCell(getStat(julyStats, 'successful_attacks')),
                            createNumericCell(getStat(julyStats, 'successful_defenses')), createNumericCell(getStat(julyStats, 'victories')),
                            createCell(getStat(julyStats, 'win_rate') || '0%')
                        ];
                        dataToExport.push(julyRow);

                        const diffRow = [
                            createCell("T·ªïng", 's', null, { font: { bold: true } }), createCell(""), createCell(""), createCell(""),
                            createDiffCell(calculateDifference(getStat(julyStats, 'might'), getStat(juneStats, 'might'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'kills'), getStat(juneStats, 'kills'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_captured'), getStat(juneStats, 'enemies_captured'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemies_destroyed'), getStat(juneStats, 'enemies_destroyed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'enemy_wounded'), getStat(juneStats, 'enemy_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_killed'), getStat(juneStats, 'troops_killed'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_lost'), getStat(juneStats, 'troops_lost'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'troops_wounded'), getStat(juneStats, 'troops_wounded'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'losses'), getStat(juneStats, 'losses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_attacks'), getStat(juneStats, 'successful_attacks'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'successful_defenses'), getStat(juneStats, 'successful_defenses'))),
                            createDiffCell(calculateDifference(getStat(julyStats, 'victories'), getStat(juneStats, 'victories'))),
                            createWinRateDiffCell(getStat(julyStats, 'win_rate'), getStat(juneStats, 'win_rate'))
                        ];
                        dataToExport.push(diffRow);

                        dataToExport.push([]); // D√≤ng tr·ªëng ph√¢n c√°ch
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataToExport);

                    // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt
                    const objectMaxLength = dataToExport.reduce((acc, row) => {
                        row.forEach((cell, i) => {
                            const cellValue = cell && cell.v ? cell.v : '';
                            const cellLength = String(cellValue).length;
                            acc[i] = Math.max(acc[i] || 0, cellLength);
                        });
                        return acc;
                    }, []);
                    ws["!cols"] = objectMaxLength.map(width => ({ wch: Math.min(width + 2, 40) })); // Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "So S√°nh Th·ªëng K√™");
                    XLSX.writeFile(wb, `SoSanhThongKe_${new Date().toISOString().slice(0, 10)}.xlsx`);
                } catch (error) {
                    if (error.message === "No visible data") return; // ƒê√£ c√≥ alert, kh√¥ng c·∫ßn b√°o l·ªói th√™m
                    console.error("L·ªói khi xu·∫•t Excel:", error);
                    alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file Excel. Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.");
                } finally {
                    loading.remove();
                }
            }, 50);
        }

        function showLoading(message) {
            const loading = document.createElement('div');
            loading.style.position = 'fixed';
            loading.style.top = '0';
            loading.style.left = '0';
            loading.style.width = '100%';
            loading.style.height = '100%';
            loading.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loading.style.display = 'flex';
            loading.style.flexDirection = 'column';
            loading.style.justifyContent = 'center';
            loading.style.alignItems = 'center';
            loading.style.zIndex = '9999';
            loading.innerHTML = `
                <div style="color:white;font-size:20px;margin-bottom:10px;">${message}</div>
                <div class="spinner"></div>
            `;
            document.body.appendChild(loading);
            return loading;
        }

        function resetTable() {
            document.getElementById('searchInput').value = '';
            document.getElementById('priorityIds').value = '416381060,765602761,417896120,537487142,360966484';
            priorityIds = ['416381060', '765602761', '417896120', '537487142', '360966484'];
            sortTable('name', 'asc');
        }

        // Kh·ªüi t·∫°o s·ª± ki·ªán
        window.onload = function () {
            document.getElementById('juneFile').addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], 'june');
                }
            });

            document.getElementById('julyFile').addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], 'july');
                }
            });

            document.getElementById('searchInput').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    searchTable();
                }
            });

            document.getElementById('priorityIds').addEventListener('input', function () {
                if (realtimeFilterEnabled) {
                    applyPriorityFilter();
                }
            });

            document.getElementById('realtimeFilter').addEventListener('change', function (e) {
                realtimeFilterEnabled = e.target.checked;
            });

            // Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho priorityIds
            document.getElementById('priorityIds').value = priorityIds.join(',');
        };
    </script>
</body>
</html>
